<!DOCTYPE html>
<html lang="en"> <!-- Default lang, will be updated by JS -->
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-WX8HLE4W5Q"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-WX8HLE4W5Q');
    </script>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- Added for responsiveness -->
    <title>Digital Skills Assessment</title> <!-- Will be updated by JS -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
    <!-- resources.js is NOT loaded here by default anymore. It will be loaded dynamically -->

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; margin: 0; padding: 0; color: #333; }
        .container { max-width: 800px; width: 90%; margin: 20px auto; background: #fff; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); border-radius: 10px; padding: 20px 30px; padding-top: 10px; }
        h1, h2, h3 { font-size: 28px; margin: 20px 0; color: #2c3e50; }
        h4 { font-size: 22px; margin-bottom: 10px; color: #2c3e50; }
        p { margin: 10px 0 20px; font-size: 16px; color: #555; line-height: 1.6; }
        .progress-bar-container { width: 100%; background: #e0e0e0; border-radius: 10px; height: 20px; margin: 20px 0; overflow: hidden; position: relative; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, #0f777b, #4caf50); width: 0; transition: width 0.4s ease; }
        .progress-label { position: absolute; width: 100%; text-align: center; top: 0; font-size: 14px; color: #000; line-height: 20px; }
        .competency-banner { font-weight: bold; background: #0f777b; color: #fff; padding: 15px; border-radius: 5px; margin: 20px 0; font-size: 20px; }
        .question-container { background: #e0f7fa; border: 2px solid #0f777b; border-radius: 10px; padding: 15px; margin: 10px 0; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); min-height: 120px; text-align: center; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .question-container h2 { font-size: 24px; font-weight: bold; color: #333; margin: 0; line-height: 1.5; }
        .example { font-style: italic; color: #555; font-size: 16px; margin-top: 15px; }

        /* Proficiency Buttons - Default (Larger Screens) */
        .proficiency-buttons {
            margin: 20px 0;
            display: flex;
            justify-content: space-between;
            /* flex-wrap: nowrap; /* Removed for easier override */
        }
        .proficiency-button {
            background: #e0e0e0;
            border: none;
            padding: 12px 10px;
            margin: 0 5px; /* Horizontal margin for side-by-side buttons */
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.3s ease, transform 0.1s ease;
            flex: 1; /* Distribute space equally when in a row */
            text-align: center;
            white-space: nowrap; /* Prevent text inside button from wrapping by default */
        }
        .proficiency-button:hover { background: #d5d5d5; }
        .proficiency-button.selected { background: #4caf50; color: white; transform: scale(1.05); }

        .no-selection-warning { color: red; font-size: 14px; margin-top: 10px; display: none; }
        .button { padding: 12px 25px; margin: 10px 0; /* Adjusted margin for multiple buttons */ background: #0f777b; color: #fff; border: none; border-radius: 5px; cursor: pointer; font-size: 18px; transition: background 0.3s ease; }
        .button:hover { background: #0a5e60; }
        .button:disabled { background: #ccc; cursor: not-allowed; }
        .hidden { display: none !important; } /* Added !important to ensure override */
        .summary-header { background: #e0f7fa; border: 1px solid #0f777b; border-radius: 10px; padding: 20px; margin-bottom: 30px; text-align: center; }
        .summary-header p { font-size: 18px; color: #2c3e50; margin: 10px 0; }
        .summary-header p span { font-weight: bold; }
        .key-characteristics { text-align: left; margin: 10px 0; padding: 10px; background: #f9f9f9; border-left: 4px solid #4caf50; border-radius: 5px; }
        .key-characteristics ul { list-style: none; padding-left: 0; }
        .key-characteristics li { margin-bottom: 10px; font-size: 16px; position: relative; padding-left: 25px; }
        .key-characteristics li::before { content: "✔"; position: absolute; left: 0; color: #4caf50; font-size: 18px; }
        .personalised-feedback { font-size: 16px; font-style: italic; color: #555; background: #fff; padding: 15px 20px; border-left: 4px solid #ff9800; margin: 20px 0; border-radius: 5px; text-align: left; }
        #competencyRadarChart { max-width: 100%; height: auto; }
        .chart-container { margin: 30px 0; }
        .card { background: #fff; border: 1px solid #e0e0e0; border-radius: 10px; padding: 20px; margin: 20px 0; text-align: left; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
        .card h4 { margin: 0 0 15px; color: #2c3e50; }
        .strengths .card { border-left: 4px solid #4caf50; }
        .growth-areas .card { border-left: 4px solid #f44336; }
        .smart-objectives .card { border-left: 4px solid #ff9800; }
        .section-title { font-size: 24px; margin-top: 40px; color: #2c3e50; text-align: left; padding-bottom: 10px; }
        .icon { font-size: 24px; vertical-align: middle; margin-right: 10px; }
        .thank-you { background: #e0f7fa; border: 1px solid #0f777b; border-radius: 10px; padding: 20px; margin: 30px 0; font-size: 18px; color: #2c3e50; text-align: center; }
        .thank-you p { font-size: 18px; font-weight: bold; }
        .thank-you a { color: #ffffff; background-color: #0f777b; padding: 10px 20px; border-radius: 5px; text-decoration: none; font-size: 16px; }
        .thank-you a:hover { background-color: #0a5e60; }
        .strengths { background: #e8f5e9; border: 2px solid #4caf50; border-radius: 10px; padding: 20px; margin: 30px 0; }
        .growth-areas { background: #ffebee; border: 2px solid #f44336; border-radius: 10px; padding: 20px; margin: 30px 0; }
        .smart-objectives { background: #fff3e0; border: 2px solid #ff9800; border-radius: 10px; padding: 20px; margin: 30px 0; }
        .strengths .section-title, .growth-areas .section-title, .smart-objectives .section-title { background: rgba(0,0,0,0.05); padding: 10px 15px; border-radius: 5px; margin: -20px -20px 20px -20px; }
        .strengths .card, .growth-areas .card, .smart-objectives .card { background: #fff; border-radius: 8px; padding: 15px; margin: 15px 0; }
        .dropdown .button { background: #0f777b; color: #fff; border: none; padding: 10px 15px; border-radius: 5px; font-size: 16px; cursor: pointer; margin-top: 10px; transition: background 0.3s ease; }
        .dropdown .button:hover { background: #0a5e60; }
        .dropdown-content { /* display: none; /* Default to hidden, controlled by JS or class */ padding: 15px; margin-top: 10px; background: #f9f9f9; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; color: #333; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        #question-text-container { font-size: 18px; font-weight: bold; color: #2c3e50; line-height: 1.6; margin-bottom: 10px; text-align: center; }
        #example-text-container { font-size: 16px; font-style: italic; color: #555; line-height: 1.4; margin-top: 5px; margin-bottom: 0; text-align: center; }
        .chart-description { font-size: 16px; color: #555; margin-bottom: 20px; line-height: 1.5; text-align: center; }
        .qr-url-container { text-align: center; margin-top: 10px; } /* Container for URL and its copy button */
        .qr-url { font-size: 12px; color: #aaa; margin-top: 0; margin-bottom: 5px; /* Adjusted margins */ word-wrap: break-word; }
        #language-selector-container { padding: 10px; text-align: right; background-color: #f8f9fa; border-bottom: 1px solid #e0e0e0; margin-bottom:15px; }

        /* --- Styles for Smaller Screens (Mobiles) --- */
        @media (max-width: 600px) {
            .container { padding: 15px 20px; }

            /* Stack Proficiency Buttons Vertically */
            .proficiency-buttons {
                flex-direction: column; /* Stack them vertically */
                align-items: stretch;   /* Make buttons take full width of container */
            }
            .proficiency-button {
                flex-basis: auto;       /* Reset flex-basis for stacked items */
                margin: 8px 0;          /* Adjust margin for vertical stacking, increased spacing */
                white-space: normal;    /* Allow text inside button to wrap */
                padding: 15px 10px;     /* Slightly increase padding for better touch targets */
                font-size: 15px;        /* Slightly larger font for readability */
            }

            /* Larger Question and Example Text */
            #question-text-container {
                font-size: 20px; /* Increased from 18px */
            }
            #example-text-container {
                font-size: 17px; /* Increased from 16px */
            }
             h1, h2, h3 { font-size: 24px; } /* Slightly reduce heading sizes on mobile */
             h4 { font-size: 20px; }
             p { font-size: 15px; }
             .button { font-size: 16px; padding: 10px 20px;}
             .competency-banner { font-size: 18px; }
        }
    </style>
</head>
<body>

<div id="language-selector-container">
    <label for="language-selector" id="language-selector-label" style="margin-right: 5px;">Language:</label>
    <select id="language-selector">
        <option value="en">English</option>
        <option value="es">Español</option>
        <option value="fr">Français</option>
        <option value="cs">Čeština</option>
        <option value="nl">Nederlands</option>
        <option value="de">Deutsch</option>
        <option value="hu">Magyar</option>
        <option value="it">Italiano</option>
        <option value="lv">Latviešu</option>
        <option value="lt">Lietuvių</option>
        <option value="ro">Română</option>
        <option value="sk">Slovenčina</option>
        <option value="tr">Türkçe</option>
        <option value="uk">Українська</option>
        <option value="zh-hans">中文 (简体)</option>
        <option value="zh-hant">中文 (繁體)</option>
        <option value="id">Bahasa Indonesia</option>
        <option value="th">ไทย</option>
        <option value="vi">Tiếng Việt</option>
    </select>
</div>

<div class="container" id="start-screen">
    <h1 id="start-screen-title"></h1>
    <p id="start-screen-p1"></p>
    <p id="start-screen-p2"></p>
    <p id="start-screen-p3"></p>
    <p id="start-screen-p4"></p>
    <div style="text-align: center;">
        <button class="button" id="start-button" type="button"></button>
    </div>
</div>

<div class="container hidden" id="assessment-screen">
    <div class="competency-banner" id="competency-banner"></div>
    <div class="progress-bar-container">
        <div class="progress-bar" id="progress-bar"></div>
        <div class="progress-label" id="progress-label">0%</div>
    </div>
    <div class="question-container">
        <h2 id="question-text-container"></h2>
        <p class="example" id="example-text-container"></p>
    </div>
    <div class="proficiency-buttons"></div>
    <div class="no-selection-warning" id="no-selection-warning"></div>
    <div class="dropdown">
        <button class="button" id="toggle-proficiency-button" onclick="toggleDropdown(event)"></button>
        <div class="dropdown-content hidden" id="proficiency-dropdown-content"> <!-- Changed: Default to hidden by adding 'hidden' class -->
        </div>
    </div>
</div>

<div class="container hidden" id="end-screen">
    <h2 id="end-screen-title"></h2>
    <div id="advanced-results">
        <div class="summary-header">
            <p style="font-size: 28px; font-weight: bold; color: #4caf50; margin: 10px 0;">
                <span id="total-score-advanced"></span>
            </p>
            <p style="font-size: 14px; color: #555; margin: 5px 0;">
                <span id="current-date-advanced"></span>
            </p>
            <div id="qr-code-container" style="text-align: center; margin-top: 20px;">
                <h3 id="qr-code-title"></h3>
                <canvas id="qr-code"></canvas>
                <p id="qr-code-instruction"></p>
            </div>
        </div>
        <div class="key-characteristics">
            <h3 id="key-char-title"></h3>
            <p id="key-char-intro"></p>
            <ul id="key-characteristics-advanced"></ul>
        </div>
        <div class="personalised-feedback" id="personalised-feedback-advanced"></div>
        <div class="chart-container">
            <h3 id="radar-chart-title"></h3>
            <p class="chart-description" id="radar-chart-desc"></p>
            <canvas id="competencyRadarChart"></canvas>
            <p id="radar-chart-legend"></p>
        </div>
        <div class="strengths">
            <h3 class="section-title" id="strengths-title"></h3>
            <p id="strengths-intro"></p>
            <div id="strengths"></div>
        </div>
        <div class="growth-areas">
            <h3 class="section-title" id="growth-areas-title"></h3>
            <p id="growth-areas-intro"></p>
            <div id="growth-areas"></div>
        </div>
        <div class="smart-objectives">
            <h3 class="section-title" id="smart-objectives-title"></h3>
            <p id="smart-objectives-intro"></p>
            <div id="smart-objectives"></div>
        </div>
        <div class="thank-you">
            <span id="thank-you-message"></span>
            <div id="survey-link" style="text-align: center; margin-top: 20px;">
                <p id="survey-prompt"></p>
                <a href="https://forms.office.com/Pages/ResponsePage.aspx?id=-QiCXGC1CUmQO1pcxbHUWnL9uYyvyttIoQ6Huyhcv7tUOUM4QU05UTUxUUhFS0dIOU5SM0pXUVdaQy4u"
                   target="_blank"
                   id="survey-button"
                   style="color: #ffffff; background-color: #0f777b; padding: 10px 20px; border-radius: 5px; text-decoration: none; font-size: 16px;">
                </a>
            </div>
        </div>
    </div>
    <div style="text-align: center;" id="end-screen-actions-container"> <!-- Container for action buttons -->
        <!-- Email and Copy Link buttons will be inserted here by JS before Restart -->
        <button class="button" id="restart-button" type="button"></button>
        <div class="qr-url-container"> <!-- Wrapped p and its potential button -->
            <p id="qr-url" class="qr-url"></p>
        </div>
    </div>
</div>

<script>
    // --- START OF SCRIPT ---

    // --- GLOBAL VARIABLE DECLARATIONS (Must be at the very top) ---
    let i18nData = {};
    let currentLanguage = 'en'; 
    let currentBU = null; 
    let currentVariantIdentifier = 'en'; 

    let questionsData = [];
    let competenciesData = [];
    let overallProficiencyLevelsData = [];
    const answers = { Knowledge: [], Skills: [], Attitudes: [] };
    let currentIndex = 0;
    let radarChart;
    let userProficiencyLevelName = ''; // To store just the proficiency name for summary

    // DOM Element Grabbers (declared here, assigned in assignDOMelements after DOMContentLoaded)
    let startScreen, assessmentScreen, endScreen, progressBar, progressLabel, competencyBanner,
        questionTextContainer, exampleTextContainer, proficiencyButtonsNodeList, noSelectionWarningEl,
        strengthsContainer, growthAreasContainer, smartObjectivesContainer,
        restartButton, startButton, langSelectorElement, proficiencyDropdownContentEl, endScreenActionsContainer;

    // --- FUNCTION DEFINITIONS ---

    function assignDOMelements() {
        startScreen = document.getElementById("start-screen");
        assessmentScreen = document.getElementById("assessment-screen");
        endScreen = document.getElementById("end-screen");
        progressBar = document.getElementById("progress-bar");
        progressLabel = document.getElementById("progress-label");
        competencyBanner = document.getElementById("competency-banner");
        questionTextContainer = document.getElementById("question-text-container");
        exampleTextContainer = document.getElementById("example-text-container");
        noSelectionWarningEl = document.getElementById("no-selection-warning");
        strengthsContainer = document.getElementById("strengths");
        growthAreasContainer = document.getElementById("growth-areas");
        smartObjectivesContainer = document.getElementById("smart-objectives");
        restartButton = document.getElementById("restart-button");
        startButton = document.getElementById("start-button");
        langSelectorElement = document.getElementById('language-selector');
        proficiencyDropdownContentEl = document.getElementById('proficiency-dropdown-content');
        endScreenActionsContainer = document.getElementById('end-screen-actions-container');
    }

    function setText(id, text) { 
        const el = document.getElementById(id); 
        if (el) { el.textContent = text; }
    }

    function setHTML(id, html) { 
        const el = document.getElementById(id); 
        if (el) { el.innerHTML = html; }
    }

    function t(key, replacements = {}) { 
        if (typeof i18nData !== 'object' || i18nData === null) return `MISSING_I18NDATA: ${key}`;
        let textValue = i18nData;
        const parts = key.split('.');
        for (let i = 0; i < parts.length; i++) {
            const part = parts[i];
            if (textValue && typeof textValue === 'object' && Object.prototype.hasOwnProperty.call(textValue, part)) {
                textValue = textValue[part];
            } else { return `MISSING_TRANSLATION: ${key}`; }
        }
        if (typeof textValue !== 'string') {
            // console.warn(`Value for key '${key}' is not a string:`, textValue);
            return `INVALID_TRANSLATION_TYPE: ${key}`;
        }
        let finalText = textValue;
        for (const placeholder in replacements) {
            finalText = finalText.replace(new RegExp(`{${placeholder}}`, 'g'), replacements[placeholder]);
        }
        return finalText;
    }
    
    async function loadVariantFiles(variantId) {
        let textJsonToLoad = `${variantId.toLowerCase()}.json`;
        let resourcesJsToLoad = `resources-${variantId.toLowerCase()}.js`;
        let primaryLangForFallback = variantId.split('-')[0].toLowerCase(); 
        let successLoadingText = false;
        let successLoadingResources = false;

        try {
            let response = await fetch(`${textJsonToLoad}?v=${new Date().getTime()}`);
            if (!response.ok) {
                console.warn(`Failed to load ${textJsonToLoad}, trying primary fallback: ${primaryLangForFallback}.json`);
                if (variantId.toLowerCase() !== primaryLangForFallback && primaryLangForFallback) {
                    textJsonToLoad = `${primaryLangForFallback}.json`;
                    response = await fetch(`${textJsonToLoad}?v=${new Date().getTime()}`);
                }
                if (!response.ok) { 
                    console.warn(`Failed to load ${textJsonToLoad}, trying English fallback (en.json).`);
                    if (textJsonToLoad === 'en.json') { 
                        throw new Error('CRITICAL: Failed to load en.json for text initially and as primary fallback.'); 
                    }
                    textJsonToLoad = 'en.json';
                    response = await fetch(`${textJsonToLoad}?v=${new Date().getTime()}`);
                    if (!response.ok) throw new Error('CRITICAL: Failed to load en.json as ultimate text fallback.');
                }
            }
            i18nData = await response.json();
            currentVariantIdentifier = textJsonToLoad.replace('.json', ''); 
            successLoadingText = true;
        } catch (error) {
            console.error("Fatal error loading text JSON file:", error);
            document.body.innerHTML = `<div style="text-align:center;padding:20px;"><h1>Error</h1><p>Could not load language text resources. Please check console for details and ensure '${variantId.toLowerCase()}.json', '${primaryLangForFallback}.json', or 'en.json' are available.</p><p><em>${error.message}</em></p></div>`;
            return; 
        }

        const oldResourcesScript = document.getElementById('dynamic-resources-script');
        if (oldResourcesScript) oldResourcesScript.remove();
        window.customResources = []; 

        const loadScript = (src) => {
            return new Promise((resolve, reject) => {
                const scriptToLoad = document.createElement('script'); 
                scriptToLoad.id = 'dynamic-resources-script'; 
                scriptToLoad.src = `${src}?v=${new Date().getTime()}`;
                scriptToLoad.onload = () => { console.log(`Resources loaded from ${src}`); successLoadingResources = true; resolve(); }; 
                scriptToLoad.onerror = () => { console.warn(`Could not load ${src}`); reject(new Error(`Failed to load ${src}`)); };
                document.head.appendChild(scriptToLoad);
            });
        };

        try {
            await loadScript(resourcesJsToLoad);
        } catch (error) {
            let triedPrimaryResource = false;
            if (variantId.toLowerCase() !== primaryLangForFallback && primaryLangForFallback) {
                resourcesJsToLoad = `resources-${primaryLangForFallback}.js`;
                triedPrimaryResource = true;
                try {
                    await loadScript(resourcesJsToLoad);
                } catch (error2) { /* Fall through */ }
            }
            if (!successLoadingResources && (primaryLangForFallback !== 'en' || !triedPrimaryResource ) && variantId.toLowerCase() !== 'en' ) {
                 resourcesJsToLoad = 'resources-en.js';
                 try {
                    await loadScript(resourcesJsToLoad);
                 } catch (error3) { console.error("CRITICAL: Failed to load resources-en.js as final fallback for resources."); }
            } else if (!successLoadingResources && (variantId.toLowerCase() === 'en' || primaryLangForFallback === 'en')) {
                 console.error(`CRITICAL: Failed to load resources-en.js (or primary was en and failed).`);
            }
        }
        if (!successLoadingResources) {
            console.warn("No custom resources loaded. window.customResources will be empty.");
            window.customResources = [];
        }
        
        document.documentElement.lang = i18nData.lang || currentVariantIdentifier.split('-')[0];
        document.title = t('appTitle');
        questionsData = i18nData.questions || [];
        competenciesData = i18nData.competencyList || [];
        overallProficiencyLevelsData = i18nData.overallProficiencyLevels || [];
        
        if (competenciesData && competenciesData.length > 0) {
            const numCompetencies = competenciesData.length;
            answers.Knowledge = Array(numCompetencies).fill(0); 
            answers.Skills = Array(numCompetencies).fill(0);
            answers.Attitudes = Array(numCompetencies).fill(0);
        } else {
            console.error("Competencies data is empty after loading JSON. Assessment functionality will be limited.");
        }

        applyTranslations();
        updateLanguageSelectorValue(currentLanguage); 
        localStorage.setItem('selectedUserLanguage', currentLanguage); 
        if (currentBU) localStorage.setItem('selectedUserBU', currentBU); else localStorage.removeItem('selectedUserBU');
    }
    
    function updateLanguageSelectorValue(langCode) { 
        if (!langSelectorElement) return;
        langSelectorElement.value = langCode; 
        const label = document.getElementById('language-selector-label');
        if (label) {
            const labelText = t('misc.languageLabel');
            label.textContent = labelText.startsWith('MISSING_') ? 'Language:' : labelText;
        }
    }

    function applyTranslations() {
        const langLabel = document.getElementById('language-selector-label');
        if (langLabel) {
            const labelText = t('misc.languageLabel');
            langLabel.textContent = labelText.startsWith('MISSING_') ? 'Language:' : labelText;
        }

        setText('start-screen-title', t('startScreen.title'));
        setHTML('start-screen-p1', t('startScreen.introParagraph1'));
        setHTML('start-screen-p2', t('startScreen.introParagraph2'));
        setHTML('start-screen-p3', t('startScreen.introParagraph3'));
        setHTML('start-screen-p4', t('startScreen.introParagraph4'));
        if (startButton) setText('start-button', t('startScreen.startButtonText'));
        
        if (noSelectionWarningEl) setText('no-selection-warning', t('assessmentScreen.noSelectionWarning'));
        
        const toggleProfButton = document.getElementById('toggle-proficiency-button');
        if (toggleProfButton && proficiencyDropdownContentEl) {
            if (proficiencyDropdownContentEl.classList.contains('hidden')) {
                toggleProfButton.textContent = t('assessmentScreen.showProficiencyLevelsButton');
            } else {
                toggleProfButton.textContent = t('assessmentScreen.hideProficiencyLevelsButton');
            }
        }

        if (proficiencyDropdownContentEl) { 
            proficiencyDropdownContentEl.innerHTML = `<p>${t('assessmentScreen.proficiencyLevelsDropdown.beginner')}</p><p>${t('assessmentScreen.proficiencyLevelsDropdown.developing')}</p><p>${t('assessmentScreen.proficiencyLevelsDropdown.competent')}</p><p>${t('assessmentScreen.proficiencyLevelsDropdown.proficient')}</p><p>${t('assessmentScreen.proficiencyLevelsDropdown.expert')}</p>`;
        }
        populateProficiencyButtons();

        if (assessmentScreen && !assessmentScreen.classList.contains('hidden') && questionsData.length > 0 && currentIndex < questionsData.length) {
            renderQuestion(currentIndex); 
        }

        if (endScreen && !endScreen.classList.contains('hidden')) { 
            setText('end-screen-title', t('endScreen.title'));
            setText('qr-code-title', t('endScreen.qrCodeSectionTitle'));
            setText('qr-code-instruction', t('endScreen.qrCodeInstruction'));
            setText('key-char-title', t('endScreen.keyCharacteristicsTitle'));
            setText('key-char-intro', t('endScreen.keyCharacteristicsIntro'));
            setText('radar-chart-title', t('endScreen.radarChartTitle'));
            setText('radar-chart-desc', t('endScreen.radarChartDescription'));
            setHTML('radar-chart-legend', constructRadarLegend());
            setHTML('strengths-title', t('endScreen.strengthsSectionTitle'));
            setText('strengths-intro', t('endScreen.strengthsSectionIntro'));
            setHTML('growth-areas-title', t('endScreen.growthAreasSectionTitle'));
            setText('growth-areas-intro', t('endScreen.growthAreasSectionIntro'));
            setHTML('smart-objectives-title', t('endScreen.smartObjectivesSectionTitle'));
            setText('smart-objectives-intro', t('endScreen.smartObjectivesSectionIntro'));
            setHTML('thank-you-message', t('endScreen.thankYouMessage'));
            setText('survey-prompt', t('endScreen.surveyPrompt'));
            setText('survey-button', t('endScreen.surveyButtonText'));
            if (restartButton) setText('restart-button', t('endScreen.restartButtonText'));
            // Results specific content is generated by generateResultsPageContent called in showResults
        }
    }

    function constructRadarLegend() { 
        const andConj = t('misc.andConjunction');
        const lowerThanConj = t('misc.areLowerThanConjunction');
        return `${t('endScreen.radarChartLegendIntro')}<span style="color: #ff6384; font-weight: bold;">${t('endScreen.radarChartLegendKnowledge')}</span>, <span style="color: #36a2eb; font-weight: bold;">${t('endScreen.radarChartLegendSkills')}</span>, ${andConj.startsWith('MISSING_') ? 'and' : andConj} <span style="color: #4bc0c0; font-weight: bold;">${t('endScreen.radarChartLegendAttitudes')}</span>${t('endScreen.radarChartLegendExplanation')}<span style="color: #36a2eb; font-weight: bold;">${t('endScreen.radarChartLegendSkillsExample')}</span> ${lowerThanConj.startsWith('MISSING_') ? 'are lower than' : lowerThanConj} <span style="color: #ff6384; font-weight: bold;">${t('endScreen.radarChartLegendKnowledgeExample')}</span>${t('endScreen.radarChartLegendExplanationSuffix')}`;
    }
    function populateProficiencyButtons() { 
        const container = document.querySelector('#assessment-screen .proficiency-buttons');
        if (!container) return;
        container.innerHTML = '';
        for (let i = 1; i <= 5; i++) {
            const button = document.createElement('button');
            button.classList.add('proficiency-button');
            button.setAttribute('data-value', i);
            button.type = 'button';
            button.textContent = t(`proficiencyLabels.${i}`); 
            container.appendChild(button);
        }
        proficiencyButtonsNodeList = document.querySelectorAll("#assessment-screen .proficiency-button"); 
    }
    function getCompetencyNameByKey(key) { 
        if (!competenciesData) return `NO_COMP_DATA_FOR_KEY: ${key}`;
        const competency = competenciesData.find(c => c.key === key);
        return competency ? competency.name : `MISSING_COMP_NAME: ${key}`;
    }
    function renderQuestion(index) { 
        if (!questionsData || questionsData.length === 0 || index >= questionsData.length) {return;}
        const question = questionsData[index];
        const competencyName = getCompetencyNameByKey(question.competencyKey);
        const examplePrefixText = t('misc.examplePrefix');
        if (competencyBanner) competencyBanner.textContent = `${t('assessmentScreen.competencyBannerPrefix')}${competencyName}`;
        if (questionTextContainer) questionTextContainer.textContent = t(`questionTexts.${question.questionKey}`);
        if (exampleTextContainer) exampleTextContainer.textContent = `${examplePrefixText.startsWith("MISSING_") ? "Example: " : examplePrefixText}${t(`questionTexts.${question.exampleKey}`)}`;
        proficiencyButtonsNodeList = document.querySelectorAll("#assessment-screen .proficiency-button");
        if (proficiencyButtonsNodeList) proficiencyButtonsNodeList.forEach(button => button.classList.remove("selected"));
        if(noSelectionWarningEl) noSelectionWarningEl.classList.add('hidden');
        attachEventListeners();
    }
    function attachEventListeners() { 
        proficiencyButtonsNodeList = document.querySelectorAll("#assessment-screen .proficiency-button"); 
        if (!proficiencyButtonsNodeList || proficiencyButtonsNodeList.length === 0) { return; }
        proficiencyButtonsNodeList.forEach(button => {
            const newButton = button.cloneNode(true); 
            if (button.parentNode) button.parentNode.replaceChild(newButton, button);
        });
        proficiencyButtonsNodeList = document.querySelectorAll("#assessment-screen .proficiency-button"); 
        proficiencyButtonsNodeList.forEach(button => {
            button.onclick = () => {
                if(noSelectionWarningEl) noSelectionWarningEl.classList.add('hidden');
                proficiencyButtonsNodeList.forEach(btn => btn.classList.remove("selected"));
                button.classList.add("selected");
                const selectedValue = parseInt(button.getAttribute("data-value"));
                const currentQuestion = questionsData[currentIndex];
                const competencyIndex = competenciesData.findIndex(c => c.key === currentQuestion.competencyKey);
                if (competencyIndex === -1) { console.error("Competency index not found for key:", currentQuestion.competencyKey); return; }
                if (answers[currentQuestion.type] && competencyIndex < answers[currentQuestion.type].length) {
                     answers[currentQuestion.type][competencyIndex] = selectedValue;
                } else { console.error(`Answer type ${currentQuestion.type} or index ${competencyIndex} out of bounds.`); }

                const completedQuestions = currentIndex + 1;
                const progressPercentage = Math.round((completedQuestions / questionsData.length) * 100);
                if (progressBar) progressBar.style.width = `${progressPercentage}%`;
                if (progressLabel) progressLabel.textContent = `${progressPercentage}${t('assessmentScreen.progressLabelSuffix')}`;
                
                if (currentIndex < questionsData.length - 1) {
                    currentIndex++;
                    renderQuestion(currentIndex);
                } else { showResults(); }
            };
        });
    }
    
    function generateResultsTextSummary(resultsUrl) {
        const overallScoreText = document.getElementById('total-score-advanced')?.textContent || 'N/A';
        const dateText = document.getElementById('current-date-advanced')?.textContent || 'N/A';

        let strengthsText = `${t('endScreen.strengthsSectionTitle').replace(/<[^>]*>?/gm, '')}:\n`; // Strip HTML from title
        const strengthItems = document.querySelectorAll('#strengths .strength-item.card'); // More specific selector
        strengthItems.forEach(item => {
            const title = item.querySelector('h4')?.textContent || '';
            // Find the dimension text which is not bold. The strong tag contains the label.
            const dimensionP = Array.from(item.querySelectorAll('p')).find(p => p.querySelector('strong')?.textContent === t('endScreen.strongestDimensionLabel'));
            const dimension = dimensionP ? dimensionP.innerHTML.replace(/<strong>.*?<\/strong>\s*/, '').trim() : '';
            strengthsText += `- ${title} (${dimension})\n`;
        });

        let growthAreasText = `\n${t('endScreen.growthAreasSectionTitle').replace(/<[^>]*>?/gm, '')}:\n`; // Strip HTML
        const growthItems = document.querySelectorAll('#growth-areas .growth-item.card'); // More specific
        growthItems.forEach(item => {
            const title = item.querySelector('h4')?.textContent || '';
            const dimensionP = Array.from(item.querySelectorAll('p')).find(p => p.querySelector('strong')?.textContent === t('endScreen.growthAreaLabel'));
            const dimension = dimensionP ? dimensionP.innerHTML.replace(/<strong>.*?<\/strong>\s*/, '').trim() : '';
            growthAreasText += `- ${title} (${dimension})\n`;
        });

        return `${t('appTitle')} ${t('endScreen.title')} (${dateText})\n` + // "Digital Skills Assessment Results"
               `------------------------------------------\n` +
               `Overall Score: ${overallScoreText}\n` +
               (userProficiencyLevelName ? `Proficiency Level: ${userProficiencyLevelName}\n` : '') +
               `${strengthsText}` +
               `${growthAreasText}\n` +
               `View full results online: ${resultsUrl}\n\n` +
               `--- Raw Scores ---\n` +
               `Knowledge: ${answers.Knowledge.join(',')}\n`+
               `Skills: ${answers.Skills.join(',')}\n`+
               `Attitudes: ${answers.Attitudes.join(',')}\n`;
    }

    function addEmailResultsFeature(resultsUrl) {
        if (!endScreenActionsContainer || !restartButton) {
            console.error("Cannot add email button: endScreenActionsContainer or restartButton not found.");
            return;
        }
        let emailButton = document.getElementById('email-results-button');
        if (!emailButton) {
            emailButton = document.createElement('button');
            emailButton.id = 'email-results-button';
            emailButton.classList.add('button');
            emailButton.style.display = 'block';
            emailButton.style.marginLeft = 'auto';
            emailButton.style.marginRight = 'auto';
            emailButton.style.marginBottom = '10px';
            endScreenActionsContainer.insertBefore(emailButton, restartButton);
        }
        emailButton.textContent = t('endScreen.emailResultsButtonText'); // e.g., "Email My Results to [Your Team]"

        const newEmailButton = emailButton.cloneNode(true);
        emailButton.parentNode.replaceChild(newEmailButton, emailButton);
        emailButton = newEmailButton;

        emailButton.onclick = () => {
            const subject = encodeURIComponent(t('endScreen.emailSubject'));
            const emailBodyIntroText = t('endScreen.emailBodyIntro');
            const emailBodyPleaseSendText = t('endScreen.emailBodyPleaseSend');
            const summaryForEmail = generateResultsTextSummary(resultsUrl); // Generate summary

            // For mailto, it's better to keep the body short.
            // We'll include the link and a brief instruction.
            // The full summary is copied to clipboard as a fallback.
            const mailtoBody = `${emailBodyIntroText}\n${resultsUrl}\n\n${emailBodyPleaseSendText}`;
            const encodedMailtoBody = encodeURIComponent(mailtoBody);

            navigator.clipboard.writeText(summaryForEmail) // Copy the FULL summary
                .then(() => {
                    alert(t('endScreen.resultsLinkCopiedForEmailMessage')); // "Your email client should open..."
                    window.location.href = `mailto:?subject=${subject}&body=${encodedMailtoBody}`;
                })
                .catch(err => {
                    console.error('Failed to copy full results summary to clipboard: ', err);
                    alert(t('endScreen.resultsLinkCopiedForEmailMessage')); // Still give this message
                    window.location.href = `mailto:?subject=${subject}&body=${encodedMailtoBody}`;
                });
        };
    }

    function addCopyResultsLinkButton(urlToCopy) {
        const qrUrlContainer = document.querySelector('.qr-url-container');
        if (!qrUrlContainer) {
             console.error("Cannot add copy link button: .qr-url-container not found.");
            return;
        }
        let copyButton = document.getElementById('copy-direct-link-button');
        if (!copyButton) {
            copyButton = document.createElement('button');
            copyButton.id = 'copy-direct-link-button';
            copyButton.classList.add('button');
            copyButton.style.marginTop = '0px'; // Align with paragraph
            copyButton.style.marginLeft = '10px'; // Space from URL text
            copyButton.style.fontSize = '12px';
            copyButton.style.padding = '5px 10px';
            copyButton.style.backgroundColor = '#6c757d'; // Subdued color
            copyButton.style.verticalAlign = 'middle'; // Align with paragraph text
            
            // Insert after the paragraph displaying the URL
            const qrUrlP = document.getElementById('qr-url');
            if (qrUrlP) qrUrlP.parentNode.insertBefore(copyButton, qrUrlP.nextSibling);
            else qrUrlContainer.appendChild(copyButton); // Fallback if p isn't there
        }
        copyButton.textContent = t('endScreen.copyLinkButtonText');

        const newCopyButton = copyButton.cloneNode(true);
        copyButton.parentNode.replaceChild(newCopyButton, copyButton);
        copyButton = newCopyButton;

        copyButton.onclick = () => {
            navigator.clipboard.writeText(urlToCopy)
                .then(() => {
                    alert(t('endScreen.resultsLinkCopiedMessage'));
                })
                .catch(err => {
                    console.error('Failed to copy results link: ', err);
                    alert(t('endScreen.copyLinkFailedMessage'));
                });
        };
    }

    function showResults() { 
        if(progressBar) progressBar.style.width = "100%";
        if(progressLabel) progressLabel.textContent = `100${t('assessmentScreen.progressLabelSuffix')}`;
        if(assessmentScreen) assessmentScreen.classList.add("hidden");
        if(startScreen) startScreen.classList.add("hidden");
        if(endScreen) endScreen.classList.remove("hidden");
        const today = new Date();
        const formattedCurrentDate = `${String(today.getDate()).padStart(2, '0')}/${String(today.getMonth() + 1).padStart(2, '0')}/${today.getFullYear()}`;
        setText('current-date-advanced', formattedCurrentDate);
        
        const totalScore = (answers.Knowledge.reduce((a,b)=>a+b,0)||0) + (answers.Skills.reduce((a,b)=>a+b,0)||0) + (answers.Attitudes.reduce((a,b)=>a+b,0)||0);
        const maxScore = (competenciesData.length || 0) * 3 * 5;
        const percentageScore = maxScore > 0 ? Math.round((totalScore / maxScore) * 100) : 0;
        let userProficiencyLevelText = "", userKeyCharacteristics = [], userFeedback = "";
        userProficiencyLevelName = 'N/A'; // Reset for global var

        for (let level of overallProficiencyLevelsData) {
            if (percentageScore >= level.range[0] && percentageScore <= level.range[1]) {
                userProficiencyLevelName = t(`proficiencyTexts.${level.nameKey}`); // Store just the name
                userProficiencyLevelText = `${userProficiencyLevelName} (${level.range[0]}% - ${level.range[1]}%)`;
                userKeyCharacteristics = level.characteristicsKeys.map(key => t(`proficiencyTexts.${key}`));
                userFeedback = t(`proficiencyTexts.${level.feedbackKey}`);
                break;
            }
        }
        setText('total-score-advanced', `${percentageScore}% (${userProficiencyLevelName})`);
        displayKeyCharacteristics(userKeyCharacteristics);
        setText('personalised-feedback-advanced', userFeedback);
        
        applyTranslations(); // Apply general translations first
        generateResultsPageContent(); // Then generate dynamic content like strengths etc.

        const encodedData = encodeResponses();
        if (document.getElementById('qr-code')) generateQRCode(encodedData, 'qr-code');
        updateQRCodeURL(encodedData); // This will also call functions to add share buttons
    }

    function encodeResponses() { 
        const numCompetencies = competenciesData.length || 0;
        return `${(answers.Knowledge||[]).slice(0,numCompetencies).join('')}-${(answers.Skills||[]).slice(0,numCompetencies).join('')}-${(answers.Attitudes||[]).slice(0,numCompetencies).join('')}`;
    }
    function decodeAndLoadResults() { 
        const data = new URLSearchParams(window.location.search).get('data');
        if (data) {
            const parts = data.split('-');
            if (parts.length === 3 && competenciesData && competenciesData.length > 0) {
                const [knowledgeStr, skillsStr, attitudesStr] = parts;
                const numCompetencies = competenciesData.length;
                answers.Knowledge = knowledgeStr.split('').map(Number).slice(0, numCompetencies);
                answers.Skills = skillsStr.split('').map(Number).slice(0, numCompetencies);
                answers.Attitudes = attitudesStr.split('').map(Number).slice(0, numCompetencies);
                while (answers.Knowledge.length < numCompetencies) answers.Knowledge.push(0);
                while (answers.Skills.length < numCompetencies) answers.Skills.push(0);
                while (answers.Attitudes.length < numCompetencies) answers.Attitudes.push(0);
                showResults();
            } else if (!competenciesData || competenciesData.length === 0) {
                 console.warn("URL Data: competenciesData not ready. Will not attempt to show results from URL.");
            } else { console.warn("URL Data: malformed."); }
        }
    }
    function displayKeyCharacteristics(characteristics) { 
        const listEl = document.getElementById('key-characteristics-advanced');
        if(!listEl) return;
        listEl.innerHTML = '';
        characteristics.forEach(characteristic => {
            const li = document.createElement('li');
            li.textContent = characteristic;
            listEl.appendChild(li);
        });
    }
    function generateResultsPageContent() { 
        if (!competenciesData || competenciesData.length === 0) { return; }
        const competencyScores = competenciesData.map((comp, i) => ({
            key: comp.key, name: comp.name, 
            knowledgeScore: answers.Knowledge[i]||0, skillsScore: answers.Skills[i]||0, attitudesScore: answers.Attitudes[i]||0,
            total: (answers.Knowledge[i]||0) + (answers.Skills[i]||0) + (answers.Attitudes[i]||0)
        }));
        const sortedDesc = [...competencyScores].sort((a, b) => b.total - a.total);
        const sortedAsc = [...competencyScores].sort((a, b) => a.total - b.total);
        generateStrengths(sortedDesc.slice(0, 3)); 
        generateGrowthAreas(sortedAsc.slice(0, 3));
        generateRadarChart();
        generateSmartObjectives(sortedAsc.slice(0, 3));
    }
    function getStrongestDimension(comp) { return ["Knowledge","Skills","Attitudes"].sort((a,b)=>(comp[`${b.toLowerCase()}Score`])-(comp[`${a.toLowerCase()}Score`]))[0]; }
    function getWeakestDimension(comp) { return ["Knowledge","Skills","Attitudes"].sort((a,b)=>(comp[`${a.toLowerCase()}Score`])-(comp[`${b.toLowerCase()}Score`]))[0]; }
    function getFeedbackForCompetency(competencyKey, dimension) { return t(`feedbackStrengths.${competencyKey}.${dimension}`); }
    function getGrowthFeedbackForCompetency(competencyKey, dimension) { return t(`feedbackGrowth.${competencyKey}.${dimension}`); }
    function getSmartObjective(competencyKey, dimension) { return t(`smartObjectives.${competencyKey}.${dimension}`); }

    function generateStrengths(topCompetencies) { 
        if (!strengthsContainer) { console.error("strengthsContainer is null"); return; }
        strengthsContainer.innerHTML = '';
        topCompetencies.forEach(comp => {
            const strongestDimension = getStrongestDimension(comp);
            const competencyName = comp.name; 
            const strengthLabel = t('endScreen.strongestDimensionLabel');
            const translatedDimensionName = t(`endScreen.radarChartLegend${strongestDimension}`);
            const feedbackText = getFeedbackForCompetency(comp.key, strongestDimension);
            strengthsContainer.innerHTML += `<div class="strength-item card"><h4>${competencyName}</h4><p><strong>${strengthLabel}</strong> ${translatedDimensionName}</p><p>${feedbackText}</p></div>`;
        });
    }
    function generateGrowthAreas(bottomCompetencies) { 
        if (!growthAreasContainer) { console.error("growthAreasContainer is null"); return; }
        growthAreasContainer.innerHTML = '';
        bottomCompetencies.forEach(comp => {
            const weakestDimension = getWeakestDimension(comp);
            const competencyName = comp.name;
            const growthLabel = t('endScreen.growthAreaLabel');
            const translatedDimensionName = t(`endScreen.radarChartLegend${weakestDimension}`);
            const feedbackText = getGrowthFeedbackForCompetency(comp.key, weakestDimension);
            growthAreasContainer.innerHTML += `<div class="growth-item card"><h4>${competencyName}</h4><p><strong>${growthLabel}</strong> ${translatedDimensionName}</p><p>${feedbackText}</p></div>`;
        });
    }
    function generateSmartObjectives(bottomCompetencies) { 
        if (!smartObjectivesContainer) { console.error("smartObjectivesContainer is null"); return; }
        smartObjectivesContainer.innerHTML = '';
        bottomCompetencies.forEach(comp => {
            const weakestDimension = getWeakestDimension(comp);
            const competencyNameDisplay = comp.name; 
            const competencyKeyForResourceLookup = comp.key; 
            
            const growthLabel = t('endScreen.growthAreaLabel');
            const smartObjectiveLabel = t('endScreen.smartObjectiveLabel');
            const translatedDimensionNameForSMART = t(`endScreen.radarChartLegend${weakestDimension}`);
            const smartObjectiveText = getSmartObjective(comp.key, weakestDimension);
            const userLevel = comp[`${weakestDimension.toLowerCase()}Score`];
            let levelsToShow = userLevel ? (userLevel === 1 ? [1,2,3] : (userLevel === 5 ? [3,4,5] : [userLevel-1, userLevel, userLevel+1].filter(l=>l>=1 && l<=5))) : [1,2,3];
            
            const filteredResources = (window.customResources || []).filter(r => {
                return r.competencyKey === competencyKeyForResourceLookup && r.level === weakestDimension.toLowerCase();
            });

            const chosenResources = filteredResources.filter(r => levelsToShow.includes(r.rating)).slice(0, 3);
            
            let resourcesHTML = '';
            if (chosenResources.length > 0) {
                resourcesHTML = `<h5>${t('endScreen.recommendedResourcesLabel')}</h5><ul style="list-style:none; padding:0; margin:10px 0;">
                        ${chosenResources.map(r => `<li><a href="${r.URL}" target="_blank" style="text-decoration:none; color:#0f777b;"><strong>${r.title}</strong>: ${r.description}</a></li>`).join('')}</ul>`;
            }
            smartObjectivesContainer.innerHTML += `<div class="smart-item card"><h4>${competencyNameDisplay}</h4><p><strong>${growthLabel}</strong> ${translatedDimensionNameForSMART}</p><p><strong>${smartObjectiveLabel}</strong> ${smartObjectiveText}</p>${resourcesHTML}</div>`;
        });
    }
    function generateRadarChart() { 
        if (radarChart) radarChart.destroy();
        if (!competenciesData || competenciesData.length === 0 || !document.getElementById('competencyRadarChart')) return;
        const radarLabels = competenciesData.map(c => c.name); 
        const data = {
            labels: radarLabels,
            datasets: [
                { label: t('endScreen.radarChartLegendKnowledge'), data: answers.Knowledge, fill: true, backgroundColor: 'rgba(255,99,132,0.2)', borderColor: 'rgb(255,99,132)', pointBackgroundColor: 'rgb(255,99,132)', borderWidth: 1 },
                { label: t('endScreen.radarChartLegendSkills'), data: answers.Skills, fill: true, backgroundColor: 'rgba(54,162,235,0.2)', borderColor: 'rgb(54,162,235)', pointBackgroundColor: 'rgb(54,162,235)', borderWidth: 1 },
                { label: t('endScreen.radarChartLegendAttitudes'), data: answers.Attitudes, fill: true, backgroundColor: 'rgba(75,192,192,0.2)', borderColor: 'rgb(75,192,192)', pointBackgroundColor: 'rgb(75,192,192)', borderWidth: 1 }
            ]
        };
        const radarCtx = document.getElementById('competencyRadarChart').getContext('2d');
        radarChart = new Chart(radarCtx, {
            type: 'radar', data: data,
            options: { responsive: true, maintainAspectRatio: true, elements: { line: { tension: 0.1 } }, scales: { r: { angleLines: { display: false }, suggestedMin: 0, suggestedMax: 5, ticks: { stepSize: 1, beginAtZero: true, backdropColor: 'transparent' } } } }
        });
    }

    function updateQRCodeURL(data) { 
        const resultsURL = `${window.location.origin}${window.location.pathname}?data=${data}`;
        setText('qr-url', resultsURL);
        // Call the functions to add/update share buttons
        addEmailResultsFeature(resultsURL); 
        addCopyResultsLinkButton(resultsURL); 
    }

    function generateQRCode(data, canvasId) { 
        const qrCodeCanvas = document.getElementById(canvasId);
        if (!qrCodeCanvas) { console.error(`Canvas ${canvasId} not found.`); return; }
        const resultsURL = `${window.location.origin}${window.location.pathname}?data=${data}`;
        QRCode.toCanvas(qrCodeCanvas, resultsURL, { width: 200, margin: 2 }, err => {
            if (err) console.error(`Error QR code for ${canvasId}:`, err);
        });
    }
    function toggleDropdown(event) { 
        const button = event.target;
        if (proficiencyDropdownContentEl) {
            const isCurrentlyHidden = proficiencyDropdownContentEl.classList.contains('hidden');
            if (isCurrentlyHidden) {
                proficiencyDropdownContentEl.classList.remove('hidden');
                button.textContent = t('assessmentScreen.hideProficiencyLevelsButton');
            } else {
                proficiencyDropdownContentEl.classList.add('hidden');
                button.textContent = t('assessmentScreen.showProficiencyLevelsButton');
            }
        }
    }
    
    function addEventListenersToDOM() { 
        if (restartButton) {
            restartButton.addEventListener("click", () => {
                currentIndex = 0;
                if (competenciesData && competenciesData.length > 0) {
                    const numCompetencies = competenciesData.length;
                    answers.Knowledge = Array(numCompetencies).fill(0);
                    answers.Skills = Array(numCompetencies).fill(0);
                    answers.Attitudes = Array(numCompetencies).fill(0);
                }
                if(endScreen) endScreen.classList.add("hidden");
                if(assessmentScreen) assessmentScreen.classList.add("hidden");
                if(startScreen) startScreen.classList.remove("hidden");
                if (radarChart) { radarChart.destroy(); radarChart = null; }
                const qrCodeCanvas = document.getElementById('qr-code');
                if (qrCodeCanvas && qrCodeCanvas.getContext) qrCodeCanvas.getContext('2d').clearRect(0, 0, qrCodeCanvas.width, qrCodeCanvas.height);
                setText('qr-url', '');
                if(strengthsContainer) strengthsContainer.innerHTML = '';
                if(growthAreasContainer) growthAreasContainer.innerHTML = '';
                if(smartObjectivesContainer) smartObjectivesContainer.innerHTML = '';
                
                // Remove share buttons if they exist, they'll be re-added by showResults if needed
                const emailBtn = document.getElementById('email-results-button');
                if(emailBtn) emailBtn.remove();
                const copyDirectBtn = document.getElementById('copy-direct-link-button');
                if(copyDirectBtn) copyDirectBtn.remove();

                applyTranslations(); 
            });
        }

        if (startButton) {
            startButton.addEventListener("click", () => {
                if(startScreen) startScreen.classList.add("hidden");
                if(assessmentScreen) assessmentScreen.classList.remove("hidden");
                
                if (progressBar) progressBar.style.width = '0%';
                if (progressLabel) progressLabel.textContent = `0${t('assessmentScreen.progressLabelSuffix')}`;

                if (competenciesData && competenciesData.length > 0) {
                    const numCompetencies = competenciesData.length;
                    answers.Knowledge = Array(numCompetencies).fill(0);
                    answers.Skills = Array(numCompetencies).fill(0);
                    answers.Attitudes = Array(numCompetencies).fill(0);
                    currentIndex = 0; 
                    renderQuestion(currentIndex);
                } else {
                    console.error("Cannot start assessment, competencies data not loaded.");
                }
            });
        }

        if (langSelectorElement) {
            langSelectorElement.addEventListener('change', async (event) => {
                const newLang = event.target.value; 
                currentLanguage = newLang; 
                
                let variantToLoad = currentLanguage;
                if (currentBU) {
                    variantToLoad = `${currentLanguage}-${currentBU}`;
                }
                await loadVariantFiles(variantToLoad); 

                if (startScreen && !startScreen.classList.contains('hidden') && 
                    assessmentScreen && assessmentScreen.classList.contains('hidden') && 
                    endScreen && endScreen.classList.contains('hidden')) {
                    applyTranslations();
                } else { 
                    if (restartButton) restartButton.click(); 
                }
            });
        }
    }
    
    async function initializeApp() {
        assignDOMelements(); 
        addEventListenersToDOM(); 

        const urlParams = new URLSearchParams(window.location.search);
        currentBU = urlParams.get('bu'); 
        if(currentBU) currentBU = currentBU.toLowerCase();

        let storedLang = localStorage.getItem('selectedUserLanguage');
        let browserLang = navigator.language || navigator.userLanguage || 'en';
        let initialLang = 'en'; 

        if (storedLang) {
            initialLang = storedLang;
        } else if (browserLang) {
            const primaryBrowserLang = browserLang.toLowerCase().split('-')[0];
            const regionCode = browserLang.toLowerCase().split('-')[1]; // e.g., 'cn', 'sg', 'tw', 'hk'
            
            let langOptionExists = false;
            if (langSelectorElement && langSelectorElement.options) {
                 langOptionExists = Array.from(langSelectorElement.options).some(opt => opt.value === primaryBrowserLang);
            }

            if (primaryBrowserLang === 'zh') { // Special handling for Chinese
                if (regionCode === 'cn' || regionCode === 'sg' || browserLang.toLowerCase() === 'zh-hans') {
                    initialLang = 'zh-hans';
                } else if (regionCode === 'tw' || regionCode === 'hk' || regionCode === 'mo' || browserLang.toLowerCase() === 'zh-hant') {
                    initialLang = 'zh-hant';
                } else if (langOptionExists && Array.from(langSelectorElement.options).some(opt => opt.value === 'zh-hans')) { // Fallback if region not specific
                    initialLang = 'zh-hans';
                } else {
                    initialLang = 'en'; // Ultimate fallback for unhandled zh variants
                }
            } else if (langOptionExists) {
                initialLang = primaryBrowserLang;
            } else {
                initialLang = 'en'; // Fallback for other unlisted browser languages
            }
        }
        
        currentLanguage = initialLang; 

        let variantToLoad = currentLanguage;
        if (currentBU) {
            variantToLoad = `${currentLanguage}-${currentBU}`;
        }
        
        await loadVariantFiles(variantToLoad); 
        
        if (competenciesData && competenciesData.length > 0) {
            decodeAndLoadResults(); 
        } else {
            console.warn("initializeApp: competenciesData not ready after loadVariantFiles. Skipping decodeAndLoadResults from URL (if any).");
        }
    }

    document.addEventListener('DOMContentLoaded', initializeApp);
    // --- END OF SCRIPT ---
</script>
</body>
</html>

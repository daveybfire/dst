<!DOCTYPE html>
<html lang="en"> <!-- Default lang, will be updated by JS -->
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-WX8HLE4W5Q"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-WX8HLE4W5Q');
    </script>
    <meta charset="utf-8"/>
    <title>Digital Skills Assessment</title> <!-- Will be updated by JS -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
    <script src="resources.js"></script>

    <style>
        /* CSS STYLES (as provided by you, unchanged) */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; margin: 0; padding: 0; color: #333; }
        .container { max-width: 800px; width: 90%; margin: 20px auto; background: #fff; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); border-radius: 10px; padding: 20px 30px; padding-top: 10px; }
        h1, h2, h3 { font-size: 28px; margin: 20px 0; color: #2c3e50; }
        h4 { font-size: 22px; margin-bottom: 10px; color: #2c3e50; }
        p { margin: 10px 0 20px; font-size: 16px; color: #555; line-height: 1.6; }
        .progress-bar-container { width: 100%; background: #e0e0e0; border-radius: 10px; height: 20px; margin: 20px 0; overflow: hidden; position: relative; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, #0f777b, #4caf50); width: 0; transition: width 0.4s ease; }
        .progress-label { position: absolute; width: 100%; text-align: center; top: 0; font-size: 14px; color: #000; line-height: 20px; }
        .competency-banner { font-weight: bold; background: #0f777b; color: #fff; padding: 15px; border-radius: 5px; margin: 20px 0; font-size: 20px; }
        .question-container { background: #e0f7fa; border: 2px solid #0f777b; border-radius: 10px; padding: 15px; margin: 10px 0; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); min-height: 120px; text-align: center; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .question-container h2 { font-size: 24px; font-weight: bold; color: #333; margin: 0; line-height: 1.5; }
        .example { font-style: italic; color: #555; font-size: 16px; margin-top: 15px; }
        .proficiency-buttons { margin: 20px 0; display: flex; justify-content: space-between; flex-wrap: nowrap; }
        .proficiency-button { background: #e0e0e0; border: none; padding: 12px 10px; margin: 0 5px; border-radius: 5px; font-size: 14px; cursor: pointer; transition: background 0.3s ease, transform 0.1s ease; flex: 1; text-align: center; white-space: nowrap; }
        .proficiency-button:hover { background: #d5d5d5; }
        .proficiency-button.selected { background: #4caf50; color: white; transform: scale(1.05); }
        .no-selection-warning { color: red; font-size: 14px; margin-top: 10px; display: none; }
        .button { padding: 12px 25px; margin: 20px 0; background: #0f777b; color: #fff; border: none; border-radius: 5px; cursor: pointer; font-size: 18px; transition: background 0.3s ease; }
        .button:hover { background: #0a5e60; }
        .button:disabled { background: #ccc; cursor: not-allowed; }
        .hidden { display: none; }
        .summary-header { background: #e0f7fa; border: 1px solid #0f777b; border-radius: 10px; padding: 20px; margin-bottom: 30px; text-align: center; }
        .summary-header p { font-size: 18px; color: #2c3e50; margin: 10px 0; }
        .summary-header p span { font-weight: bold; }
        .key-characteristics { text-align: left; margin: 10px 0; padding: 10px; background: #f9f9f9; border-left: 4px solid #4caf50; border-radius: 5px; }
        .key-characteristics ul { list-style: none; padding-left: 0; }
        .key-characteristics li { margin-bottom: 10px; font-size: 16px; position: relative; padding-left: 25px; }
        .key-characteristics li::before { content: "✔"; position: absolute; left: 0; color: #4caf50; font-size: 18px; }
        .personalised-feedback { font-size: 16px; font-style: italic; color: #555; background: #fff; padding: 15px 20px; border-left: 4px solid #ff9800; margin: 20px 0; border-radius: 5px; text-align: left; }
        #competencyRadarChart { max-width: 100%; height: auto; }
        .chart-container { margin: 30px 0; }
        .card { background: #fff; border: 1px solid #e0e0e0; border-radius: 10px; padding: 20px; margin: 20px 0; text-align: left; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
        .card h4 { margin: 0 0 15px; color: #2c3e50; }
        .strengths .card { border-left: 4px solid #4caf50; }
        .growth-areas .card { border-left: 4px solid #f44336; }
        .smart-objectives .card { border-left: 4px solid #ff9800; }
        .section-title { font-size: 24px; margin-top: 40px; color: #2c3e50; text-align: left; padding-bottom: 10px; }
        .icon { font-size: 24px; vertical-align: middle; margin-right: 10px; }
        .thank-you { background: #e0f7fa; border: 1px solid #0f777b; border-radius: 10px; padding: 20px; margin: 30px 0; font-size: 18px; color: #2c3e50; }
        .thank-you p { font-size: 18px; font-weight: bold; }
        .thank-you a { color: #ffffff; background-color: #0f777b; padding: 10px 20px; border-radius: 5px; text-decoration: none; font-size: 16px; }
        .thank-you a:hover { background-color: #0a5e60; }
        @media (max-width: 600px) { .proficiency-button { flex: 1 1 100%; margin: 5px 0; } .container { padding: 15px 20px; } }
        .strengths { background: #e8f5e9; border: 2px solid #4caf50; border-radius: 10px; padding: 20px; margin: 30px 0; }
        .growth-areas { background: #ffebee; border: 2px solid #f44336; border-radius: 10px; padding: 20px; margin: 30px 0; }
        .smart-objectives { background: #fff3e0; border: 2px solid #ff9800; border-radius: 10px; padding: 20px; margin: 30px 0; }
        .strengths .section-title, .growth-areas .section-title, .smart-objectives .section-title { background: rgba(0,0,0,0.05); padding: 10px 15px; border-radius: 5px; margin: -20px -20px 20px -20px; }
        .strengths .card, .growth-areas .card, .smart-objectives .card { background: #fff; border-radius: 8px; padding: 15px; margin: 15px 0; }
        .dropdown .button { background: #0f777b; color: #fff; border: none; padding: 10px 15px; border-radius: 5px; font-size: 16px; cursor: pointer; margin-top: 10px; transition: background 0.3s ease; }
        .dropdown .button:hover { background: #0a5e60; }
        .dropdown-content { display: none; padding: 15px; margin-top: 10px; background: #f9f9f9; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; color: #333; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        #question-text-container { font-size: 18px; font-weight: bold; color: #2c3e50; line-height: 1.6; margin-bottom: 10px; text-align: center; }
        #example-text-container { font-size: 16px; font-style: italic; color: #555; line-height: 1.4; margin-top: 5px; margin-bottom: 0; text-align: center; }
        .chart-description { font-size: 16px; color: #555; margin-bottom: 20px; line-height: 1.5; text-align: center; }
        .qr-url { font-size: 12px; color: #e0e0e0; margin-top: 10px; word-wrap: break-word; }
        #language-selector-container { padding: 10px; text-align: right; background-color: #f8f9fa; border-bottom: 1px solid #e0e0e0; margin-bottom:15px; }
    </style>
</head>
<body>

<div id="language-selector-container">
    <label for="language-selector" id="language-selector-label" style="margin-right: 5px;">Language:</label>
    <select id="language-selector">
        <option value="en">English</option>
        <option value="es">Español (Test)</option>
        <option value="fr">Français (Test)</option>
        <option value="cs">Čeština (Test)</option>
        <option value="nl">Nederlands (Test)</option>
        <option value="de">Deutsch (Test)</option>
        <option value="hu">Magyar (Test)</option>
        <option value="it">Italiano (Test)</option>
        <option value="lv">Latviešu (Test)</option>
        <option value="lt">Lietuvių (Test)</option>
        <option value="ro">Română (Test)</option>
        <option value="sk">Slovenčina (Test)</option>
        <option value="tr">Türkçe (Test)</option>
        <option value="uk">Українська (Test)</option>
        <option value="zh-hans">中文 (简体) (Test)</option>
        <option value="zh-hant">中文 (繁體) (Test)</option>
        <option value="id">Bahasa Indonesia (Test)</option>
        <option value="th">ไทย (Test)</option>
        <option value="vi">Tiếng Việt (Test)</option>
    </select>
</div>

<!-- Start Screen -->
<div class="container" id="start-screen">
    <h1 id="start-screen-title"></h1>
    <p id="start-screen-p1"></p>
    <p id="start-screen-p2"></p>
    <p id="start-screen-p3"></p>
    <p id="start-screen-p4"></p>
    <div style="text-align: center;">
        <button class="button" id="start-button" type="button"></button>
    </div>
</div>

<!-- Assessment Screen -->
<div class="container hidden" id="assessment-screen">
    <div class="competency-banner" id="competency-banner"></div>
    <div class="progress-bar-container">
        <div class="progress-bar" id="progress-bar"></div>
        <div class="progress-label" id="progress-label">0%</div>
    </div>
    <div class="question-container">
        <h2 id="question-text-container"></h2>
        <p class="example" id="example-text-container"></p>
    </div>
    <div class="proficiency-buttons">
        <!-- Buttons will be populated by JS -->
    </div>
    <div class="no-selection-warning" id="no-selection-warning"></div>
    <div class="dropdown">
        <button class="button" id="toggle-proficiency-button" onclick="toggleDropdown(event)"></button>
        <div class="dropdown-content" id="proficiency-dropdown-content" style="display: block;">
            <!-- Proficiency descriptions will be populated by JS -->
        </div>
    </div>
</div>

<!-- End Screen -->
<div class="container hidden" id="end-screen">
    <h2 id="end-screen-title"></h2>
    <div id="advanced-results">
        <div class="summary-header">
            <p style="font-size: 28px; font-weight: bold; color: #4caf50; margin: 10px 0;">
                <span id="total-score-advanced"></span>
            </p>
            <p style="font-size: 14px; color: #555; margin: 5px 0;">
                <span id="current-date-advanced"></span>
            </p>
            <div id="qr-code-container" style="text-align: center; margin-top: 20px;">
                <h3 id="qr-code-title"></h3>
                <canvas id="qr-code"></canvas>
                <p id="qr-code-instruction"></p>
            </div>
        </div>
        <div class="key-characteristics">
            <h3 id="key-char-title"></h3>
            <p id="key-char-intro"></p>
            <ul id="key-characteristics-advanced"></ul>
        </div>
        <div class="personalised-feedback" id="personalised-feedback-advanced"></div>
        <div class="chart-container">
            <h3 id="radar-chart-title"></h3>
            <p class="chart-description" id="radar-chart-desc"></p>
            <canvas id="competencyRadarChart"></canvas>
            <p id="radar-chart-legend"></p>
        </div>
        <div class="strengths">
            <h3 class="section-title" id="strengths-title"></h3>
            <p id="strengths-intro"></p>
            <div id="strengths"></div>
        </div>
        <div class="growth-areas">
            <h3 class="section-title" id="growth-areas-title"></h3>
            <p id="growth-areas-intro"></p>
            <div id="growth-areas"></div>
        </div>
        <div class="smart-objectives">
            <h3 class="section-title" id="smart-objectives-title"></h3>
            <p id="smart-objectives-intro"></p>
            <div id="smart-objectives"></div>
        </div>
        <div class="thank-you">
            <span id="thank-you-message"></span>
            <div id="survey-link" style="text-align: center; margin-top: 20px;">
                <p id="survey-prompt"></p>
                <a href="https://forms.office.com/Pages/ResponsePage.aspx?id=-QiCXGC1CUmQO1pcxbHUWnL9uYyvyttIoQ6Huyhcv7tUOUM4QU05UTUxUUhFS0dIOU5SM0pXUVdaQy4u"
                   target="_blank"
                   id="survey-button"
                   style="color: #ffffff; background-color: #0f777b; padding: 10px 20px; border-radius: 5px; text-decoration: none; font-size: 16px;">
                </a>
            </div>
        </div>
    </div>
    <div style="text-align: center;">
        <button class="button" id="restart-button" type="button"></button>
        <div style="text-align: center; margin-top: 10px;">
            <p id="qr-url" class="qr-url"></p> <!-- Corrected typo -->
        </div>
    </div>
</div>

<script>
    let i18nData = {};
    let currentSelectedLang = 'en';
    let questionsData = [];
    let competenciesData = [];
    let overallProficiencyLevelsData = [];

    // ROBUST t() function
    function t(key, replacements = {}) {
        if (typeof i18nData !== 'object' || i18nData === null) {
            // console.warn(`i18nData not an object or is null when looking for key: ${key}`);
            return `MISSING_I18NDATA: ${key}`;
        }
        let textValue = i18nData;
        const parts = key.split('.');
        for (let i = 0; i < parts.length; i++) {
            const part = parts[i];
            if (textValue && typeof textValue === 'object' && Object.prototype.hasOwnProperty.call(textValue, part)) {
                textValue = textValue[part];
            } else {
                // console.warn(`Translation key path broken at '${part}' for key: ${key}`);
                return `MISSING_TRANSLATION: ${key}`; 
            }
        }
        if (typeof textValue !== 'string') {
            // console.warn(`Translation for key '${key}' is not a string:`, textValue);
            return `INVALID_TRANSLATION_TYPE: ${key}`;
        }
        let finalText = textValue;
        for (const placeholder in replacements) {
            finalText = finalText.replace(new RegExp(`{${placeholder}}`, 'g'), replacements[placeholder]);
        }
        return finalText;
    }

    async function loadTranslations(langCodeToTry) {
        console.log(`loadTranslations CALLED for lang: ${langCodeToTry}`);
        let langToLoad = langCodeToTry.toLowerCase().split('-')[0]; 
        // Handle specific cases for Chinese
        if (langCodeToTry.toLowerCase() === 'zh-hans') langToLoad = 'zh-hans';
        if (langCodeToTry.toLowerCase() === 'zh-hant') langToLoad = 'zh-hant';
        
        let response;

        try {
            response = await fetch(`${langToLoad}.json?v=${new Date().getTime()}`);
            if (!response.ok) {
                console.warn(`Could not load ${langToLoad}.json (Status: ${response.status}). Falling back to English.`);
                if (langToLoad === 'en') { 
                    throw new Error('Critical: Failed to load en.json. Application cannot start.');
                }
                langToLoad = 'en'; 
                response = await fetch(`en.json?v=${new Date().getTime()}`);
                if (!response.ok) {
                    throw new Error('Critical: Failed to load en.json as fallback. Application cannot start.');
                }
            }
            i18nData = await response.json();
            console.log('Successfully loaded i18nData for:', langToLoad, JSON.parse(JSON.stringify(i18nData)));
            
            currentSelectedLang = langToLoad; 
            document.documentElement.lang = currentSelectedLang;
            document.title = t('appTitle'); 

            questionsData = i18nData.questions || [];
            competenciesData = i18nData.competencyList || [];
            overallProficiencyLevelsData = i18nData.overallProficiencyLevels || [];
            
            if (competenciesData && competenciesData.length > 0) {
                const numCompetencies = competenciesData.length;
                answers.Knowledge = Array(numCompetencies).fill(0);
                answers.Skills = Array(numCompetencies).fill(0);
                answers.Attitudes = Array(numCompetencies).fill(0);
                console.log("Answers arrays initialized/reset in loadTranslations. Length:", numCompetencies);
            } else {
                console.error("Competencies data is empty. Answers not initialized.");
            }

            applyTranslations(); 
            updateLanguageSelectorValue(currentSelectedLang); 
            localStorage.setItem('selectedUserLanguage', currentSelectedLang); 

            console.log(`${currentSelectedLang.toUpperCase()} translations applied.`);

        } catch (error) {
            console.error("Fatal error loading translation file:", error);
            document.body.innerHTML = `<div style="padding: 20px; text-align: center; font-family: sans-serif;"><h1>Error</h1><p>Could not load required resources. Please try again. Details: ${error.message}</p></div>`;
        }
    }
    
    function updateLanguageSelectorValue(langCode) {
        const selector = document.getElementById('language-selector');
        if (selector) {
            selector.value = langCode;
            const label = document.getElementById('language-selector-label');
            if (label) {
                label.textContent = t('misc.languageLabel') || 'Language:';
            }
        }
    }

    function applyTranslations() {
        console.log("applyTranslations CALLED for lang:", currentSelectedLang);
        // document.title is set in loadTranslations
        setText('start-screen-title', t('startScreen.title'));
        setHTML('start-screen-p1', t('startScreen.introParagraph1'));
        setHTML('start-screen-p2', t('startScreen.introParagraph2'));
        setHTML('start-screen-p3', t('startScreen.introParagraph3'));
        setHTML('start-screen-p4', t('startScreen.introParagraph4'));
        setText('start-button', t('startScreen.startButtonText'));
        setText('no-selection-warning', t('assessmentScreen.noSelectionWarning'));
        
        const toggleProfButton = document.getElementById('toggle-proficiency-button');
        if (toggleProfButton) {
            const proficiencyDropdownEl = document.getElementById('proficiency-dropdown-content');
            // Check if proficiencyDropdownEl exists and then its display style
            if (proficiencyDropdownEl && (proficiencyDropdownEl.style.display === "none" || proficiencyDropdownEl.style.display === "")) {
                toggleProfButton.textContent = t('assessmentScreen.showProficiencyLevelsButton');
            } else if (proficiencyDropdownEl) { // Only set if it exists
                toggleProfButton.textContent = t('assessmentScreen.hideProficiencyLevelsButton');
            }
        }

        const proficiencyDropdown = document.getElementById('proficiency-dropdown-content');
        if (proficiencyDropdown) {
            proficiencyDropdown.innerHTML = `
                <p>${t('assessmentScreen.proficiencyLevelsDropdown.beginner')}</p>
                <p>${t('assessmentScreen.proficiencyLevelsDropdown.developing')}</p>
                <p>${t('assessmentScreen.proficiencyLevelsDropdown.competent')}</p>
                <p>${t('assessmentScreen.proficiencyLevelsDropdown.proficient')}</p>
                <p>${t('assessmentScreen.proficiencyLevelsDropdown.expert')}</p>
            `;
        }
        populateProficiencyButtons();

        if (!assessmentScreen.classList.contains('hidden') && questionsData.length > 0) {
             console.log("Assessment screen visible, re-rendering current question for new language.");
            renderQuestion(currentIndex); 
        }

        if (!endScreen.classList.contains('hidden')) {
            console.log("End screen visible, re-applying translations and re-generating results for new language.");
            setText('end-screen-title', t('endScreen.title'));
            setText('qr-code-title', t('endScreen.qrCodeSectionTitle'));
            setText('qr-code-instruction', t('endScreen.qrCodeInstruction'));
            setText('key-char-title', t('endScreen.keyCharacteristicsTitle'));
            setText('key-char-intro', t('endScreen.keyCharacteristicsIntro'));
            setText('radar-chart-title', t('endScreen.radarChartTitle'));
            setText('radar-chart-desc', t('endScreen.radarChartDescription'));
            setHTML('radar-chart-legend', constructRadarLegend());
            setHTML('strengths-title', t('endScreen.strengthsSectionTitle'));
            setText('strengths-intro', t('endScreen.strengthsSectionIntro'));
            setHTML('growth-areas-title', t('endScreen.growthAreasSectionTitle'));
            setText('growth-areas-intro', t('endScreen.growthAreasSectionIntro'));
            setHTML('smart-objectives-title', t('endScreen.smartObjectivesSectionTitle'));
            setText('smart-objectives-intro', t('endScreen.smartObjectivesSectionIntro'));
            setHTML('thank-you-message', t('endScreen.thankYouMessage'));
            setText('survey-prompt', t('endScreen.surveyPrompt'));
            setText('survey-button', t('endScreen.surveyButtonText'));
            setText('restart-button', t('endScreen.restartButtonText'));
            // Re-generate dynamic parts of results page if already shown
            if (answers.Knowledge.length > 0 || answers.Skills.length > 0 || answers.Attitudes.length > 0) { // Check if results were generated
                 generateResultsPageContent();
            }
        }
    }

    // ... (constructRadarLegend, setText, setHTML, populateProficiencyButtons are the same as your last working version)
    // ... (answers, DOM element consts are the same)
    // ... (getCompetencyNameByKey is the same)
    // ... (renderQuestion, attachEventListeners, showResults, encodeResponses, decodeAndLoadResults, displayKeyCharacteristics, 
    //      generateResultsPageContent, getStrongest/WeakestDimension, getFeedback/SmartObjective functions, 
    //      generateStrengths, generateGrowthAreas, generateSmartObjectives, generateRadarChart, 
    //      restartButton listener, startButton listener, QR code functions, toggleDropdown 
    //      ARE ALL THE SAME as the version that produced the correct console logs.
    //      They already contain the detailed console.log statements we need.)

    // For brevity, I will re-paste only the functions that changed for language handling,
    // assuming the rest of your JS (from the last version I provided you that logged correctly) is still in place.
    // If you need the full JS block again, let me know. The key parts for language switching
    // are `initializeApp`, the modified `loadTranslations`, `updateLanguageSelectorValue`,
    // and how `applyTranslations` handles re-rendering.

    // --- PASTE THE FULL SCRIPT FROM THE PREVIOUS MESSAGE HERE ---
    // --- (The one starting with `let i18nData = {};` and ending with `window.onload = initializeApp;`) ---
    // --- ENSURE IT IS THE VERSION THAT INCLUDES ALL THE CONSOLE LOGS WE DISCUSSED ---
    // --- AND THE ROBUST t() FUNCTION ---
    // The version you pasted in message #29 had these, so that should be the one.
    // The only additions here are the language dropdown HTML and the updated JS for language selection.
    
    // The script block here should be the *entirety* of your previous script block,
    // with the modifications to loadTranslations and the new initializeApp as shown in my prior message
    // (the one where I introduced the language dropdown and related JS).
    // For clarity, I will re-provide the *entire* JS block again:


    const answers = { Knowledge: [], Skills: [], Attitudes: [] };
    const startScreen = document.getElementById("start-screen");
    const assessmentScreen = document.getElementById("assessment-screen");
    const endScreen = document.getElementById("end-screen");
    const progressBar = document.getElementById("progress-bar");
    const progressLabel = document.getElementById("progress-label");
    const competencyBanner = document.getElementById("competency-banner");
    const questionTextContainer = document.getElementById("question-text-container");
    const exampleTextContainer = document.getElementById("example-text-container");
    let proficiencyButtons = document.querySelectorAll(".proficiency-button");
    const noSelectionWarningEl = document.getElementById("no-selection-warning");
    const strengthsContainer = document.getElementById("strengths");
    const growthAreasContainer = document.getElementById("growth-areas");
    const smartObjectivesContainer = document.getElementById("smart-objectives");
    const restartButton = document.getElementById("restart-button");
    const startButton = document.getElementById("start-button");
    let currentIndex = 0;
    let radarChart;

    // getCompetencyNameByKey, renderQuestion, attachEventListeners, showResults,
    // encodeResponses, decodeAndLoadResults, displayKeyCharacteristics,
    // generateResultsPageContent, getStrongestDimension, getWeakestDimension,
    // getFeedbackForCompetency, getGrowthFeedbackForCompetency, getSmartObjective,
    // generateStrengths, generateGrowthAreas, generateSmartObjectives, generateRadarChart,
    // restartButton.addEventListener, startButton.addEventListener,
    // updateQRCodeURL, generateQRCode, toggleDropdown
    // These functions are assumed to be the versions from your last working file
    // (the one that produced the correct console logs where translatedDimensionName was correct).
    // I will include them here for completeness from the last version I generated.

    function getCompetencyNameByKey(key) {
        if (!competenciesData) return `NO_COMP_DATA_FOR_KEY: ${key}`;
        const competency = competenciesData.find(c => c.key === key);
        return competency ? competency.name : `MISSING_COMP_NAME: ${key}`;
    }

    function renderQuestion(index) {
        console.log(`renderQuestion CALLED for index: ${index}`);
        if (!questionsData || questionsData.length === 0 || index >= questionsData.length) {
            console.error("Questions data issue or index out of bounds in renderQuestion.", { qDataLength: questionsData?.length, index });
            return;
        }
        const question = questionsData[index];
        const competencyName = getCompetencyNameByKey(question.competencyKey);
        const examplePrefixText = t('misc.examplePrefix');

        competencyBanner.textContent = `${t('assessmentScreen.competencyBannerPrefix')}${competencyName}`;
        questionTextContainer.textContent = t(`questionTexts.${question.questionKey}`);
        exampleTextContainer.textContent = `${examplePrefixText.startsWith("MISSING_") ? "Example: " : examplePrefixText}${t(`questionTexts.${question.exampleKey}`)}`;

        const progressPercentage = Math.round(((index + 1) / questionsData.length) * 100);
        progressBar.style.width = `${progressPercentage}%`;
        progressLabel.textContent = `${progressPercentage}${t('assessmentScreen.progressLabelSuffix')}`;
        
        // Ensure proficiencyButtons is up-to-date before iterating
        proficiencyButtons = document.querySelectorAll("#assessment-screen .proficiency-button");
        proficiencyButtons.forEach(button => button.classList.remove("selected"));
        
        if(noSelectionWarningEl) noSelectionWarningEl.style.display = 'none';
        attachEventListeners();
    }

    function attachEventListeners() {
        console.log("attachEventListeners CALLED");
        proficiencyButtons = document.querySelectorAll("#assessment-screen .proficiency-button");
        
        proficiencyButtons.forEach(button => {
            const newButton = button.cloneNode(true); 
            if (button.parentNode) {
                button.parentNode.replaceChild(newButton, button);
            }
        });
        proficiencyButtons = document.querySelectorAll("#assessment-screen .proficiency-button"); 

        proficiencyButtons.forEach(button => {
            button.onclick = () => {
                if(noSelectionWarningEl) noSelectionWarningEl.style.display = 'none';
                proficiencyButtons.forEach(btn => btn.classList.remove("selected"));
                button.classList.add("selected");
                const selectedValue = parseInt(button.getAttribute("data-value"));
                const currentQuestion = questionsData[currentIndex];
                const competencyIndex = competenciesData.findIndex(c => c.key === currentQuestion.competencyKey);

                if (competencyIndex === -1) {
                    console.error("Could not find competency index for key:", currentQuestion.competencyKey); return;
                }
                if (answers[currentQuestion.type] && competencyIndex < answers[currentQuestion.type].length) {
                     answers[currentQuestion.type][competencyIndex] = selectedValue;
                } else {
                    console.error(`Answer type ${currentQuestion.type} or index ${competencyIndex} out of bounds. Answers array for type:`, answers[currentQuestion.type]);
                }

                if (currentIndex < questionsData.length - 1) {
                    currentIndex++;
                    renderQuestion(currentIndex);
                } else {
                    console.log("Last question answered, calling showResults()");
                    showResults();
                }
            };
        });
    }

    function showResults() {
        console.log("showResults() function CALLED");
        if(progressBar) progressBar.style.width = "100%";
        if(progressLabel) progressLabel.textContent = `100${t('assessmentScreen.progressLabelSuffix')}`;
        if(assessmentScreen) assessmentScreen.classList.add("hidden");
        if(startScreen) startScreen.classList.add("hidden");
        if(endScreen) endScreen.classList.remove("hidden");

        const today = new Date();
        const currentDay = String(today.getDate()).padStart(2, '0');
        const currentMonth = String(today.getMonth() + 1).padStart(2, '0');
        const currentYear = today.getFullYear();
        const formattedCurrentDate = `${currentDay}/${currentMonth}/${currentYear}`;
        setText('current-date-advanced', formattedCurrentDate);

        console.log("Attempting to call generateResultsPageContent() from showResults");
        generateResultsPageContent();
        console.log("Finished calling generateResultsPageContent() from showResults");
        
        const totalScore = (answers.Knowledge.reduce((a, b) => a + b, 0) || 0) +
                           (answers.Skills.reduce((a, b) => a + b, 0) || 0) +
                           (answers.Attitudes.reduce((a, b) => a + b, 0) || 0) ;
        const maxScore = (competenciesData.length || 0) * 3 * 5;
        const percentageScore = maxScore > 0 ? Math.round((totalScore / maxScore) * 100) : 0;
        let userProficiencyLevelText = "";
        let userKeyCharacteristics = [];
        let userFeedback = "";

        for (let level of overallProficiencyLevelsData) {
            if (percentageScore >= level.range[0] && percentageScore <= level.range[1]) {
                const levelName = t(`proficiencyTexts.${level.nameKey}`);
                userProficiencyLevelText = `${levelName} (${level.range[0]}% - ${level.range[1]}%)`;
                userKeyCharacteristics = level.characteristicsKeys.map(key => t(`proficiencyTexts.${key}`));
                userFeedback = t(`proficiencyTexts.${level.feedbackKey}`);
                break;
            }
        }
        setText('total-score-advanced', `${percentageScore}% (${userProficiencyLevelText.split(' ')[0] || 'N/A'})`);
        displayKeyCharacteristics(userKeyCharacteristics);
        setText('personalised-feedback-advanced', userFeedback);
        const encodedData = encodeResponses();
        if (document.getElementById('qr-code')) { 
            generateQRCode(encodedData, 'qr-code');
        }
        updateQRCodeURL(encodedData);
    }

    function encodeResponses() {
        const numCompetencies = competenciesData.length || 0;
        const knowledge = (answers.Knowledge || []).slice(0, numCompetencies).join('');
        const skills = (answers.Skills || []).slice(0, numCompetencies).join('');
        const attitudes = (answers.Attitudes || []).slice(0, numCompetencies).join('');
        return `${knowledge}-${skills}-${attitudes}`;
    }

    function decodeAndLoadResults() {
        console.log("decodeAndLoadResults CALLED");
        const data = new URLSearchParams(window.location.search).get('data');
        if (data) {
            console.log("Data found in URL, attempting to process.");
            const parts = data.split('-');
            if (parts.length === 3 && competenciesData && competenciesData.length > 0) {
                const [knowledgeStr, skillsStr, attitudesStr] = parts;
                const numCompetencies = competenciesData.length;
                answers.Knowledge = knowledgeStr.split('').map(Number).slice(0, numCompetencies);
                answers.Skills = skillsStr.split('').map(Number).slice(0, numCompetencies);
                answers.Attitudes = attitudesStr.split('').map(Number).slice(0, numCompetencies);
                while (answers.Knowledge.length < numCompetencies) answers.Knowledge.push(0);
                while (answers.Skills.length < numCompetencies) answers.Skills.push(0);
                while (answers.Attitudes.length < numCompetencies) answers.Attitudes.push(0);
                console.log("Successfully decoded URL data, calling showResults() from decodeAndLoadResults");
                showResults();
            } else if (!competenciesData || competenciesData.length === 0) {
                 console.warn("Attempted to decode results but competenciesData not ready. URL data ignored for now.");
            } else {
                console.warn("Decoded data from URL is malformed.");
            }
        } else {
             console.log("No data in URL for decodeAndLoadResults.");
        }
    }

    function displayKeyCharacteristics(characteristics) {
        const listEl = document.getElementById('key-characteristics-advanced');
        if(!listEl) return;
        listEl.innerHTML = '';
        characteristics.forEach(characteristic => {
            const li = document.createElement('li');
            li.textContent = characteristic;
            listEl.appendChild(li);
        });
    }

    function generateResultsPageContent() {
        console.log("generateResultsPageContent() CALLED");
        console.log("competenciesData at start of generateResultsPageContent:", JSON.parse(JSON.stringify(competenciesData)));
        console.log("Answers at start of generateResultsPageContent:", JSON.parse(JSON.stringify(answers)));

        if (!competenciesData || competenciesData.length === 0) {
            console.error("Cannot generate results content, competenciesData is empty or null.");
            return;
        }
        const competencyScores = competenciesData.map((comp, i) => {
            const knowledgeScore = answers.Knowledge[i] || 0;
            const skillsScore = answers.Skills[i] || 0;
            const attitudesScore = answers.Attitudes[i] || 0;
            const total = knowledgeScore + skillsScore + attitudesScore;
            return { key: comp.key, name: comp.name, knowledgeScore, skillsScore, attitudesScore, total };
        });
        const sortedDesc = [...competencyScores].sort((a, b) => b.total - a.total);
        const sortedAsc = [...competencyScores].sort((a, b) => a.total - b.total);
        
        const topCompetencies = sortedDesc.slice(0, 3);
        const bottomCompetencies = sortedAsc.slice(0, 3);

        console.log("Top competencies for strengths:", JSON.parse(JSON.stringify(topCompetencies)));
        generateStrengths(topCompetencies); 

        console.log("Bottom competencies for growth:", JSON.parse(JSON.stringify(bottomCompetencies)));
        generateGrowthAreas(bottomCompetencies);

        console.log("Generating Radar Chart from generateResultsPageContent");
        generateRadarChart();

        console.log("Bottom competencies for SMART:", JSON.parse(JSON.stringify(bottomCompetencies)));
        generateSmartObjectives(bottomCompetencies);
    }

    function getStrongestDimension(comp) {
        const scores = [
            { dimension: "Knowledge", score: comp.knowledgeScore || 0 },
            { dimension: "Skills", score: comp.skillsScore || 0 },
            { dimension: "Attitudes", score: comp.attitudesScore || 0 }
        ];
        scores.sort((a, b) => b.score - a.score);
        return scores[0].dimension;
    }

    function getWeakestDimension(comp) {
        const scores = [
            { dimension: "Knowledge", score: comp.knowledgeScore || 0 },
            { dimension: "Skills", score: comp.skillsScore || 0 },
            { dimension: "Attitudes", score: comp.attitudesScore || 0 }
        ];
        scores.sort((a, b) => a.score - b.score);
        return scores[0].dimension;
    }

    function getFeedbackForCompetency(competencyKey, dimension) {
        return t(`feedbackStrengths.${competencyKey}.${dimension}`);
    }
    function getGrowthFeedbackForCompetency(competencyKey, dimension) {
        return t(`feedbackGrowth.${competencyKey}.${dimension}`);
    }
    function getSmartObjective(competencyKey, dimension) {
        return t(`smartObjectives.${competencyKey}.${dimension}`);
    }

    function generateStrengths(topCompetencies) {
        console.log("--- Strength Generation --- (Inside generateStrengths) CALLED with topCompetencies:", JSON.parse(JSON.stringify(topCompetencies)));
        if (!strengthsContainer) { console.error("strengthsContainer is null"); return; }
        strengthsContainer.innerHTML = '';
        topCompetencies.forEach(comp => {
            const strongestDimension = getStrongestDimension(comp);
            const competencyName = comp.name;
            const strengthLabel = t('endScreen.strongestDimensionLabel');
            
            console.log("Strength Debug - Comp:", competencyName, "Raw Strongest Dim:", strongestDimension);
            const lookupKey = `endScreen.radarChartLegend${strongestDimension}`;
            console.log("Strength Debug - Lookup Key:", lookupKey);
            
            const translatedDimensionName = t(lookupKey);
            console.log("Strength Debug - Translated Dim Name for HTML:", translatedDimensionName, "(Type:", typeof translatedDimensionName + ")");

            const feedbackText = getFeedbackForCompetency(comp.key, strongestDimension);

            const htmlSegment = `
                <div class="strength-item card">
                    <h4>${competencyName}</h4>
                    <p><strong>${strengthLabel}</strong> ${translatedDimensionName}</p>
                    <p>${feedbackText}</p>
                </div>`;
            
            console.log("Strength Debug - HTML Segment to be added:", htmlSegment);

            try {
                strengthsContainer.innerHTML += htmlSegment;
            } catch (e) {
                console.error("Error during innerHTML update for strengths:", e, "Segment was:", htmlSegment);
            }
        });
    }

    function generateGrowthAreas(bottomCompetencies) {
        console.log("--- Growth Area Generation --- (Inside generateGrowthAreas) CALLED with bottomCompetencies:", JSON.parse(JSON.stringify(bottomCompetencies)));
        if (!growthAreasContainer) { console.error("growthAreasContainer is null"); return; }
        growthAreasContainer.innerHTML = '';
        bottomCompetencies.forEach(comp => {
            const weakestDimension = getWeakestDimension(comp);
            const competencyName = comp.name;
            const growthLabel = t('endScreen.growthAreaLabel');

            console.log("Growth Debug - Comp:", competencyName, "Raw Weakest Dim:", weakestDimension);
            const lookupKey = `endScreen.radarChartLegend${weakestDimension}`;
            console.log("Growth Debug - Lookup Key:", lookupKey);

            const translatedDimensionName = t(lookupKey);
            console.log("Growth Debug - Translated Dim Name for HTML:", translatedDimensionName, "(Type:", typeof translatedDimensionName + ")");
            
            const feedbackText = getGrowthFeedbackForCompetency(comp.key, weakestDimension);

            const htmlSegment = `
                <div class="growth-item card">
                    <h4>${competencyName}</h4>
                    <p><strong>${growthLabel}</strong> ${translatedDimensionName}</p>
                    <p>${feedbackText}</p>
                </div>`;

            console.log("Growth Debug - HTML Segment to be added:", htmlSegment);
            
            try {
                growthAreasContainer.innerHTML += htmlSegment;
            } catch (e) {
                console.error("Error during innerHTML update for growth areas:", e, "Segment was:", htmlSegment);
            }
        });
    }

    function generateSmartObjectives(bottomCompetencies) {
        console.log("--- SMART Objective Generation --- (Inside generateSmartObjectives) CALLED with bottomCompetencies:", JSON.parse(JSON.stringify(bottomCompetencies)));
        if (!smartObjectivesContainer) { console.error("smartObjectivesContainer is null"); return; }
        smartObjectivesContainer.innerHTML = '';
        bottomCompetencies.forEach(comp => {
            const weakestDimension = getWeakestDimension(comp);
            const competencyName = comp.name;
            const growthLabel = t('endScreen.growthAreaLabel');
            const smartObjectiveLabel = t('endScreen.smartObjectiveLabel');

            console.log("SMART Debug - Comp:", competencyName, "Raw Weakest Dim:", weakestDimension);
            const dimensionNameLookupKey = `endScreen.radarChartLegend${weakestDimension}`;
            console.log("SMART Debug - Lookup Key for Dim Name:", dimensionNameLookupKey);

            const translatedDimensionNameForSMART = t(dimensionNameLookupKey);
            console.log("SMART Debug - Translated Dim Name for HTML:", translatedDimensionNameForSMART, "(Type:", typeof translatedDimensionNameForSMART + ")");
            
            const smartObjectiveText = getSmartObjective(comp.key, weakestDimension);
            const userLevel = comp[`${weakestDimension.toLowerCase()}Score`];
            let levelsToShow = userLevel ? (userLevel === 1 ? [1,2,3] : (userLevel === 5 ? [3,4,5] : [userLevel-1, userLevel, userLevel+1].filter(l=>l>=1 && l<=5))) : [1,2,3];
            const competencyForResourceLookup = competenciesData.find(c => c.key === comp.key)?.name;
            const filteredResources = (window.resources || []).filter(r => r.competency === competencyForResourceLookup && r.level === weakestDimension.toLowerCase());
            const chosenResources = filteredResources.filter(r => levelsToShow.includes(r.rating)).slice(0, 3);
            let resourcesHTML = '';
            if (chosenResources.length > 0) {
                resourcesHTML = `
                    <h5>${t('endScreen.recommendedResourcesLabel')}</h5>
                    <ul style="list-style:none; padding:0; margin:10px 0;">
                        ${chosenResources.map(r => `<li><a href="${r.URL}" target="_blank" style="text-decoration:none; color:#0f777b;"><strong>${r.title}</strong>: ${r.description}</a></li>`).join('')}
                    </ul>`;
            }

            const htmlSegment = `
                <div class="smart-item card">
                    <h4>${competencyName}</h4>
                    <p><strong>${growthLabel}</strong> ${translatedDimensionNameForSMART}</p>
                    <p><strong>${smartObjectiveLabel}</strong> ${smartObjectiveText}</p>
                    ${resourcesHTML}
                </div>`;
            
            console.log("SMART Debug - HTML Segment to be added:", htmlSegment);

            try {
                smartObjectivesContainer.innerHTML += htmlSegment;
            } catch (e) {
                console.error("Error during innerHTML update for SMART objectives:", e, "Segment was:", htmlSegment);
            }
        });
    }

    function generateRadarChart() {
        if (radarChart) radarChart.destroy();
        if (!competenciesData || competenciesData.length === 0 || !document.getElementById('competencyRadarChart')) return;
        const radarLabels = competenciesData.map(c => c.name);
        const data = {
            labels: radarLabels,
            datasets: [
                { label: t('endScreen.radarChartLegendKnowledge'), data: answers.Knowledge, fill: true, backgroundColor: 'rgba(255,99,132,0.2)', borderColor: 'rgb(255,99,132)', pointBackgroundColor: 'rgb(255,99,132)', borderWidth: 1 },
                { label: t('endScreen.radarChartLegendSkills'), data: answers.Skills, fill: true, backgroundColor: 'rgba(54,162,235,0.2)', borderColor: 'rgb(54,162,235)', pointBackgroundColor: 'rgb(54,162,235)', borderWidth: 1 },
                { label: t('endScreen.radarChartLegendAttitudes'), data: answers.Attitudes, fill: true, backgroundColor: 'rgba(75,192,192,0.2)', borderColor: 'rgb(75,192,192)', pointBackgroundColor: 'rgb(75,192,192)', borderWidth: 1 }
            ]
        };
        const radarCtx = document.getElementById('competencyRadarChart').getContext('2d');
        radarChart = new Chart(radarCtx, {
            type: 'radar', data: data,
            options: { responsive: true, maintainAspectRatio: true, elements: { line: { tension: 0.1 } }, scales: { r: { angleLines: { display: false }, suggestedMin: 0, suggestedMax: 5, ticks: { stepSize: 1, beginAtZero: true, backdropColor: 'transparent' } } } }
        });
    }

    restartButton.addEventListener("click", () => {
        currentIndex = 0;
        if (competenciesData && competenciesData.length > 0) {
            const numCompetencies = competenciesData.length;
            answers.Knowledge = Array(numCompetencies).fill(0);
            answers.Skills = Array(numCompetencies).fill(0);
            answers.Attitudes = Array(numCompetencies).fill(0);
        }
        if(endScreen) endScreen.classList.add("hidden");
        if(assessmentScreen) assessmentScreen.classList.add("hidden");
        if(startScreen) startScreen.classList.remove("hidden");
        if (radarChart) { radarChart.destroy(); radarChart = null; }
        const qrCodeCanvas = document.getElementById('qr-code');
        if (qrCodeCanvas && qrCodeCanvas.getContext) qrCodeCanvas.getContext('2d').clearRect(0, 0, qrCodeCanvas.width, qrCodeCanvas.height);
        setText('qr-url', '');
        if(strengthsContainer) strengthsContainer.innerHTML = '';
        if(growthAreasContainer) growthAreasContainer.innerHTML = '';
        if(smartObjectivesContainer) smartObjectivesContainer.innerHTML = '';
        // After resetting, re-apply translations to ensure start screen is in current language.
        applyTranslations(); 
    });

    startButton.addEventListener("click", () => {
        if(startScreen) startScreen.classList.add("hidden");
        if(assessmentScreen) assessmentScreen.classList.remove("hidden");
        if (competenciesData && competenciesData.length > 0) {
            const numCompetencies = competenciesData.length;
            answers.Knowledge = Array(numCompetencies).fill(0);
            answers.Skills = Array(numCompetencies).fill(0);
            answers.Attitudes = Array(numCompetencies).fill(0);
            currentIndex = 0; 
            renderQuestion(currentIndex);
        } else {
            console.error("Cannot start assessment, competencies data not loaded.");
        }
    });

    function updateQRCodeURL(data) {
        const resultsURL = `${window.location.origin}${window.location.pathname}?data=${data}`;
        setText('qr-url', resultsURL);
    }

    function generateQRCode(data, canvasId) {
        const qrCodeCanvas = document.getElementById(canvasId);
        if (!qrCodeCanvas) { console.error(`Canvas ${canvasId} not found.`); return; }
        const resultsURL = `${window.location.origin}${window.location.pathname}?data=${data}`;
        QRCode.toCanvas(qrCodeCanvas, resultsURL, { width: 200, margin: 2 }, err => {
            if (err) console.error(`Error QR code for ${canvasId}:`, err);
        });
    }

    function toggleDropdown(event) {
        const button = event.target;
        const dropdownContent = document.getElementById('proficiency-dropdown-content');
        if (dropdownContent) {
            const isHidden = dropdownContent.style.display === "none" || dropdownContent.style.display === "";
            dropdownContent.style.display = isHidden ? "block" : "none";
            button.textContent = t(isHidden ? 'assessmentScreen.hideProficiencyLevelsButton' : 'assessmentScreen.showProficiencyLevelsButton');
        }
    }
    
    async function initializeApp() {
        console.log("initializeApp CALLED");
        const langSelectorElement = document.getElementById('language-selector');
        if (langSelectorElement) {
            langSelectorElement.addEventListener('change', async (event) => {
                const newLang = event.target.value;
                console.log(`Language dropdown changed to: ${newLang}.`);
                await loadTranslations(newLang); // This will call applyTranslations

                // If assessment was in progress or finished, restart it to reflect new language properly.
                if (!startScreen.classList.contains('hidden')) { // Currently on start screen
                    // applyTranslations called by loadTranslations is enough
                } else { // Was on assessment or end screen
                    console.log("Language changed mid-process, simulating restart.");
                    if (restartButton) restartButton.click(); 
                    // restartButton handler calls applyTranslations after resetting view.
                }
            });
        } else {
            console.warn("Language selector element 'language-selector' not found.");
        }

        const preferredLang = localStorage.getItem('selectedUserLanguage') || navigator.language || navigator.userLanguage || 'en';
        await loadTranslations(preferredLang); 
        
        decodeAndLoadResults(); 
        console.log("initializeApp COMPLETED");
    }

    window.onload = initializeApp;

</script>
</body>
</html>

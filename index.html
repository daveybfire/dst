<!DOCTYPE html>
<html lang="en"> <!-- Default lang, will be updated by JS -->
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-WX8HLE4W5Q"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-WX8HLE4W5Q');
    </script>
    <meta charset="utf-8"/>
    <title>Digital Skills Assessment</title> <!-- Will be updated by JS -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
    <!-- resources.js is NOT loaded here by default anymore. It will be loaded dynamically -->

    <style>
        /* CSS STYLES (as provided by you, unchanged) - OMITTED FOR BREVITY */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; margin: 0; padding: 0; color: #333; }
        .container { max-width: 800px; width: 90%; margin: 20px auto; background: #fff; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); border-radius: 10px; padding: 20px 30px; padding-top: 10px; }
        h1, h2, h3 { font-size: 28px; margin: 20px 0; color: #2c3e50; }
        h4 { font-size: 22px; margin-bottom: 10px; color: #2c3e50; }
        p { margin: 10px 0 20px; font-size: 16px; color: #555; line-height: 1.6; }
        .progress-bar-container { width: 100%; background: #e0e0e0; border-radius: 10px; height: 20px; margin: 20px 0; overflow: hidden; position: relative; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, #0f777b, #4caf50); width: 0; transition: width 0.4s ease; }
        .progress-label { position: absolute; width: 100%; text-align: center; top: 0; font-size: 14px; color: #000; line-height: 20px; }
        .competency-banner { font-weight: bold; background: #0f777b; color: #fff; padding: 15px; border-radius: 5px; margin: 20px 0; font-size: 20px; }
        .question-container { background: #e0f7fa; border: 2px solid #0f777b; border-radius: 10px; padding: 15px; margin: 10px 0; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); min-height: 120px; text-align: center; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .question-container h2 { font-size: 24px; font-weight: bold; color: #333; margin: 0; line-height: 1.5; }
        .example { font-style: italic; color: #555; font-size: 16px; margin-top: 15px; }
        .proficiency-buttons { margin: 20px 0; display: flex; justify-content: space-between; flex-wrap: nowrap; }
        .proficiency-button { background: #e0e0e0; border: none; padding: 12px 10px; margin: 0 5px; border-radius: 5px; font-size: 14px; cursor: pointer; transition: background 0.3s ease, transform 0.1s ease; flex: 1; text-align: center; white-space: nowrap; }
        .proficiency-button:hover { background: #d5d5d5; }
        .proficiency-button.selected { background: #4caf50; color: white; transform: scale(1.05); }
        .no-selection-warning { color: red; font-size: 14px; margin-top: 10px; display: none; }
        .button { padding: 12px 25px; margin: 20px 0; background: #0f777b; color: #fff; border: none; border-radius: 5px; cursor: pointer; font-size: 18px; transition: background 0.3s ease; }
        .button:hover { background: #0a5e60; }
        .button:disabled { background: #ccc; cursor: not-allowed; }
        .hidden { display: none; }
        .summary-header { background: #e0f7fa; border: 1px solid #0f777b; border-radius: 10px; padding: 20px; margin-bottom: 30px; text-align: center; }
        .summary-header p { font-size: 18px; color: #2c3e50; margin: 10px 0; }
        .summary-header p span { font-weight: bold; }
        .key-characteristics { text-align: left; margin: 10px 0; padding: 10px; background: #f9f9f9; border-left: 4px solid #4caf50; border-radius: 5px; }
        .key-characteristics ul { list-style: none; padding-left: 0; }
        .key-characteristics li { margin-bottom: 10px; font-size: 16px; position: relative; padding-left: 25px; }
        .key-characteristics li::before { content: "✔"; position: absolute; left: 0; color: #4caf50; font-size: 18px; }
        .personalised-feedback { font-size: 16px; font-style: italic; color: #555; background: #fff; padding: 15px 20px; border-left: 4px solid #ff9800; margin: 20px 0; border-radius: 5px; text-align: left; }
        #competencyRadarChart { max-width: 100%; height: auto; }
        .chart-container { margin: 30px 0; }
        .card { background: #fff; border: 1px solid #e0e0e0; border-radius: 10px; padding: 20px; margin: 20px 0; text-align: left; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
        .card h4 { margin: 0 0 15px; color: #2c3e50; }
        .strengths .card { border-left: 4px solid #4caf50; }
        .growth-areas .card { border-left: 4px solid #f44336; }
        .smart-objectives .card { border-left: 4px solid #ff9800; }
        .section-title { font-size: 24px; margin-top: 40px; color: #2c3e50; text-align: left; padding-bottom: 10px; }
        .icon { font-size: 24px; vertical-align: middle; margin-right: 10px; }
        .thank-you { background: #e0f7fa; border: 1px solid #0f777b; border-radius: 10px; padding: 20px; margin: 30px 0; font-size: 18px; color: #2c3e50; text-align: center; }
        .thank-you p { font-size: 18px; font-weight: bold; }
        .thank-you a { color: #ffffff; background-color: #0f777b; padding: 10px 20px; border-radius: 5px; text-decoration: none; font-size: 16px; }
        .thank-you a:hover { background-color: #0a5e60; }
        @media (max-width: 600px) { .proficiency-button { flex: 1 1 100%; margin: 5px 0; } .container { padding: 15px 20px; } }
        .strengths { background: #e8f5e9; border: 2px solid #4caf50; border-radius: 10px; padding: 20px; margin: 30px 0; }
        .growth-areas { background: #ffebee; border: 2px solid #f44336; border-radius: 10px; padding: 20px; margin: 30px 0; }
        .smart-objectives { background: #fff3e0; border: 2px solid #ff9800; border-radius: 10px; padding: 20px; margin: 30px 0; }
        .strengths .section-title, .growth-areas .section-title, .smart-objectives .section-title { background: rgba(0,0,0,0.05); padding: 10px 15px; border-radius: 5px; margin: -20px -20px 20px -20px; }
        .strengths .card, .growth-areas .card, .smart-objectives .card { background: #fff; border-radius: 8px; padding: 15px; margin: 15px 0; }
        .dropdown .button { background: #0f777b; color: #fff; border: none; padding: 10px 15px; border-radius: 5px; font-size: 16px; cursor: pointer; margin-top: 10px; transition: background 0.3s ease; }
        .dropdown .button:hover { background: #0a5e60; }
        .dropdown-content { display: none; padding: 15px; margin-top: 10px; background: #f9f9f9; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; color: #333; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        #question-text-container { font-size: 18px; font-weight: bold; color: #2c3e50; line-height: 1.6; margin-bottom: 10px; text-align: center; }
        #example-text-container { font-size: 16px; font-style: italic; color: #555; line-height: 1.4; margin-top: 5px; margin-bottom: 0; text-align: center; }
        .chart-description { font-size: 16px; color: #555; margin-bottom: 20px; line-height: 1.5; text-align: center; }
        .qr-url { font-size: 12px; color: #e0e0e0; margin-top: 10px; word-wrap: break-word; }
        #language-selector-container { padding: 10px; text-align: right; background-color: #f8f9fa; border-bottom: 1px solid #e0e0e0; margin-bottom:15px; }
    </style>
</head>
<body>

<div id="language-selector-container">
    <label for="language-selector" id="language-selector-label" style="margin-right: 5px;">Language:</label>
    <select id="language-selector">
        <option value="en">English</option>
        <option value="es">Español (Test)</option>
        <option value="fr">Français (Test)</option>
        <option value="cs">Čeština (Test)</option>
        <option value="nl">Nederlands (Test)</option>
        <option value="de">Deutsch (Test)</option>
        <option value="hu">Magyar (Test)</option>
        <option value="it">Italiano (Test)</option>
        <option value="lv">Latviešu (Test)</option>
        <option value="lt">Lietuvių (Test)</option>
        <option value="ro">Română (Test)</option>
        <option value="sk">Slovenčina (Test)</option>
        <option value="tr">Türkçe (Test)</option>
        <option value="uk">Українська (Test)</option>
        <option value="zh-hans">中文 (简体) (Test)</option>
        <option value="zh-hant">中文 (繁體) (Test)</option>
        <option value="id">Bahasa Indonesia (Test)</option>
        <option value="th">ไทย (Test)</option>
        <option value="vi">Tiếng Việt (Test)</option>
    </select>
</div>

<!-- Start Screen, Assessment Screen, End Screen HTML structure remains the same -->
<!-- ... (Full HTML structure for screens) ... -->
<div class="container" id="start-screen">
    <h1 id="start-screen-title"></h1>
    <p id="start-screen-p1"></p>
    <p id="start-screen-p2"></p>
    <p id="start-screen-p3"></p>
    <p id="start-screen-p4"></p>
    <div style="text-align: center;">
        <button class="button" id="start-button" type="button"></button>
    </div>
</div>

<div class="container hidden" id="assessment-screen">
    <div class="competency-banner" id="competency-banner"></div>
    <div class="progress-bar-container">
        <div class="progress-bar" id="progress-bar"></div>
        <div class="progress-label" id="progress-label">0%</div>
    </div>
    <div class="question-container">
        <h2 id="question-text-container"></h2>
        <p class="example" id="example-text-container"></p>
    </div>
    <div class="proficiency-buttons"></div>
    <div class="no-selection-warning" id="no-selection-warning"></div>
    <div class="dropdown">
        <button class="button" id="toggle-proficiency-button" onclick="toggleDropdown(event)"></button>
        <div class="dropdown-content" id="proficiency-dropdown-content" style="display: block;">
        </div>
    </div>
</div>

<div class="container hidden" id="end-screen">
    <h2 id="end-screen-title"></h2>
    <div id="advanced-results">
        <div class="summary-header">
            <p style="font-size: 28px; font-weight: bold; color: #4caf50; margin: 10px 0;">
                <span id="total-score-advanced"></span>
            </p>
            <p style="font-size: 14px; color: #555; margin: 5px 0;">
                <span id="current-date-advanced"></span>
            </p>
            <div id="qr-code-container" style="text-align: center; margin-top: 20px;">
                <h3 id="qr-code-title"></h3>
                <canvas id="qr-code"></canvas>
                <p id="qr-code-instruction"></p>
            </div>
        </div>
        <div class="key-characteristics">
            <h3 id="key-char-title"></h3>
            <p id="key-char-intro"></p>
            <ul id="key-characteristics-advanced"></ul>
        </div>
        <div class="personalised-feedback" id="personalised-feedback-advanced"></div>
        <div class="chart-container">
            <h3 id="radar-chart-title"></h3>
            <p class="chart-description" id="radar-chart-desc"></p>
            <canvas id="competencyRadarChart"></canvas>
            <p id="radar-chart-legend"></p>
        </div>
        <div class="strengths">
            <h3 class="section-title" id="strengths-title"></h3>
            <p id="strengths-intro"></p>
            <div id="strengths"></div>
        </div>
        <div class="growth-areas">
            <h3 class="section-title" id="growth-areas-title"></h3>
            <p id="growth-areas-intro"></p>
            <div id="growth-areas"></div>
        </div>
        <div class="smart-objectives">
            <h3 class="section-title" id="smart-objectives-title"></h3>
            <p id="smart-objectives-intro"></p>
            <div id="smart-objectives"></div>
        </div>
        <div class="thank-you">
            <span id="thank-you-message"></span>
            <div id="survey-link" style="text-align: center; margin-top: 20px;">
                <p id="survey-prompt"></p>
                <a href="https://forms.office.com/Pages/ResponsePage.aspx?id=-QiCXGC1CUmQO1pcxbHUWnL9uYyvyttIoQ6Huyhcv7tUOUM4QU05UTUxUUhFS0dIOU5SM0pXUVdaQy4u"
                   target="_blank"
                   id="survey-button"
                   style="color: #ffffff; background-color: #0f777b; padding: 10px 20px; border-radius: 5px; text-decoration: none; font-size: 16px;">
                </a>
            </div>
        </div>
    </div>
    <div style="text-align: center;">
        <button class="button" id="restart-button" type="button"></button>
        <div style="text-align: center; margin-top: 10px;">
            <p id="qr-url" class="qr-url"></p>
        </div>
    </div>
</div>

<script>
    // Global variables
    let i18nData = {};
    let currentLanguage = 'en'; // Stores the selected language e.g. "en", "es"
    let currentBU = null; // Stores the current BU e.g. "superdrug"
    let currentVariantIdentifier = 'en'; // Stores the final identifier e.g. "en", "en-superdrug"

    let questionsData = [];
    let competenciesData = [];
    let overallProficiencyLevelsData = [];
    const answers = { Knowledge: [], Skills: [], Attitudes: [] };
    let currentIndex = 0;
    let radarChart;

    // DOM Element Grabbers
    let startScreen, assessmentScreen, endScreen, progressBar, progressLabel, competencyBanner,
        questionTextContainer, exampleTextContainer, proficiencyButtonsNodeList, noSelectionWarningEl,
        strengthsContainer, growthAreasContainer, smartObjectivesContainer,
        restartButton, startButton, langSelectorElement;

    function assignDOMelements() {
        startScreen = document.getElementById("start-screen");
        assessmentScreen = document.getElementById("assessment-screen");
        endScreen = document.getElementById("end-screen");
        // ... (all other element assignments as before) ...
        progressBar = document.getElementById("progress-bar");
        progressLabel = document.getElementById("progress-label");
        competencyBanner = document.getElementById("competency-banner");
        questionTextContainer = document.getElementById("question-text-container");
        exampleTextContainer = document.getElementById("example-text-container");
        noSelectionWarningEl = document.getElementById("no-selection-warning");
        strengthsContainer = document.getElementById("strengths");
        growthAreasContainer = document.getElementById("growth-areas");
        smartObjectivesContainer = document.getElementById("smart-objectives");
        restartButton = document.getElementById("restart-button");
        startButton = document.getElementById("start-button");
        langSelectorElement = document.getElementById('language-selector');
    }

    function setText(id, text) { const el = document.getElementById(id); if (el) el.textContent = text; }
    function setHTML(id, html) { const el = document.getElementById(id); if (el) el.innerHTML = html; }

    function t(key, replacements = {}) { /* ... Same robust t() function ... */ 
        if (typeof i18nData !== 'object' || i18nData === null) return `MISSING_I18NDATA: ${key}`;
        let textValue = i18nData;
        const parts = key.split('.');
        for (let i = 0; i < parts.length; i++) {
            const part = parts[i];
            if (textValue && typeof textValue === 'object' && Object.prototype.hasOwnProperty.call(textValue, part)) {
                textValue = textValue[part];
            } else { return `MISSING_TRANSLATION: ${key}`; }
        }
        if (typeof textValue !== 'string') return `INVALID_TRANSLATION_TYPE: ${key}`;
        let finalText = textValue;
        for (const placeholder in replacements) {
            finalText = finalText.replace(new RegExp(`{${placeholder}}`, 'g'), replacements[placeholder]);
        }
        return finalText;
    }

    async function loadAndApplyVariant(variantId) {
        console.log(`loadAndApplyVariant CALLED for effective variant: ${variantId}`);
        let textJsonToLoad = `${variantId}.json`;
        let resourcesJsToLoad = `resources-${variantId}.js`;
        let primaryLangForFallback = variantId.split('-')[0]; // e.g., "en" from "en-superdrug"
        let successLoadingText = false;
        let successLoadingResources = false;

        // 1. Attempt to load Text JSON
        try {
            let response = await fetch(`${textJsonToLoad}?v=${new Date().getTime()}`);
            if (!response.ok) { // Try primary language if variant fails (e.g., en-superdrug.json fails, try en.json)
                if (variantId !== primaryLangForFallback) { // Only if different
                    console.warn(`Could not load ${textJsonToLoad}. Attempting primary language fallback: ${primaryLangForFallback}.json`);
                    textJsonToLoad = `${primaryLangForFallback}.json`;
                    response = await fetch(`${textJsonToLoad}?v=${new Date().getTime()}`);
                }
                if (!response.ok) { // If primary also fails (or was 'en' initially), try 'en.json' as ultimate fallback for text
                    console.warn(`Could not load ${textJsonToLoad}. Falling back to en.json for text.`);
                    if (textJsonToLoad.startsWith('en') && variantId !== 'en') throw new Error(`Failed to load primary ${textJsonToLoad} after variant failed.`);
                    textJsonToLoad = 'en.json';
                    response = await fetch(`${textJsonToLoad}?v=${new Date().getTime()}`);
                    if (!response.ok) throw new Error('CRITICAL: Failed to load en.json as text fallback.');
                }
            }
            i18nData = await response.json();
            currentVariantIdentifier = textJsonToLoad.replace('.json', ''); // Reflect what was actually loaded
            successLoadingText = true;
            console.log('Successfully loaded Text JSON for:', currentVariantIdentifier);
        } catch (error) {
            console.error("Fatal error loading text JSON file:", error);
            document.body.innerHTML = `<div style="text-align:center;padding:20px;"><h1>Error</h1><p>Could not load language text resources.</p><p><em>${error.message}</em></p></div>`;
            return; // Stop further execution
        }

        // 2. Dynamically Load Resources JS
        const oldResourcesScript = document.getElementById('dynamic-resources-script');
        if (oldResourcesScript) oldResourcesScript.remove();
        window.customResources = []; // Clear/reset

        const resourcesScript = document.createElement('script');
        resourcesScript.id = 'dynamic-resources-script';
        
        const loadScript = (src) => {
            return new Promise((resolve, reject) => {
                resourcesScript.src = `${src}?v=${new Date().getTime()}`;
                resourcesScript.onload = () => { console.log(`Resources loaded from ${src}`); successLoadingResources = true; resolve(); };
                resourcesScript.onerror = () => { console.warn(`Could not load ${src}`); reject(new Error(`Failed to load ${src}`)); };
                document.head.appendChild(resourcesScript.cloneNode(false)); // Use false to not deep clone if not needed
            });
        };

        try {
            await loadScript(resourcesJsToLoad);
        } catch (error) {
            if (variantId !== primaryLangForFallback) { // Try primary lang resources
                try {
                    console.log(`Attempting fallback for resources: resources-${primaryLangForFallback}.js`);
                    await loadScript(`resources-${primaryLangForFallback}.js`);
                } catch (error2) {
                    if (primaryLangForFallback !== 'en') { // Try 'en' resources
                         try {
                            console.log(`Attempting fallback for resources: resources-en.js`);
                            await loadScript('resources-en.js');
                         } catch (error3) {
                            console.error("CRITICAL: Failed to load resources-en.js as final fallback.");
                         }
                    } else {
                        console.error(`CRITICAL: Failed to load resources-${primaryLangForFallback}.js (primary was en or already tried en).`);
                    }
                }
            } else if (variantId !== 'en') { // Was primary lang but not 'en', try 'en'
                 try {
                    console.log(`Attempting fallback for resources: resources-en.js`);
                    await loadScript('resources-en.js');
                 } catch (error3) {
                    console.error("CRITICAL: Failed to load resources-en.js as final fallback.");
                 }
            } else {
                console.error(`CRITICAL: Failed to load initial resources script ${resourcesJsToLoad} (was en or no other fallback).`);
            }
        }
        if (!successLoadingResources) window.customResources = []; // Ensure it's empty if all attempts failed

        // 3. Populate data and apply translations
        document.documentElement.lang = i18nData.lang || currentVariantIdentifier.split('-')[0];
        document.title = t('appTitle');
        questionsData = i18nData.questions || [];
        competenciesData = i18nData.competencyList || [];
        overallProficiencyLevelsData = i18nData.overallProficiencyLevels || [];
        if (competenciesData && competenciesData.length > 0) {
            const numCompetencies = competenciesData.length;
            answers.Knowledge = Array(numCompetencies).fill(0);
            answers.Skills = Array(numCompetencies).fill(0);
            answers.Attitudes = Array(numCompetencies).fill(0);
        }
        applyTranslations();
        updateLanguageSelectorValue(currentLanguage); // Update dropdown to reflect base language
        localStorage.setItem('selectedUserLanguage', currentLanguage); // Store base language
        if (currentBU) localStorage.setItem('selectedUserBU', currentBU); else localStorage.removeItem('selectedUserBU');
        console.log(`${currentVariantIdentifier.toUpperCase()} variant files applied successfully.`);
    }
    
    function updateLanguageSelectorValue(langCode) {
        if (!langSelectorElement) return;
        langSelectorElement.value = langCode; // langCode is "en", "es" etc.
        const label = document.getElementById('language-selector-label');
        if (label) {
            const labelText = t('misc.languageLabel');
            label.textContent = labelText.startsWith('MISSING_') ? 'Language:' : labelText;
        }
    }

    // --- applyTranslations and all other functions (renderQuestion, showResults, etc.) are assumed to be the working versions ---
    // --- from your last complete code that correctly displayed dimensions. I will include the core logic. ---
    // (Make sure to paste the full set of your working functions here)
    function applyTranslations() { /* ... Same as your last working version ... */ }
    function constructRadarLegend() { /* ... Same ... */ }
    function populateProficiencyButtons() { /* ... Same ... */ }
    function getCompetencyNameByKey(key) { /* ... Same ... */ }
    function renderQuestion(index) { /* ... Same ... */ }
    function attachEventListeners() { /* ... Same ... */ }
    function showResults() { /* ... Same ... */ }
    function encodeResponses() { /* ... Same ... */ }
    function decodeAndLoadResults() { /* ... Same ... */ }
    function displayKeyCharacteristics(characteristics) { /* ... Same ... */ }
    function generateResultsPageContent() { /* ... Same ... */ }
    function getStrongestDimension(comp) { /* ... Same ... */ }
    function getWeakestDimension(comp) { /* ... Same ... */ }
    function getFeedbackForCompetency(competencyKey, dimension) { /* ... Same ... */ }
    function getGrowthFeedbackForCompetency(competencyKey, dimension) { /* ... Same ... */ }
    function getSmartObjective(competencyKey, dimension) { /* ... Same ... */ }
    function generateStrengths(topCompetencies) { /* ... Same, ensure it uses window.customResources ... */ }
    function generateGrowthAreas(bottomCompetencies) { /* ... Same ... */ }
    function generateSmartObjectives(bottomCompetencies) { /* ... Updated to use window.customResources, and comp.name (translated) for matching ... */
        if (!smartObjectivesContainer) { return; }
        smartObjectivesContainer.innerHTML = '';
        bottomCompetencies.forEach(comp => {
            const weakestDimension = getWeakestDimension(comp);
            const competencyNameDisplay = comp.name; // This is the (potentially) translated name for display
            const growthLabel = t('endScreen.growthAreaLabel');
            const smartObjectiveLabel = t('endScreen.smartObjectiveLabel');
            const translatedDimensionNameForSMART = t(`endScreen.radarChartLegend${weakestDimension}`);
            const smartObjectiveText = getSmartObjective(comp.key, weakestDimension);
            const userLevel = comp[`${weakestDimension.toLowerCase()}Score`];
            let levelsToShow = userLevel ? (userLevel === 1 ? [1,2,3] : (userLevel === 5 ? [3,4,5] : [userLevel-1, userLevel, userLevel+1].filter(l=>l>=1 && l<=5))) : [1,2,3];
            
            // For resource lookup, we use comp.name because resources-[variant].js
            // should have competency names matching the [variant].json
            const competencyForResourceLookup = comp.name; 

            const filteredResources = (window.customResources || []).filter(r => {
                return r.competency === competencyForResourceLookup && r.level === weakestDimension.toLowerCase();
            });
            const chosenResources = filteredResources.filter(r => levelsToShow.includes(r.rating)).slice(0, 3);
            
            let resourcesHTML = '';
            if (chosenResources.length > 0) {
                resourcesHTML = `<h5>${t('endScreen.recommendedResourcesLabel')}</h5><ul style="list-style:none; padding:0; margin:10px 0;">
                        ${chosenResources.map(r => `<li><a href="${r.URL}" target="_blank" style="text-decoration:none; color:#0f777b;"><strong>${r.title}</strong>: ${r.description}</a></li>`).join('')}</ul>`;
            }
            smartObjectivesContainer.innerHTML += `<div class="smart-item card"><h4>${competencyNameDisplay}</h4><p><strong>${growthLabel}</strong> ${translatedDimensionNameForSMART}</p><p><strong>${smartObjectiveLabel}</strong> ${smartObjectiveText}</p>${resourcesHTML}</div>`;
        });
    }
    function generateRadarChart() { /* ... Same ... */ }
    function updateQRCodeURL(data) { /* ... Same ... */ }
    function generateQRCode(data, canvasId) { /* ... Same ... */ }
    function toggleDropdown(event) { /* ... Same ... */ }

    function addEventListenersToDOM() { 
        if (restartButton) {
            restartButton.addEventListener("click", () => {
                currentIndex = 0;
                if (competenciesData && competenciesData.length > 0) {
                    const numCompetencies = competenciesData.length;
                    answers.Knowledge = Array(numCompetencies).fill(0);
                    answers.Skills = Array(numCompetencies).fill(0);
                    answers.Attitudes = Array(numCompetencies).fill(0);
                }
                if(endScreen) endScreen.classList.add("hidden");
                if(assessmentScreen) assessmentScreen.classList.add("hidden");
                if(startScreen) startScreen.classList.remove("hidden");
                if (radarChart) { radarChart.destroy(); radarChart = null; }
                const qrCodeCanvas = document.getElementById('qr-code');
                if (qrCodeCanvas && qrCodeCanvas.getContext) qrCodeCanvas.getContext('2d').clearRect(0, 0, qrCodeCanvas.width, qrCodeCanvas.height);
                setText('qr-url', '');
                if(strengthsContainer) strengthsContainer.innerHTML = '';
                if(growthAreasContainer) growthAreasContainer.innerHTML = '';
                if(smartObjectivesContainer) smartObjectivesContainer.innerHTML = '';
                applyTranslations(); // Re-apply to ensure start screen is correct
            });
        }

        if (startButton) {
            startButton.addEventListener("click", () => {
                if(startScreen) startScreen.classList.add("hidden");
                if(assessmentScreen) assessmentScreen.classList.remove("hidden");
                if (competenciesData && competenciesData.length > 0) {
                    const numCompetencies = competenciesData.length;
                    answers.Knowledge = Array(numCompetencies).fill(0);
                    answers.Skills = Array(numCompetencies).fill(0);
                    answers.Attitudes = Array(numCompetencies).fill(0);
                    currentIndex = 0; 
                    renderQuestion(currentIndex);
                } else {
                    console.error("Cannot start assessment, competencies data not loaded.");
                }
            });
        }

        if (langSelectorElement) {
            langSelectorElement.addEventListener('change', async (event) => {
                const newLang = event.target.value; // This is "en", "es", etc.
                console.log(`Language dropdown changed to: ${newLang}. Current BU: ${currentBU}`);
                currentLanguage = newLang; // Update global current language
                
                let variantToLoad = currentLanguage;
                if (currentBU) {
                    variantToLoad = `${currentLanguage}-${currentBU}`;
                }
                await loadVariantFiles(variantToLoad); 

                if (startScreen && !startScreen.classList.contains('hidden') && 
                    assessmentScreen && assessmentScreen.classList.contains('hidden') && 
                    endScreen && endScreen.classList.contains('hidden')) {
                    // On start screen, fine
                } else { 
                    if (restartButton) restartButton.click(); 
                }
            });
        }
    }
    
    async function initializeApp() {
        console.log("initializeApp CALLED");
        assignDOMelements(); 
        addEventListenersToDOM(); 

        const urlParams = new URLSearchParams(window.location.search);
        currentBU = urlParams.get('bu'); // Store BU globally if present e.g. "superdrug"
        if(currentBU) currentBU = currentBU.toLowerCase();

        let storedLang = localStorage.getItem('selectedUserLanguage');
        let browserLang = navigator.language || navigator.userLanguage;
        let initialLang = storedLang || browserLang.split('-')[0] || 'en';

        // Handle specific Chinese variants from browser/storage for initial load correctly
        const fullStoredOrBrowserLang = storedLang || browserLang;
        if (fullStoredOrBrowserLang.toLowerCase().startsWith('zh-hans') || fullStoredOrBrowserLang.toLowerCase() === 'zh-cn' || fullStoredOrBrowserLang.toLowerCase() === 'zh-sg') initialLang = 'zh-hans';
        else if (fullStoredOrBrowserLang.toLowerCase().startsWith('zh-hant') || fullStoredOrBrowserLang.toLowerCase() === 'zh-tw' || fullStoredOrBrowserLang.toLowerCase() === 'zh-hk') initialLang = 'zh-hant';
        else initialLang = initialLang.split('-')[0]; // get primary code like 'en', 'es'
        
        currentLanguage = initialLang; // Set global currentLanguage

        let variantToLoad = currentLanguage;
        if (currentBU) {
            variantToLoad = `${currentLanguage}-${currentBU}`;
            console.log(`BU parameter found: '${currentBU}'. Attempting initial variant: '${variantToLoad}'`);
        } else {
            console.log(`No BU parameter. Initial language: '${currentLanguage}'`);
        }
        
        await loadVariantFiles(variantToLoad); 
        
        decodeAndLoadResults(); 
        console.log("initializeApp COMPLETED");
    }

    document.addEventListener('DOMContentLoaded', initializeApp);

</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en"> <!-- Default lang, will be updated by JS -->
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-WX8HLE4W5Q"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-WX8HLE4W5Q');
    </script>
    <meta charset="utf-8"/>
    <title>Digital Skills Assessment</title> <!-- Will be updated by JS -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
    <!-- resources.js is NOT loaded here by default anymore. It will be loaded dynamically -->

    <style>
        /* CSS STYLES (as provided by you, unchanged) */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; margin: 0; padding: 0; color: #333; }
        .container { max-width: 800px; width: 90%; margin: 20px auto; background: #fff; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); border-radius: 10px; padding: 20px 30px; padding-top: 10px; }
        h1, h2, h3 { font-size: 28px; margin: 20px 0; color: #2c3e50; }
        h4 { font-size: 22px; margin-bottom: 10px; color: #2c3e50; }
        p { margin: 10px 0 20px; font-size: 16px; color: #555; line-height: 1.6; }
        .progress-bar-container { width: 100%; background: #e0e0e0; border-radius: 10px; height: 20px; margin: 20px 0; overflow: hidden; position: relative; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, #0f777b, #4caf50); width: 0; transition: width 0.4s ease; }
        .progress-label { position: absolute; width: 100%; text-align: center; top: 0; font-size: 14px; color: #000; line-height: 20px; }
        .competency-banner { font-weight: bold; background: #0f777b; color: #fff; padding: 15px; border-radius: 5px; margin: 20px 0; font-size: 20px; }
        .question-container { background: #e0f7fa; border: 2px solid #0f777b; border-radius: 10px; padding: 15px; margin: 10px 0; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); min-height: 120px; text-align: center; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .question-container h2 { font-size: 24px; font-weight: bold; color: #333; margin: 0; line-height: 1.5; }
        .example { font-style: italic; color: #555; font-size: 16px; margin-top: 15px; }
        .proficiency-buttons { margin: 20px 0; display: flex; justify-content: space-between; flex-wrap: nowrap; }
        .proficiency-button { background: #e0e0e0; border: none; padding: 12px 10px; margin: 0 5px; border-radius: 5px; font-size: 14px; cursor: pointer; transition: background 0.3s ease, transform 0.1s ease; flex: 1; text-align: center; white-space: nowrap; }
        .proficiency-button:hover { background: #d5d5d5; }
        .proficiency-button.selected { background: #4caf50; color: white; transform: scale(1.05); }
        .no-selection-warning { color: red; font-size: 14px; margin-top: 10px; display: none; }
        .button { padding: 12px 25px; margin: 20px 0; background: #0f777b; color: #fff; border: none; border-radius: 5px; cursor: pointer; font-size: 18px; transition: background 0.3s ease; }
        .button:hover { background: #0a5e60; }
        .button:disabled { background: #ccc; cursor: not-allowed; }
        .hidden { display: none; }
        .summary-header { background: #e0f7fa; border: 1px solid #0f777b; border-radius: 10px; padding: 20px; margin-bottom: 30px; text-align: center; }
        .summary-header p { font-size: 18px; color: #2c3e50; margin: 10px 0; }
        .summary-header p span { font-weight: bold; }
        .key-characteristics { text-align: left; margin: 10px 0; padding: 10px; background: #f9f9f9; border-left: 4px solid #4caf50; border-radius: 5px; }
        .key-characteristics ul { list-style: none; padding-left: 0; }
        .key-characteristics li { margin-bottom: 10px; font-size: 16px; position: relative; padding-left: 25px; }
        .key-characteristics li::before { content: "✔"; position: absolute; left: 0; color: #4caf50; font-size: 18px; }
        .personalised-feedback { font-size: 16px; font-style: italic; color: #555; background: #fff; padding: 15px 20px; border-left: 4px solid #ff9800; margin: 20px 0; border-radius: 5px; text-align: left; }
        #competencyRadarChart { max-width: 100%; height: auto; }
        .chart-container { margin: 30px 0; }
        .card { background: #fff; border: 1px solid #e0e0e0; border-radius: 10px; padding: 20px; margin: 20px 0; text-align: left; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
        .card h4 { margin: 0 0 15px; color: #2c3e50; }
        .strengths .card { border-left: 4px solid #4caf50; }
        .growth-areas .card { border-left: 4px solid #f44336; }
        .smart-objectives .card { border-left: 4px solid #ff9800; }
        .section-title { font-size: 24px; margin-top: 40px; color: #2c3e50; text-align: left; padding-bottom: 10px; }
        .icon { font-size: 24px; vertical-align: middle; margin-right: 10px; }
        .thank-you { background: #e0f7fa; border: 1px solid #0f777b; border-radius: 10px; padding: 20px; margin: 30px 0; font-size: 18px; color: #2c3e50; text-align: center; }
        .thank-you p { font-size: 18px; font-weight: bold; }
        .thank-you a { color: #ffffff; background-color: #0f777b; padding: 10px 20px; border-radius: 5px; text-decoration: none; font-size: 16px; }
        .thank-you a:hover { background-color: #0a5e60; }
        @media (max-width: 600px) { .proficiency-button { flex: 1 1 100%; margin: 5px 0; } .container { padding: 15px 20px; } }
        .strengths { background: #e8f5e9; border: 2px solid #4caf50; border-radius: 10px; padding: 20px; margin: 30px 0; }
        .growth-areas { background: #ffebee; border: 2px solid #f44336; border-radius: 10px; padding: 20px; margin: 30px 0; }
        .smart-objectives { background: #fff3e0; border: 2px solid #ff9800; border-radius: 10px; padding: 20px; margin: 30px 0; }
        .strengths .section-title, .growth-areas .section-title, .smart-objectives .section-title { background: rgba(0,0,0,0.05); padding: 10px 15px; border-radius: 5px; margin: -20px -20px 20px -20px; }
        .strengths .card, .growth-areas .card, .smart-objectives .card { background: #fff; border-radius: 8px; padding: 15px; margin: 15px 0; }
        .dropdown .button { background: #0f777b; color: #fff; border: none; padding: 10px 15px; border-radius: 5px; font-size: 16px; cursor: pointer; margin-top: 10px; transition: background 0.3s ease; }
        .dropdown .button:hover { background: #0a5e60; }
        .dropdown-content { display: none; padding: 15px; margin-top: 10px; background: #f9f9f9; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; color: #333; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        #question-text-container { font-size: 18px; font-weight: bold; color: #2c3e50; line-height: 1.6; margin-bottom: 10px; text-align: center; }
        #example-text-container { font-size: 16px; font-style: italic; color: #555; line-height: 1.4; margin-top: 5px; margin-bottom: 0; text-align: center; }
        .chart-description { font-size: 16px; color: #555; margin-bottom: 20px; line-height: 1.5; text-align: center; }
        .qr-url { font-size: 12px; color: #e0e0e0; margin-top: 10px; word-wrap: break-word; }
        #language-selector-container { padding: 10px; text-align: right; background-color: #f8f9fa; border-bottom: 1px solid #e0e0e0; margin-bottom:15px; }
    </style>
</head>
<body>

<div id="language-selector-container">
    <label for="language-selector" id="language-selector-label" style="margin-right: 5px;">Language:</label>
    <select id="language-selector">
        <option value="en">English</option>
        <option value="es">Español (Test)</option>
        <option value="fr">Français (Test)</option>
        <option value="cs">Čeština (Test)</option>
        <option value="nl">Nederlands (Test)</option>
        <option value="de">Deutsch (Test)</option>
        <option value="hu">Magyar (Test)</option>
        <option value="it">Italiano (Test)</option>
        <option value="lv">Latviešu (Test)</option>
        <option value="lt">Lietuvių (Test)</option>
        <option value="ro">Română (Test)</option>
        <option value="sk">Slovenčina (Test)</option>
        <option value="tr">Türkçe (Test)</option>
        <option value="uk">Українська (Test)</option>
        <option value="zh-hans">中文 (简体) (Test)</option>
        <option value="zh-hant">中文 (繁體) (Test)</option>
        <option value="id">Bahasa Indonesia (Test)</option>
        <option value="th">ไทย (Test)</option>
        <option value="vi">Tiếng Việt (Test)</option>
    </select>
</div>

<!-- Start Screen, Assessment Screen, End Screen HTML structure remains the same -->
<div class="container" id="start-screen">
    <h1 id="start-screen-title"></h1>
    <p id="start-screen-p1"></p>
    <p id="start-screen-p2"></p>
    <p id="start-screen-p3"></p>
    <p id="start-screen-p4"></p>
    <div style="text-align: center;">
        <button class="button" id="start-button" type="button"></button>
    </div>
</div>

<div class="container hidden" id="assessment-screen">
    <div class="competency-banner" id="competency-banner"></div>
    <div class="progress-bar-container">
        <div class="progress-bar" id="progress-bar"></div>
        <div class="progress-label" id="progress-label">0%</div>
    </div>
    <div class="question-container">
        <h2 id="question-text-container"></h2>
        <p class="example" id="example-text-container"></p>
    </div>
    <div class="proficiency-buttons"></div>
    <div class="no-selection-warning" id="no-selection-warning"></div>
    <div class="dropdown">
        <button class="button" id="toggle-proficiency-button" onclick="toggleDropdown(event)"></button>
        <div class="dropdown-content" id="proficiency-dropdown-content" style="display: block;">
        </div>
    </div>
</div>

<div class="container hidden" id="end-screen">
    <h2 id="end-screen-title"></h2>
    <div id="advanced-results">
        <div class="summary-header">
            <p style="font-size: 28px; font-weight: bold; color: #4caf50; margin: 10px 0;">
                <span id="total-score-advanced"></span>
            </p>
            <p style="font-size: 14px; color: #555; margin: 5px 0;">
                <span id="current-date-advanced"></span>
            </p>
            <div id="qr-code-container" style="text-align: center; margin-top: 20px;">
                <h3 id="qr-code-title"></h3>
                <canvas id="qr-code"></canvas>
                <p id="qr-code-instruction"></p>
            </div>
        </div>
        <div class="key-characteristics">
            <h3 id="key-char-title"></h3>
            <p id="key-char-intro"></p>
            <ul id="key-characteristics-advanced"></ul>
        </div>
        <div class="personalised-feedback" id="personalised-feedback-advanced"></div>
        <div class="chart-container">
            <h3 id="radar-chart-title"></h3>
            <p class="chart-description" id="radar-chart-desc"></p>
            <canvas id="competencyRadarChart"></canvas>
            <p id="radar-chart-legend"></p>
        </div>
        <div class="strengths">
            <h3 class="section-title" id="strengths-title"></h3>
            <p id="strengths-intro"></p>
            <div id="strengths"></div>
        </div>
        <div class="growth-areas">
            <h3 class="section-title" id="growth-areas-title"></h3>
            <p id="growth-areas-intro"></p>
            <div id="growth-areas"></div>
        </div>
        <div class="smart-objectives">
            <h3 class="section-title" id="smart-objectives-title"></h3>
            <p id="smart-objectives-intro"></p>
            <div id="smart-objectives"></div>
        </div>
        <div class="thank-you">
            <span id="thank-you-message"></span>
            <div id="survey-link" style="text-align: center; margin-top: 20px;">
                <p id="survey-prompt"></p>
                <a href="https://forms.office.com/Pages/ResponsePage.aspx?id=-QiCXGC1CUmQO1pcxbHUWnL9uYyvyttIoQ6Huyhcv7tUOUM4QU05UTUxUUhFS0dIOU5SM0pXUVdaQy4u"
                   target="_blank"
                   id="survey-button"
                   style="color: #ffffff; background-color: #0f777b; padding: 10px 20px; border-radius: 5px; text-decoration: none; font-size: 16px;">
                </a>
            </div>
        </div>
    </div>
    <div style="text-align: center;">
        <button class="button" id="restart-button" type="button"></button>
        <div style="text-align: center; margin-top: 10px;">
            <p id="qr-url" class="qr-url"></p>
        </div>
    </div>
</div>

<script>
    // --- START OF SCRIPT ---

    // --- FUNCTION DEFINITIONS (Order Matters: Define all functions before they are called) ---

    function assignDOMelements() {
        // console.log("assignDOMelements CALLED"); // Uncomment for debug
        startScreen = document.getElementById("start-screen");
        assessmentScreen = document.getElementById("assessment-screen");
        endScreen = document.getElementById("end-screen");
        progressBar = document.getElementById("progress-bar");
        progressLabel = document.getElementById("progress-label");
        competencyBanner = document.getElementById("competency-banner");
        questionTextContainer = document.getElementById("question-text-container");
        exampleTextContainer = document.getElementById("example-text-container");
        noSelectionWarningEl = document.getElementById("no-selection-warning");
        strengthsContainer = document.getElementById("strengths");
        growthAreasContainer = document.getElementById("growth-areas");
        smartObjectivesContainer = document.getElementById("smart-objectives");
        restartButton = document.getElementById("restart-button");
        startButton = document.getElementById("start-button");
        langSelectorElement = document.getElementById('language-selector');
        // console.log("assignDOMelements FINISHED. Start button:", startButton, "Restart button:", restartButton, "Lang selector:", langSelectorElement); // Uncomment for debug
    }

    function setText(id, text) { 
        const el = document.getElementById(id); 
        if (el) {
            el.textContent = text;
        } else {
            // console.warn(`Element with ID '${id}' not found for setText.`); // Uncomment for debug
        }
    }

    function setHTML(id, html) { 
        const el = document.getElementById(id); 
        if (el) {
            el.innerHTML = html;
        } else {
            // console.warn(`Element with ID '${id}' not found for setHTML.`); // Uncomment for debug
        }
    }

    function t(key, replacements = {}) { 
        if (typeof i18nData !== 'object' || i18nData === null) return `MISSING_I18NDATA: ${key}`;
        let textValue = i18nData;
        const parts = key.split('.');
        for (let i = 0; i < parts.length; i++) {
            const part = parts[i];
            if (textValue && typeof textValue === 'object' && Object.prototype.hasOwnProperty.call(textValue, part)) {
                textValue = textValue[part];
            } else { return `MISSING_TRANSLATION: ${key}`; }
        }
        if (typeof textValue !== 'string') return `INVALID_TRANSLATION_TYPE: ${key}`;
        let finalText = textValue;
        for (const placeholder in replacements) {
            finalText = finalText.replace(new RegExp(`{${placeholder}}`, 'g'), replacements[placeholder]);
        }
        return finalText;
    }
    
    async function loadVariantFiles(variantId) {
        console.log(`loadVariantFiles CALLED for effective variant: ${variantId}`);
        let textJsonToLoad = `${variantId}.json`;
        let resourcesJsToLoad = `resources-${variantId}.js`;
        let primaryLangForFallback = variantId.split('-')[0]; 
        let successLoadingText = false;
        let successLoadingResources = false;

        try {
            let response = await fetch(`${textJsonToLoad}?v=${new Date().getTime()}`);
            if (!response.ok) {
                if (variantId !== primaryLangForFallback && primaryLangForFallback) {
                    console.warn(`Could not load ${textJsonToLoad}. Attempting primary language fallback: ${primaryLangForFallback}.json`);
                    textJsonToLoad = `${primaryLangForFallback}.json`;
                    response = await fetch(`${textJsonToLoad}?v=${new Date().getTime()}`);
                }
                if (!response.ok) { 
                    console.warn(`Could not load ${textJsonToLoad}. Falling back to en.json for text.`);
                    if (textJsonToLoad.startsWith('en') && variantId !== 'en' && primaryLangForFallback !== 'en') {}
                    else if (textJsonToLoad === 'en.json' || textJsonToLoad === 'en') { throw new Error('CRITICAL: Failed to load en.json for text.'); }
                    
                    textJsonToLoad = 'en.json';
                    response = await fetch(`${textJsonToLoad}?v=${new Date().getTime()}`);
                    if (!response.ok) throw new Error('CRITICAL: Failed to load en.json as ultimate text fallback.');
                }
            }
            i18nData = await response.json();
            currentVariantIdentifier = textJsonToLoad.replace('.json', ''); 
            successLoadingText = true;
            console.log('Successfully loaded Text JSON for:', currentVariantIdentifier); 
        } catch (error) {
            console.error("Fatal error loading text JSON file:", error);
            document.body.innerHTML = `<div style="text-align:center;padding:20px;"><h1>Error</h1><p>Could not load language text resources.</p><p><em>${error.message}</em></p></div>`;
            return; 
        }

        const oldResourcesScript = document.getElementById('dynamic-resources-script');
        if (oldResourcesScript) oldResourcesScript.remove();
        window.customResources = []; 

        const resourcesScript = document.createElement('script');
        resourcesScript.id = 'dynamic-resources-script';
        
        const loadScript = (src) => {
            return new Promise((resolve, reject) => {
                const scriptToLoad = document.createElement('script'); 
                scriptToLoad.id = 'dynamic-resources-script'; 
                scriptToLoad.src = `${src}?v=${new Date().getTime()}`;
                scriptToLoad.onload = () => { console.log(`Resources loaded from ${src}`); successLoadingResources = true; resolve(); };
                scriptToLoad.onerror = () => { console.warn(`Could not load ${src}`); reject(new Error(`Failed to load ${src}`)); };
                document.head.appendChild(scriptToLoad);
            });
        };

        try {
            await loadScript(resourcesJsToLoad);
        } catch (error) {
            let triedPrimary = false;
            if (variantId !== primaryLangForFallback && primaryLangForFallback) {
                triedPrimary = true;
                try {
                    console.log(`Attempting fallback for resources: resources-${primaryLangForFallback}.js`);
                    await loadScript(`resources-${primaryLangForFallback}.js`);
                } catch (error2) { /* Fall through */ }
            }
            if (!successLoadingResources && (primaryLangForFallback !== 'en' || !triedPrimary ) && variantId !== 'en' ) {
                 try {
                    console.log(`Attempting fallback for resources: resources-en.js`);
                    await loadScript('resources-en.js');
                 } catch (error3) {
                    console.error("CRITICAL: Failed to load resources-en.js as final fallback for resources.");
                 }
            } else if (!successLoadingResources && (variantId === 'en' || primaryLangForFallback === 'en')) {
                 console.error(`CRITICAL: Failed to load resources-en.js (or primary was en).`);
            }
        }
        if (!successLoadingResources) window.customResources = [];
        
        document.documentElement.lang = i18nData.lang || currentVariantIdentifier.split('-')[0];
        document.title = t('appTitle');
        questionsData = i18nData.questions || [];
        competenciesData = i18nData.competencyList || [];
        overallProficiencyLevelsData = i18nData.overallProficiencyLevels || [];
        if (competenciesData && competenciesData.length > 0) {
            const numCompetencies = competenciesData.length;
            answers.Knowledge = Array(numCompetencies).fill(0);
            answers.Skills = Array(numCompetencies).fill(0);
            answers.Attitudes = Array(numCompetencies).fill(0);
        }
        applyTranslations();
        updateLanguageSelectorValue(currentLanguage); 
        localStorage.setItem('selectedUserLanguage', currentLanguage); 
        if (currentBU) localStorage.setItem('selectedUserBU', currentBU); else localStorage.removeItem('selectedUserBU');
        console.log(`${currentVariantIdentifier.toUpperCase()} variant files applied successfully.`);
    }
    
    function updateLanguageSelectorValue(langCode) {
        if (!langSelectorElement) return;
        langSelectorElement.value = langCode; 
        const label = document.getElementById('language-selector-label');
        if (label) {
            const labelText = t('misc.languageLabel');
            label.textContent = labelText.startsWith('MISSING_') ? 'Language:' : labelText;
        }
    }

    function applyTranslations() {
        console.log("applyTranslations CALLED. Translating Start Screen elements."); // Added log

        const langLabel = document.getElementById('language-selector-label');
        if (langLabel) {
            const labelText = t('misc.languageLabel');
            // console.log("Setting language label to:", labelText); // Uncomment for debug
            langLabel.textContent = labelText.startsWith('MISSING_') ? 'Language:' : labelText;
        } else {
            // console.warn("language-selector-label not found in applyTranslations."); // Uncomment for debug
        }

        // Start Screen
        const ssTitleText = t('startScreen.title');
        console.log(`Start Screen - Title: "${ssTitleText}" (Element for ID 'start-screen-title' exists: ${!!document.getElementById('start-screen-title')})`);
        setText('start-screen-title', ssTitleText);

        const ssP1Text = t('startScreen.introParagraph1');
        console.log(`Start Screen - P1: (length ${ssP1Text.length}) (Element for ID 'start-screen-p1' exists: ${!!document.getElementById('start-screen-p1')})`);
        setHTML('start-screen-p1', ssP1Text);

        setHTML('start-screen-p2', t('startScreen.introParagraph2'));
        setHTML('start-screen-p3', t('startScreen.introParagraph3'));
        setHTML('start-screen-p4', t('startScreen.introParagraph4'));
        
        if (startButton) { 
            const ssButtonTextVal = t('startScreen.startButtonText');
            console.log(`Start Screen - Button Text: "${ssButtonTextVal}" (Button element var 'startButton' exists: true)`);
            setText('start-button', ssButtonTextVal);
        } else {
            console.error("startButton DOM element is null/undefined in applyTranslations when trying to set text.");
        }
        console.log("applyTranslations: Finished setting start screen elements.");
        
        if (noSelectionWarningEl) setText('no-selection-warning', t('assessmentScreen.noSelectionWarning'));
        const toggleProfButton = document.getElementById('toggle-proficiency-button');
        if (toggleProfButton) {
            const proficiencyDropdownEl = document.getElementById('proficiency-dropdown-content');
            if (proficiencyDropdownEl && (proficiencyDropdownEl.style.display === "none" || proficiencyDropdownEl.style.display === "")) {
                toggleProfButton.textContent = t('assessmentScreen.showProficiencyLevelsButton');
            } else if (proficiencyDropdownEl) {
                toggleProfButton.textContent = t('assessmentScreen.hideProficiencyLevelsButton');
            }
        }
        const proficiencyDropdown = document.getElementById('proficiency-dropdown-content');
        if (proficiencyDropdown) {
            proficiencyDropdown.innerHTML = `<p>${t('assessmentScreen.proficiencyLevelsDropdown.beginner')}</p><p>${t('assessmentScreen.proficiencyLevelsDropdown.developing')}</p><p>${t('assessmentScreen.proficiencyLevelsDropdown.competent')}</p><p>${t('assessmentScreen.proficiencyLevelsDropdown.proficient')}</p><p>${t('assessmentScreen.proficiencyLevelsDropdown.expert')}</p>`;
        }
        populateProficiencyButtons();

        if (assessmentScreen && !assessmentScreen.classList.contains('hidden') && questionsData.length > 0 && currentIndex < questionsData.length) {
            renderQuestion(currentIndex); 
        }

        if (endScreen && !endScreen.classList.contains('hidden')) {
            setText('end-screen-title', t('endScreen.title'));
            setText('qr-code-title', t('endScreen.qrCodeSectionTitle'));
            setText('qr-code-instruction', t('endScreen.qrCodeInstruction'));
            setText('key-char-title', t('endScreen.keyCharacteristicsTitle'));
            setText('key-char-intro', t('endScreen.keyCharacteristicsIntro'));
            setText('radar-chart-title', t('endScreen.radarChartTitle'));
            setText('radar-chart-desc', t('endScreen.radarChartDescription'));
            setHTML('radar-chart-legend', constructRadarLegend());
            setHTML('strengths-title', t('endScreen.strengthsSectionTitle'));
            setText('strengths-intro', t('endScreen.strengthsSectionIntro'));
            setHTML('growth-areas-title', t('endScreen.growthAreasSectionTitle'));
            setText('growth-areas-intro', t('endScreen.growthAreasSectionIntro'));
            setHTML('smart-objectives-title', t('endScreen.smartObjectivesSectionTitle'));
            setText('smart-objectives-intro', t('endScreen.smartObjectivesSectionIntro'));
            setHTML('thank-you-message', t('endScreen.thankYouMessage'));
            setText('survey-prompt', t('endScreen.surveyPrompt'));
            setText('survey-button', t('endScreen.surveyButtonText'));
            if (restartButton) setText('restart-button', t('endScreen.restartButtonText'));
            if (answers.Knowledge.length > 0 || answers.Skills.length > 0 || answers.Attitudes.length > 0) {
                 generateResultsPageContent();
            }
        }
    }

    function constructRadarLegend() { /* ... Same as before ... */ }
    function populateProficiencyButtons() { /* ... Same as before ... */ }
    function getCompetencyNameByKey(key) { /* ... Same as before ... */ }
    function renderQuestion(index) { /* ... Same as before ... */ }
    function attachEventListeners() { /* ... Same as before ... */ }
    function showResults() { /* ... Same as before ... */ }
    function encodeResponses() { /* ... Same as before ... */ }
    function decodeAndLoadResults() { /* ... Same as before ... */ }
    function displayKeyCharacteristics(characteristics) { /* ... Same as before ... */ }
    function generateResultsPageContent() { /* ... Same as before ... */ }
    function getStrongestDimension(comp) { /* ... Same as before ... */ }
    function getWeakestDimension(comp) { /* ... Same as before ... */ }
    function getFeedbackForCompetency(competencyKey, dimension) { /* ... Same as before ... */ }
    function getGrowthFeedbackForCompetency(competencyKey, dimension) { /* ... Same as before ... */ }
    function getSmartObjective(competencyKey, dimension) { /* ... Same as before ... */ }
    function generateStrengths(topCompetencies) { /* ... Same as before ... */ }
    function generateGrowthAreas(bottomCompetencies) { /* ... Same as before ... */ }
    function generateSmartObjectives(bottomCompetencies) { /* ... Same as before (using window.customResources) ... */ }
    function generateRadarChart() { /* ... Same as before ... */ }
    function updateQRCodeURL(data) { /* ... Same as before ... */ }
    function generateQRCode(data, canvasId) { /* ... Same as before ... */ }
    function toggleDropdown(event) { /* ... Same as before ... */ }
    
    function addEventListenersToDOM() { 
        if (restartButton) {
            restartButton.addEventListener("click", () => { /* ... same restart logic ... */ });
        } else { console.error("Restart button not found for listener in addEventListenersToDOM."); }

        if (startButton) {
            startButton.addEventListener("click", () => { /* ... same start logic ... */ });
        } else { console.error("Start button not found for listener in addEventListenersToDOM."); }

        if (langSelectorElement) {
            langSelectorElement.addEventListener('change', async (event) => { /* ... same lang change logic ... */ });
        }  else { console.warn("Language selector element not found for event listener attachment in addEventListenersToDOM."); }
    }
    
    async function initializeApp() {
        console.log("initializeApp CALLED"); // Line 465 from your log
        assignDOMelements(); 
        addEventListenersToDOM(); 

        const urlParams = new URLSearchParams(window.location.search);
        currentBU = urlParams.get('bu'); 
        if(currentBU) currentBU = currentBU.toLowerCase();

        let storedLang = localStorage.getItem('selectedUserLanguage');
        let browserLang = navigator.language || navigator.userLanguage || 'en';
        let initialLang = 'en'; 

        if (storedLang) {
            initialLang = storedLang;
        } else if (browserLang) {
            const primaryBrowserLang = browserLang.toLowerCase().split('-')[0];
            let langOptionExists = false;
            if (langSelectorElement && langSelectorElement.options) {
                 langOptionExists = Array.from(langSelectorElement.options).some(opt => opt.value === primaryBrowserLang);
            }
            if (langOptionExists) {
                initialLang = primaryBrowserLang;
            }
            if (browserLang.toLowerCase().startsWith('zh-hans') || browserLang.toLowerCase() === 'zh-cn' || browserLang.toLowerCase() === 'zh-sg') initialLang = 'zh-hans';
            else if (browserLang.toLowerCase().startsWith('zh-hant') || browserLang.toLowerCase() === 'zh-tw' || browserLang.toLowerCase() === 'zh-hk') initialLang = 'zh-hant';
        }
        
        currentLanguage = initialLang; 

        let variantToLoad = currentLanguage;
        if (currentBU) {
            variantToLoad = `${currentLanguage}-${currentBU}`;
            console.log(`BU parameter found: '${currentBU}'. Attempting initial variant: '${variantToLoad}'`);
        } else {
            console.log(`No BU parameter. Initial language: '${currentLanguage}' (effective variant: ${variantToLoad})`); // Line 496
        }
        
        await loadVariantFiles(variantToLoad); // Line 499 - This was where the error occurred
        
        decodeAndLoadResults(); 
        console.log("initializeApp COMPLETED"); // Line 502
    }

    // This MUST be last, after all functions it uses are defined.
    document.addEventListener('DOMContentLoaded', initializeApp);
    // --- END OF SCRIPT ---
</script>
</body>
</html>

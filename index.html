<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-WX8HLE4W5Q"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-WX8HLE4W5Q');
    </script>
    <meta charset="utf-8"/>
    <title>Digital Skills Assessment</title> <!-- Will be updated by JS -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
    <script src="resources.js"></script>

    <style>
        /* CSS Styles - REMAINS THE SAME AS YOUR DSA006 - Copy.html */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f2f5;
            margin: 0;
            padding: 0;
            color: #333;
        }
        .container {
            max-width: 800px;
            width: 90%;
            margin: 20px auto;
            background: #fff;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            padding: 20px 30px;
            padding-top: 10px; /* Reduce padding at the top */
        }
        h1, h2, h3 {
            font-size: 28px;
            margin: 20px 0;
            color: #2c3e50;
        }
        h4 {
            font-size: 22px;
            margin-bottom: 10px;
            color: #2c3e50;
        }
        p {
            margin: 10px 0 20px;
            font-size: 16px;
            color: #555;
            line-height: 1.6;
        }
        .progress-bar-container {
            width: 100%;
            background: #e0e0e0;
            border-radius: 10px;
            height: 20px;
            margin: 20px 0;
            overflow: hidden;
            position: relative;
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #0f777b, #4caf50);
            width: 0;
            transition: width 0.4s ease;
        }
        .progress-label {
            position: absolute;
            width: 100%;
            text-align: center;
            top: 0;
            font-size: 14px;
            color: #000;
            line-height: 20px;
        }
        .competency-banner {
            font-weight: bold;
            background: #0f777b; /* green */
            color: #fff;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            font-size: 20px;
        }
        .question-container {
            background: #e0f7fa; /* light green */
            border: 2px solid #0f777b;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            min-height: 120px;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .question-container h2 { /* Will become #question-text-container */
            font-size: 24px; /* From existing #question-text style */
            font-weight: bold; /* From existing #question-text style */
            color: #333; /* From existing #question-text style */
            margin: 0; /* From existing #question-text style */
            line-height: 1.5; /* From existing #question-text style */
        }
        .example { /* Will become #example-text-container */
            font-style: italic; /* From existing #example-text style */
            color: #555; /* From existing #example-text style */
            font-size: 16px; /* From existing #example-text style */
            margin-top: 15px; /* From existing #example-text style */
        }
        .proficiency-buttons {
            margin: 20px 0;
            display: flex;
            justify-content: space-between;
            flex-wrap: nowrap;
        }
        .proficiency-button {
            background: #e0e0e0;
            border: none;
            padding: 12px 10px;
            margin: 0 5px;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.3s ease, transform 0.1s ease;
            flex: 1;
            text-align: center;
            white-space: nowrap;
        }
        .proficiency-button:hover {
            background: #d5d5d5;
        }
        .proficiency-button.selected {
            background: #4caf50;
            color: white;
            transform: scale(1.05);
        }
        .no-selection-warning {
            color: red;
            font-size: 14px;
            margin-top: 10px;
            display: none;
        }
        .button {
            padding: 12px 25px;
            margin: 20px 0;
            background: #0f777b;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 18px;
            transition: background 0.3s ease;
        }
        .button:hover {
            background: #0a5e60;
        }
        .button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .hidden {
            display: none;
        }
        .summary-header {
            background: #e0f7fa;
            border: 1px solid #0f777b;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            text-align: center;
        }
        .summary-header p {
            font-size: 18px;
            color: #2c3e50;
            margin: 10px 0;
        }
        .summary-header p span {
            font-weight: bold;
        }
        .key-characteristics {
            text-align: left;
            margin: 10px 0;
            padding: 10px;
            background: #f9f9f9;
            border-left: 4px solid #4caf50;
            border-radius: 5px;
        }
        .key-characteristics ul {
            list-style: none;
            padding-left: 0;
        }
        .key-characteristics li {
            margin-bottom: 10px;
            font-size: 16px;
            position: relative;
            padding-left: 25px;
        }
        .key-characteristics li::before {
            content: "âœ”";
            position: absolute;
            left: 0;
            color: #4caf50;
            font-size: 18px;
        }
        .personalised-feedback {
            font-size: 16px;
            font-style: italic;
            color: #555;
            background: #fff;
            padding: 15px 20px;
            border-left: 4px solid #ff9800;
            margin: 20px 0;
            border-radius: 5px;
            text-align: left;
        }
        #competencyRadarChart {
            max-width: 100%;
            height: auto;
        }
        .chart-container {
            margin: 30px 0;
        }
        .card {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: left;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .card h4 {
            margin: 0 0 15px;
            color: #2c3e50;
        }
        .strengths .card {
            border-left: 4px solid #4caf50;
        }
        .growth-areas .card {
            border-left: 4px solid #f44336;
        }
        .smart-objectives .card {
            border-left: 4px solid #ff9800;
        }
        .section-title { /* Applies to h3 in results sections */
            font-size: 24px;
            margin-top: 40px;
            color: #2c3e50;
            text-align: left;
            padding-bottom: 10px;
        }
        .icon { /* Retained for icons in section titles */
            font-size: 24px;
            vertical-align: middle;
            margin-right: 10px;
        }
        .thank-you {
            background: #e0f7fa;
            border: 1px solid #0f777b;
            border-radius: 10px;
            padding: 20px;
            margin: 30px 0;
            font-size: 18px;
            color: #2c3e50;
        }
        .thank-you p { /* specifically for survey prompt */
            font-size: 18px;
            font-weight: bold;
        }
        .thank-you a {
            color: #ffffff;
            background-color: #0f777b;
            padding: 10px 20px;
            border-radius: 5px;
            text-decoration: none;
            font-size: 16px;
        }
        .thank-you a:hover {
            background-color: #0a5e60;
        }
        @media (max-width: 600px) {
            .proficiency-button {
                flex: 1 1 100%;
                margin: 5px 0;
            }
            .container {
                padding: 15px 20px;
            }
        }

        .strengths {
            background: #e8f5e9;
            border: 2px solid #4caf50;
            border-radius: 10px;
            padding: 20px;
            margin: 30px 0;
        }
        .growth-areas {
            background: #ffebee;
            border: 2px solid #f44336;
            border-radius: 10px;
            padding: 20px;
            margin: 30px 0;
        }
        .smart-objectives {
            background: #fff3e0;
            border: 2px solid #ff9800;
            border-radius: 10px;
            padding: 20px;
            margin: 30px 0;
        }
        .strengths .section-title, /* Selector for h3 */
        .growth-areas .section-title,
        .smart-objectives .section-title {
            background: rgba(0, 0, 0, 0.05);
            padding: 10px 15px;
            border-radius: 5px;
            margin: -20px -20px 20px -20px; /* Adjust to new h3 location */
        }
        .strengths .card,
        .growth-areas .card,
        .smart-objectives .card {
            background: #fff;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        /* Toggle buttons for simple/advanced results - NOT YET IMPLEMENTED IN JS */
        .toggle-buttons {
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }
        .toggle-button {
            background: #e0e0e0;
            border: none;
            padding: 10px 20px;
            margin: 0 5px;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s ease, color 0.3s ease;
        }
        .toggle-button.active {
            background: #0f777b;
            color: #fff;
        }
        .toggle-button:hover {
            background: #0a5e60;
        }

        .dropdown .button { /* For Show/Hide Proficiency button */
            background: #0f777b;
            color: #fff;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 10px;
            transition: background 0.3s ease;
        }
        .dropdown .button:hover {
            background: #0a5e60;
        }

        .dropdown-content {
            display: none;
            padding: 15px;
            margin-top: 10px;
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            color: #333;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        /* New styles for question text and example based on JSON structure */
        #question-text-container {
            font-size: 18px; /* Existing #question-text style */
            font-weight: bold; /* Existing #question-text style */
            color: #2c3e50; /* Existing #question-text style */
            line-height: 1.6; /* Existing #question-text style */
            margin-bottom: 10px; /* Existing #question-text style */
            text-align: center; /* Existing #question-text style */
        }
        #example-text-container {
            font-size: 16px; /* Existing #example-text style */
            font-style: italic; /* Existing #example-text style */
            color: #555; /* Existing #example-text style */
            line-height: 1.4; /* Existing #example-text style */
            margin-top: 5px; /* Existing #example-text style */
            margin-bottom: 0; /* Existing #example-text style */
            text-align: center; /* Existing #example-text style */
        }


        .chart-description {
            font-size: 16px;
            color: #555;
            margin-bottom: 20px;
            line-height: 1.5;
            text-align: center;
        }

        .qr-url {
            font-size: 12px;
            color: #e0e0e0; /* Lightened the color as requested */
            margin-top: 10px;
            word-wrap: break-word;
        }
    </style>
</head>
<body>
<!-- Start Screen -->
<div class="container" id="start-screen">
    <h1 id="start-screen-title"></h1>
    <p id="start-screen-p1"></p>
    <p id="start-screen-p2"></p>
    <p id="start-screen-p3"></p>
    <p id="start-screen-p4"></p>
    <div style="text-align: center;">
        <button class="button" id="start-button" type="button"></button>
    </div>
</div>

<!-- Assessment Screen -->
<div class="container hidden" id="assessment-screen">
    <div class="competency-banner" id="competency-banner"></div>
    <div class="progress-bar-container">
        <div class="progress-bar" id="progress-bar"></div>
        <div class="progress-label" id="progress-label">0%</div>
    </div>
    <div class="question-container">
        <h2 id="question-text-container"></h2> <!-- Renamed from #question-text -->
        <p class="example" id="example-text-container"></p> <!-- Renamed from #example-text -->
    </div>
    <div class="proficiency-buttons">
        <!-- Buttons will be populated by JS -->
    </div>
    <div class="no-selection-warning" id="no-selection-warning"></div>
    <div class="dropdown">
        <button class="button" id="toggle-proficiency-button" onclick="toggleDropdown(event)"></button>
        <div class="dropdown-content" id="proficiency-dropdown-content" style="display: block;">
            <!-- Proficiency descriptions will be populated by JS -->
        </div>
    </div>
</div>

<!-- End Screen -->
<div class="container hidden" id="end-screen">
    <h2 id="end-screen-title"></h2>
    <!-- The "simple results" div is removed as it was not used by the primary JS logic -->
    <!-- Advanced Results Page -->
    <div id="advanced-results">
        <div class="summary-header">
            <p style="font-size: 28px; font-weight: bold; color: #4caf50; margin: 10px 0;">
                <span id="total-score-advanced"></span>
            </p>
            <p style="font-size: 14px; color: #555; margin: 5px 0;">
                <span id="current-date-advanced"></span>
            </p>
            <div id="qr-code-container" style="text-align: center; margin-top: 20px;">
                <h3 id="qr-code-title"></h3>
                <canvas id="qr-code"></canvas>
                <p id="qr-code-instruction"></p>
            </div>
        </div>
        <div class="key-characteristics">
            <h3 id="key-char-title"></h3>
            <p id="key-char-intro"></p>
            <ul id="key-characteristics-advanced"></ul>
        </div>
        <div class="personalised-feedback" id="personalised-feedback-advanced"></div>
        <div class="chart-container">
            <h3 id="radar-chart-title"></h3>
            <p class="chart-description" id="radar-chart-desc"></p>
            <canvas id="competencyRadarChart"></canvas>
            <p id="radar-chart-legend"></p>
        </div>
        <div class="strengths">
            <h3 class="section-title" id="strengths-title"></h3>
            <p id="strengths-intro"></p>
            <div id="strengths"></div>
        </div>
        <div class="growth-areas">
            <h3 class="section-title" id="growth-areas-title"></h3>
            <p id="growth-areas-intro"></p>
            <div id="growth-areas"></div>
        </div>
        <div class="smart-objectives">
            <h3 class="section-title" id="smart-objectives-title"></h3>
            <p id="smart-objectives-intro"></p>
            <div id="smart-objectives"></div>
        </div>
        <div class="thank-you">
            <span id="thank-you-message"></span> <!-- Changed P to SPAN for direct text injection -->
            <div id="survey-link" style="text-align: center; margin-top: 20px;">
                <p id="survey-prompt"></p>
                <a href="https://forms.office.com/Pages/ResponsePage.aspx?id=-QiCXGC1CUmQO1pcxbHUWnL9uYyvyttIoQ6Huyhcv7tUOUM4QU05UTUxUUhFS0dIOU5SM0pXUVdaQy4u"
                   target="_blank"
                   id="survey-button"
                   style="color: #ffffff; background-color: #0f777b; padding: 10px 20px; border-radius: 5px; text-decoration: none; font-size: 16px;">
                </a>
            </div>
        </div>
    </div>
    <div style="text-align: center;">
        <button class="button" id="restart-button" type="button"></button>
        <div style="text-align: center; margin-top: 10px;">
            <p id="qr-url" class="qr-url"></p>
        </div>
    </div>
</div>

<script>
    let i18nData = {}; // To store loaded translations
    let currentLang = 'en'; // Default language
    let questionsData = [];
    let competenciesData = [];
    let overallProficiencyLevelsData = [];

    // Simple translation function
    function t(key, replacements = {}) {
        let text = key.split('.').reduce((obj, k) => (obj && obj[k] !== 'undefined') ? obj[k] : key, i18nData);
        for (const placeholder in replacements) {
            text = text.replace(new RegExp(`{${placeholder}}`, 'g'), replacements[placeholder]);
        }
        return text === key ? `MISSING_TRANSLATION: ${key}` : text;
    }

    async function loadTranslations(lang = 'en') {
        try {
            const response = await fetch(`${lang}.json?v=${new Date().getTime()}`); // Cache busting
            if (!response.ok) {
                console.error(`Could not load ${lang}.json. Status: ${response.status}`);
                if (lang !== 'en') { // Fallback to English if primary fails and not already English
                    return loadTranslations('en');
                }
                throw new Error(`Failed to load ${lang}.json`);
            }
            i18nData = await response.json();
            currentLang = lang;
            document.documentElement.lang = currentLang; // Set lang attribute on HTML element
            questionsData = i18nData.questions || [];
            competenciesData = i18nData.competencyList || [];
            overallProficiencyLevelsData = i18nData.overallProficiencyLevels || [];
            applyTranslations();
            console.log(`${lang.toUpperCase()} translations loaded.`);
        } catch (error) {
            console.error("Error loading translation file:", error);
            // Display a user-friendly error message on the page
            document.body.innerHTML = `<div style="padding: 20px; text-align: center; font-family: sans-serif;">
                                          <h1>Error</h1>
                                          <p>Could not load required resources. Please try again later or contact support.</p>
                                          <p><em>Details: ${error.message}</em></p>
                                       </div>`;
        }
    }

    function applyTranslations() {
        document.title = t('appTitle');

        // Start Screen
        setText('start-screen-title', t('startScreen.title'));
        setHTML('start-screen-p1', t('startScreen.introParagraph1'));
        setHTML('start-screen-p2', t('startScreen.introParagraph2'));
        setHTML('start-screen-p3', t('startScreen.introParagraph3'));
        setHTML('start-screen-p4', t('startScreen.introParagraph4'));
        setText('start-button', t('startScreen.startButtonText'));

        // Assessment Screen
        setText('no-selection-warning', t('assessmentScreen.noSelectionWarning'));
        setText('toggle-proficiency-button', t('assessmentScreen.showProficiencyLevelsButton')); // Initial state

        const proficiencyDropdown = document.getElementById('proficiency-dropdown-content');
        proficiencyDropdown.innerHTML = `
            <p>${t('assessmentScreen.proficiencyLevelsDropdown.beginner')}</p>
            <p>${t('assessmentScreen.proficiencyLevelsDropdown.developing')}</p>
            <p>${t('assessmentScreen.proficiencyLevelsDropdown.competent')}</p>
            <p>${t('assessmentScreen.proficiencyLevelsDropdown.proficient')}</p>
            <p>${t('assessmentScreen.proficiencyLevelsDropdown.expert')}</p>
        `;
        populateProficiencyButtons();

        // End Screen
        setText('end-screen-title', t('endScreen.title'));
        setText('qr-code-title', t('endScreen.qrCodeSectionTitle'));
        setText('qr-code-instruction', t('endScreen.qrCodeInstruction'));
        setText('key-char-title', t('endScreen.keyCharacteristicsTitle'));
        setText('key-char-intro', t('endScreen.keyCharacteristicsIntro'));
        setText('radar-chart-title', t('endScreen.radarChartTitle'));
        setText('radar-chart-desc', t('endScreen.radarChartDescription'));
        setHTML('radar-chart-legend', constructRadarLegend());

        setHTML('strengths-title', t('endScreen.strengthsSectionTitle'));
        setText('strengths-intro', t('endScreen.strengthsSectionIntro'));
        setHTML('growth-areas-title', t('endScreen.growthAreasSectionTitle'));
        setText('growth-areas-intro', t('endScreen.growthAreasSectionIntro'));
        setHTML('smart-objectives-title', t('endScreen.smartObjectivesSectionTitle'));
        setText('smart-objectives-intro', t('endScreen.smartObjectivesSectionIntro'));

        setHTML('thank-you-message', t('endScreen.thankYouMessage'));
        setText('survey-prompt', t('endScreen.surveyPrompt'));
        setText('survey-button', t('endScreen.surveyButtonText'));
        setText('restart-button', t('endScreen.restartButtonText'));
    }

    function constructRadarLegend() {
        return `${t('endScreen.radarChartLegendIntro')}
                <span style="color: #ff6384; font-weight: bold;">${t('endScreen.radarChartLegendKnowledge')}</span>,
                <span style="color: #36a2eb; font-weight: bold;">${t('endScreen.radarChartLegendSkills')}</span>, ${t('misc.andConjunction') || 'and'}
                <span style="color: #4bc0c0; font-weight: bold;">${t('endScreen.radarChartLegendAttitudes')}</span>
                ${t('endScreen.radarChartLegendExplanation')}
                <span style="color: #36a2eb; font-weight: bold;">${t('endScreen.radarChartLegendSkillsExample')}</span>
                ${t('misc.areLowerThanConjunction') || 'are lower than'} <span style="color: #ff6384; font-weight: bold;">${t('endScreen.radarChartLegendKnowledgeExample')}</span>
                ${t('endScreen.radarChartLegendExplanationSuffix')}`;
    }


    function setText(id, text) {
        const el = document.getElementById(id);
        if (el) el.textContent = text;
        // else console.warn(`Element with ID ${id} not found for setText`);
    }

    function setHTML(id, html) {
        const el = document.getElementById(id);
        if (el) el.innerHTML = html;
        // else console.warn(`Element with ID ${id} not found for setHTML`);
    }

    function populateProficiencyButtons() {
        const container = document.querySelector('#assessment-screen .proficiency-buttons');
        container.innerHTML = ''; // Clear existing
        for (let i = 1; i <= 5; i++) {
            const button = document.createElement('button');
            button.classList.add('proficiency-button');
            button.setAttribute('data-value', i);
            button.type = 'button';
            button.textContent = t(`proficiencyLabels.${i}`);
            container.appendChild(button);
        }
        // Re-attach event listeners after populating
        proficiencyButtons = document.querySelectorAll(".proficiency-button"); // Update NodeList
        // attachEventListeners() will be called by renderQuestion or similar
    }


    // --- Existing JS logic (modified to use i18nData) ---
    const answers = {
        Knowledge: [], // Will be sized based on competenciesData
        Skills: [],
        Attitudes: []
    };

    const startScreen = document.getElementById("start-screen");
    const assessmentScreen = document.getElementById("assessment-screen");
    const endScreen = document.getElementById("end-screen");
    const progressBar = document.getElementById("progress-bar");
    const progressLabel = document.getElementById("progress-label");
    const competencyBanner = document.getElementById("competency-banner");
    const questionTextContainer = document.getElementById("question-text-container"); // Updated ID
    const exampleTextContainer = document.getElementById("example-text-container"); // Updated ID
    let proficiencyButtons = document.querySelectorAll(".proficiency-button"); // Will be updated after population
    const noSelectionWarningEl = document.getElementById("no-selection-warning");

    const strengthsContainer = document.getElementById("strengths");
    const growthAreasContainer = document.getElementById("growth-areas");
    const smartObjectivesContainer = document.getElementById("smart-objectives");
    const restartButton = document.getElementById("restart-button");
    const startButton = document.getElementById("start-button");
    const advancedResults = document.getElementById("advanced-results");

    let currentIndex = 0;
    let radarChart;

    function getCompetencyByKey(key) {
        return competenciesData.find(c => c.key === key);
    }
     function getCompetencyNameByKey(key) {
        const competency = competenciesData.find(c => c.key === key);
        return competency ? competency.name : `MISSING_COMPETENCY_NAME_FOR_KEY: ${key}`;
    }


    function renderQuestion(index) {
        if (!questionsData || questionsData.length === 0) {
            console.error("Questions data not loaded or empty.");
            // Potentially show an error to the user
            return;
        }
        const question = questionsData[index];
        const competencyName = getCompetencyNameByKey(question.competencyKey);

        competencyBanner.textContent = `${t('assessmentScreen.competencyBannerPrefix')}${competencyName}`;
        questionTextContainer.textContent = t(`questionTexts.${question.questionKey}`);
        exampleTextContainer.textContent = `${t('misc.examplePrefix')}${t(`questionTexts.${question.exampleKey}`)}`;


        const progressPercentage = Math.round((index / questionsData.length) * 100);
        progressBar.style.width = `${progressPercentage}%`;
        progressLabel.textContent = `${progressPercentage}${t('assessmentScreen.progressLabelSuffix')}`;

        proficiencyButtons.forEach(button => button.classList.remove("selected"));
        noSelectionWarningEl.style.display = 'none'; // Hide warning on new question
        attachEventListeners();
    }

    function attachEventListeners() {
        proficiencyButtons.forEach(button => {
            // Remove old listener before adding new one to prevent multiple triggers
            const newButton = button.cloneNode(true);
            button.parentNode.replaceChild(newButton, button);
        });
        // Update the NodeList to the new buttons
        proficiencyButtons = document.querySelectorAll(".proficiency-button");

        proficiencyButtons.forEach(button => {
            button.onclick = () => {
                noSelectionWarningEl.style.display = 'none';
                proficiencyButtons.forEach(btn => btn.classList.remove("selected"));
                button.classList.add("selected");

                const selectedValue = parseInt(button.getAttribute("data-value"));
                const currentQuestion = questionsData[currentIndex];
                const competencyIndex = competenciesData.findIndex(c => c.key === currentQuestion.competencyKey);

                if (competencyIndex === -1) {
                    console.error("Could not find competency index for key:", currentQuestion.competencyKey);
                    return;
                }
                // Ensure answers arrays are initialized
                if (answers[currentQuestion.type] && competencyIndex < answers[currentQuestion.type].length) {
                     answers[currentQuestion.type][competencyIndex] = selectedValue;
                } else {
                    console.error(`Answer type ${currentQuestion.type} or index ${competencyIndex} out of bounds.`);
                }


                if (currentIndex < questionsData.length - 1) {
                    currentIndex++;
                    renderQuestion(currentIndex);
                } else {
                    showResults();
                }
            };
        });
    }


    function showResults() {
        progressBar.style.width = "100%";
        progressLabel.textContent = `100${t('assessmentScreen.progressLabelSuffix')}`;
        assessmentScreen.classList.add("hidden");
        startScreen.classList.add("hidden");
        endScreen.classList.remove("hidden");

        const today = new Date();
        const currentDay = String(today.getDate()).padStart(2, '0');
        const currentMonth = String(today.getMonth() + 1).padStart(2, '0');
        const currentYear = today.getFullYear();
        const formattedCurrentDate = `${currentDay}/${currentMonth}/${currentYear}`;

        document.getElementById('current-date-advanced').textContent = formattedCurrentDate;

        generateResultsPageContent(); // Renamed from generateResults for clarity

        const totalScore = answers.Knowledge.reduce((a, b) => a + b, 0) +
                           answers.Skills.reduce((a, b) => a + b, 0) +
                           answers.Attitudes.reduce((a, b) => a + b, 0);

        const maxScore = competenciesData.length * 3 * 5; // num_competencies * KSA_dimensions * max_rating
        const percentageScore = maxScore > 0 ? Math.round((totalScore / maxScore) * 100) : 0;

        let userProficiencyLevelText = "";
        let userKeyCharacteristics = [];
        let userFeedback = "";

        for (let level of overallProficiencyLevelsData) {
            if (percentageScore >= level.range[0] && percentageScore <= level.range[1]) {
                const levelName = t(`proficiencyTexts.${level.nameKey}`);
                userProficiencyLevelText = `${levelName} (${level.range[0]}% - ${level.range[1]}%)`;
                userKeyCharacteristics = level.characteristicsKeys.map(key => t(`proficiencyTexts.${key}`));
                userFeedback = t(`proficiencyTexts.${level.feedbackKey}`);
                break;
            }
        }

        document.getElementById('total-score-advanced').textContent = `${percentageScore}% (${userProficiencyLevelText.split(' ')[0]})`;
        displayKeyCharacteristics(userKeyCharacteristics);
        document.getElementById('personalised-feedback-advanced').textContent = userFeedback;

        const encodedData = encodeResponses();
        generateQRCode(encodedData, 'qr-code');
        updateQRCodeURL(encodedData); // Ensure URL is displayed

        // Ensure survey link is present (it's static HTML now, text updated by applyTranslations)
    }

    function encodeResponses() {
        // Ensure all answer arrays are of the same length (competenciesData.length)
        const numCompetencies = competenciesData.length;
        const knowledge = answers.Knowledge.slice(0, numCompetencies).join('');
        const skills = answers.Skills.slice(0, numCompetencies).join('');
        const attitudes = answers.Attitudes.slice(0, numCompetencies).join('');
        return `${knowledge}-${skills}-${attitudes}`;
    }

    function decodeAndLoadResults() {
        const data = new URLSearchParams(window.location.search).get('data');
        if (data) {
            const parts = data.split('-');
            if (parts.length === 3) {
                const [knowledgeStr, skillsStr, attitudesStr] = parts;
                // Assuming competenciesData is loaded to know the expected length
                const numCompetencies = competenciesData.length;

                answers.Knowledge = knowledgeStr.split('').map(Number).slice(0, numCompetencies);
                answers.Skills = skillsStr.split('').map(Number).slice(0, numCompetencies);
                answers.Attitudes = attitudesStr.split('').map(Number).slice(0, numCompetencies);

                // Fill any missing (if URL was shorter than expected)
                while (answers.Knowledge.length < numCompetencies) answers.Knowledge.push(0);
                while (answers.Skills.length < numCompetencies) answers.Skills.push(0);
                while (answers.Attitudes.length < numCompetencies) answers.Attitudes.push(0);

                showResults();
            } else {
                console.warn("Decoded data from URL is malformed.");
                // Proceed with normal start if data is bad
            }
        }
    }


    function displayKeyCharacteristics(characteristics) {
        const keyCharacteristicsListAdvanced = document.getElementById('key-characteristics-advanced');
        keyCharacteristicsListAdvanced.innerHTML = '';
        characteristics.forEach(characteristic => {
            const liAdvanced = document.createElement('li');
            liAdvanced.textContent = characteristic;
            keyCharacteristicsListAdvanced.appendChild(liAdvanced);
        });
    }

    function generateResultsPageContent() { // Formerly generateResults
        const competencyScores = competenciesData.map((comp, i) => {
            const knowledgeScore = answers.Knowledge[i] || 0;
            const skillsScore = answers.Skills[i] || 0;
            const attitudesScore = answers.Attitudes[i] || 0;
            const total = knowledgeScore + skillsScore + attitudesScore;
            return {
                key: comp.key, // Use key from competenciesData
                name: comp.name, // Use name from competenciesData
                knowledgeScore,
                skillsScore,
                attitudesScore,
                total
            };
        });

        const sortedCompetenciesDesc = [...competencyScores].sort((a, b) => b.total - a.total);
        const sortedCompetenciesAsc = [...competencyScores].sort((a, b) => a.total - b.total);

        const topCompetencies = sortedCompetenciesDesc.slice(0, 3);
        const bottomCompetencies = sortedCompetenciesAsc.slice(0, 3);

        generateStrengths(topCompetencies);
        generateGrowthAreas(bottomCompetencies);
        generateRadarChart();
        generateSmartObjectives(bottomCompetencies);
    }

    function getStrongestDimension(comp) {
        const scores = [
            { dimension: "Knowledge", score: comp.knowledgeScore },
            { dimension: "Skills", score: comp.skillsScore },
            { dimension: "Attitudes", score: comp.attitudesScore }
        ];
        scores.sort((a, b) => b.score - a.score);
        return scores[0].dimension;
    }

    function getWeakestDimension(comp) {
        const scores = [
            { dimension: "Knowledge", score: comp.knowledgeScore },
            { dimension: "Skills", score: comp.skillsScore },
            { dimension: "Attitudes", score: comp.attitudesScore }
        ];
        scores.sort((a, b) => a.score - b.score);
        return scores[0].dimension;
    }

    function getFeedbackForCompetency(competencyKey, dimension) {
        return i18nData.feedbackStrengths?.[competencyKey]?.[dimension] || `Missing strength feedback for ${competencyKey} - ${dimension}`;
    }

    function getGrowthFeedbackForCompetency(competencyKey, dimension) {
        return i18nData.feedbackGrowth?.[competencyKey]?.[dimension] || `Missing growth feedback for ${competencyKey} - ${dimension}`;
    }

    function getSmartObjective(competencyKey, dimension) {
        return i18nData.smartObjectives?.[competencyKey]?.[dimension] || `Missing SMART objective for ${competencyKey} - ${dimension}`;
    }

    function generateStrengths(topCompetencies) {
        strengthsContainer.innerHTML = '';
        topCompetencies.forEach(comp => {
            const strongestDimension = getStrongestDimension(comp);
            const feedback = getFeedbackForCompetency(comp.key, strongestDimension);
            strengthsContainer.innerHTML += `
                <div class="strength-item card">
                    <h4>${comp.name}</h4>
                    <p><strong>${t('endScreen.strongestDimensionLabel')}</strong> ${t(`radarChartLegend${strongestDimension}`)}</p>
                    <p>${feedback}</p>
                </div>
            `;
        });
    }

    function generateGrowthAreas(bottomCompetencies) {
        growthAreasContainer.innerHTML = '';
        bottomCompetencies.forEach(comp => {
            const weakestDimension = getWeakestDimension(comp);
            const feedback = getGrowthFeedbackForCompetency(comp.key, weakestDimension);
            growthAreasContainer.innerHTML += `
                <div class="growth-item card">
                    <h4>${comp.name}</h4>
                    <p><strong>${t('endScreen.growthAreaLabel')}</strong> ${t(`radarChartLegend${weakestDimension}`)}</p>
                    <p>${feedback}</p>
                </div>
            `;
        });
    }

    function generateSmartObjectives(bottomCompetencies) {
        smartObjectivesContainer.innerHTML = '';
        bottomCompetencies.forEach(comp => {
            const weakestDimension = getWeakestDimension(comp);
            const smartObjectiveText = getSmartObjective(comp.key, weakestDimension); // comp.key is correct

            const userLevel = comp[`${weakestDimension.toLowerCase()}Score`]; // e.g., comp.knowledgeScore

            let levelsToShow = [];
            if (userLevel === 1) levelsToShow = [1, 2, 3];
            else if (userLevel === 5) levelsToShow = [3, 4, 5];
            else if (userLevel) levelsToShow = [userLevel - 1, userLevel, userLevel + 1].filter(l => l >=1 && l <=5);
            else levelsToShow = [1,2,3]; // Default if userLevel is somehow undefined

            const competencyForResourceLookup = competenciesData.find(c => c.key === comp.key)?.name;

            const filteredResources = (window.resources || []).filter(r =>
                r.competency === competencyForResourceLookup &&
                r.level === weakestDimension.toLowerCase()
            );

            const chosenResources = filteredResources.filter(r => levelsToShow.includes(r.rating)).slice(0, 3);

            let resourcesHTML = '';
            if (chosenResources.length > 0) {
                resourcesHTML = `
                    <h5>${t('endScreen.recommendedResourcesLabel')}</h5>
                    <ul style="list-style:none; padding:0; margin:10px 0;">
                        ${chosenResources.map(r => `
                            <li style="margin-bottom:5px;">
                                <a href="${r.URL}" target="_blank" style="text-decoration:none; color:#0f777b;">
                                    <strong>${r.title}</strong>: ${r.description}
                                </a>
                            </li>
                        `).join('')}
                    </ul>
                `;
            }

            smartObjectivesContainer.innerHTML += `
                <div class="smart-item card">
                    <h4>${comp.name}</h4>
                    <p><strong>${t('endScreen.growthAreaLabel')}</strong> ${t(`radarChartLegend${weakestDimension}`)}</p>
                    <p><strong>${t('endScreen.smartObjectiveLabel')}</strong> ${smartObjectiveText}</p>
                    ${resourcesHTML}
                </div>
            `;
        });
    }


    function generateRadarChart() {
        if (radarChart) {
            radarChart.destroy();
        }
        const radarLabels = competenciesData.map(c => c.name);
        const data = {
            labels: radarLabels,
            datasets: [
                {
                    label: t('endScreen.radarChartLegendKnowledge'),
                    data: answers.Knowledge,
                    fill: true, backgroundColor: 'rgba(255, 99, 132, 0.2)', borderColor: 'rgba(255, 99, 132, 1)', pointBackgroundColor: 'rgba(255, 99, 132, 1)', borderWidth: 1
                },
                {
                    label: t('endScreen.radarChartLegendSkills'),
                    data: answers.Skills,
                    fill: true, backgroundColor: 'rgba(54, 162, 235, 0.2)', borderColor: 'rgba(54, 162, 235, 1)', pointBackgroundColor: 'rgba(54, 162, 235, 1)', borderWidth: 1
                },
                {
                    label: t('endScreen.radarChartLegendAttitudes'),
                    data: answers.Attitudes,
                    fill: true, backgroundColor: 'rgba(75, 192, 192, 0.2)', borderColor: 'rgba(75, 192, 192, 1)', pointBackgroundColor: 'rgba(75, 192, 192, 1)', borderWidth: 1
                }
            ]
        };
        const ctx = document.getElementById('competencyRadarChart').getContext('2d');
        radarChart = new Chart(ctx, {
            type: 'radar', data: data,
            options: { responsive: true, maintainAspectRatio: true, elements: { line: { tension: 0 } }, scales: { r: { angleLines: { display: false }, suggestedMin: 0, suggestedMax: 5, ticks: { stepSize: 1, beginAtZero: true } } } }
        });
    }

    restartButton.addEventListener("click", () => {
        currentIndex = 0;
        // Reset answers based on the actual number of competencies
        const numCompetencies = competenciesData.length;
        answers.Knowledge = Array(numCompetencies).fill(0);
        answers.Skills = Array(numCompetencies).fill(0);
        answers.Attitudes = Array(numCompetencies).fill(0);

        endScreen.classList.add("hidden");
        assessmentScreen.classList.add("hidden"); // Ensure assessment screen is hidden too
        startScreen.classList.remove("hidden");

        if (radarChart) {
            radarChart.destroy();
            radarChart = null;
        }
        const qrCodeCanvas = document.getElementById('qr-code');
        if (qrCodeCanvas) {
            qrCodeCanvas.getContext('2d').clearRect(0, 0, qrCodeCanvas.width, qrCodeCanvas.height);
        }
        setText('qr-url', '');
        // No need to re-call loadTranslations unless language changes
        // renderQuestion(currentIndex); // renderQuestion will be called when start button is clicked.
    });

    startButton.addEventListener("click", () => {
        startScreen.classList.add("hidden");
        assessmentScreen.classList.remove("hidden");
        // Initialize answer arrays based on loaded competencies
        const numCompetencies = competenciesData.length;
        answers.Knowledge = Array(numCompetencies).fill(0);
        answers.Skills = Array(numCompetencies).fill(0);
        answers.Attitudes = Array(numCompetencies).fill(0);
        renderQuestion(currentIndex);
    });

    // QR Code and URL functions (mostly unchanged from your original)
    function updateQRCodeURL(data) {
        const resultsURL = `${window.location.origin}${window.location.pathname}?data=${data}`;
        setText('qr-url', resultsURL);
    }
    function generateQRCode(data, canvasId) {
        const qrCodeCanvas = document.getElementById(canvasId);
        if (!qrCodeCanvas) {
            console.error(`Canvas with ID ${canvasId} not found for QR code.`);
            return;
        }
        const resultsURL = `${window.location.origin}${window.location.pathname}?data=${data}`;
        QRCode.toCanvas(qrCodeCanvas, resultsURL, { width: 200, margin: 2 }, function (error) {
            if (error) console.error(`Error generating QR code for ${canvasId}:`, error);
        });
    }
    function toggleDropdown(event) {
        const button = event.target;
        const dropdownContent = document.getElementById('proficiency-dropdown-content');
        if (dropdownContent) {
            if (dropdownContent.style.display === "none" || dropdownContent.style.display === "") {
                dropdownContent.style.display = "block";
                button.textContent = t('assessmentScreen.hideProficiencyLevelsButton');
            } else {
                dropdownContent.style.display = "none";
                button.textContent = t('assessmentScreen.showProficiencyLevelsButton');
            }
        }
    }

    // Initial load
    window.onload = async () => {
        await loadTranslations('en'); // Load English by default
        // Check for 'data' URL param after translations and competenciesData are loaded
        decodeAndLoadResults();

        // If no data in URL, and start screen is visible, then normal flow
        // If data IS in URL, decodeAndLoadResults will call showResults(),
        // which hides startScreen and assessmentScreen.
    };

</script>
</body>
</html>
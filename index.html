<!DOCTYPE html>
<html lang="en"> <!-- Default lang, will be updated by JS -->
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-WX8HLE4W5Q"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-WX8HLE4W5Q');
    </script>
    <meta charset="utf-8"/>
    <title>Digital Skills Assessment</title> <!-- Will be updated by JS -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
    <!-- resources.js is NOT loaded here by default anymore. It will be loaded dynamically -->

    <style>
        /* CSS STYLES (as provided by you, unchanged) */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; margin: 0; padding: 0; color: #333; }
        .container { max-width: 800px; width: 90%; margin: 20px auto; background: #fff; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); border-radius: 10px; padding: 20px 30px; padding-top: 10px; }
        h1, h2, h3 { font-size: 28px; margin: 20px 0; color: #2c3e50; }
        h4 { font-size: 22px; margin-bottom: 10px; color: #2c3e50; }
        p { margin: 10px 0 20px; font-size: 16px; color: #555; line-height: 1.6; }
        .progress-bar-container { width: 100%; background: #e0e0e0; border-radius: 10px; height: 20px; margin: 20px 0; overflow: hidden; position: relative; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, #0f777b, #4caf50); width: 0; transition: width 0.4s ease; }
        .progress-label { position: absolute; width: 100%; text-align: center; top: 0; font-size: 14px; color: #000; line-height: 20px; }
        .competency-banner { font-weight: bold; background: #0f777b; color: #fff; padding: 15px; border-radius: 5px; margin: 20px 0; font-size: 20px; }
        .question-container { background: #e0f7fa; border: 2px solid #0f777b; border-radius: 10px; padding: 15px; margin: 10px 0; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); min-height: 120px; text-align: center; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .question-container h2 { font-size: 24px; font-weight: bold; color: #333; margin: 0; line-height: 1.5; }
        .example { font-style: italic; color: #555; font-size: 16px; margin-top: 15px; }
        .proficiency-buttons { margin: 20px 0; display: flex; justify-content: space-between; flex-wrap: nowrap; }
        .proficiency-button { background: #e0e0e0; border: none; padding: 12px 10px; margin: 0 5px; border-radius: 5px; font-size: 14px; cursor: pointer; transition: background 0.3s ease, transform 0.1s ease; flex: 1; text-align: center; white-space: nowrap; }
        .proficiency-button:hover { background: #d5d5d5; }
        .proficiency-button.selected { background: #4caf50; color: white; transform: scale(1.05); }
        .no-selection-warning { color: red; font-size: 14px; margin-top: 10px; display: none; }
        .button { padding: 12px 25px; margin: 20px 0; background: #0f777b; color: #fff; border: none; border-radius: 5px; cursor: pointer; font-size: 18px; transition: background 0.3s ease; }
        .button:hover { background: #0a5e60; }
        .button:disabled { background: #ccc; cursor: not-allowed; }
        .hidden { display: none; }
        .summary-header { background: #e0f7fa; border: 1px solid #0f777b; border-radius: 10px; padding: 20px; margin-bottom: 30px; text-align: center; }
        .summary-header p { font-size: 18px; color: #2c3e50; margin: 10px 0; }
        .summary-header p span { font-weight: bold; }
        .key-characteristics { text-align: left; margin: 10px 0; padding: 10px; background: #f9f9f9; border-left: 4px solid #4caf50; border-radius: 5px; }
        .key-characteristics ul { list-style: none; padding-left: 0; }
        .key-characteristics li { margin-bottom: 10px; font-size: 16px; position: relative; padding-left: 25px; }
        .key-characteristics li::before { content: "✔"; position: absolute; left: 0; color: #4caf50; font-size: 18px; }
        .personalised-feedback { font-size: 16px; font-style: italic; color: #555; background: #fff; padding: 15px 20px; border-left: 4px solid #ff9800; margin: 20px 0; border-radius: 5px; text-align: left; }
        #competencyRadarChart { max-width: 100%; height: auto; }
        .chart-container { margin: 30px 0; }
        .card { background: #fff; border: 1px solid #e0e0e0; border-radius: 10px; padding: 20px; margin: 20px 0; text-align: left; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
        .card h4 { margin: 0 0 15px; color: #2c3e50; }
        .strengths .card { border-left: 4px solid #4caf50; }
        .growth-areas .card { border-left: 4px solid #f44336; }
        .smart-objectives .card { border-left: 4px solid #ff9800; }
        .section-title { font-size: 24px; margin-top: 40px; color: #2c3e50; text-align: left; padding-bottom: 10px; }
        .icon { font-size: 24px; vertical-align: middle; margin-right: 10px; }
        .thank-you { background: #e0f7fa; border: 1px solid #0f777b; border-radius: 10px; padding: 20px; margin: 30px 0; font-size: 18px; color: #2c3e50; text-align: center; }
        .thank-you p { font-size: 18px; font-weight: bold; }
        .thank-you a { color: #ffffff; background-color: #0f777b; padding: 10px 20px; border-radius: 5px; text-decoration: none; font-size: 16px; }
        .thank-you a:hover { background-color: #0a5e60; }
        @media (max-width: 600px) { .proficiency-button { flex: 1 1 100%; margin: 5px 0; } .container { padding: 15px 20px; } }
        .strengths { background: #e8f5e9; border: 2px solid #4caf50; border-radius: 10px; padding: 20px; margin: 30px 0; }
        .growth-areas { background: #ffebee; border: 2px solid #f44336; border-radius: 10px; padding: 20px; margin: 30px 0; }
        .smart-objectives { background: #fff3e0; border: 2px solid #ff9800; border-radius: 10px; padding: 20px; margin: 30px 0; }
        .strengths .section-title, .growth-areas .section-title, .smart-objectives .section-title { background: rgba(0,0,0,0.05); padding: 10px 15px; border-radius: 5px; margin: -20px -20px 20px -20px; }
        .strengths .card, .growth-areas .card, .smart-objectives .card { background: #fff; border-radius: 8px; padding: 15px; margin: 15px 0; }
        .dropdown .button { background: #0f777b; color: #fff; border: none; padding: 10px 15px; border-radius: 5px; font-size: 16px; cursor: pointer; margin-top: 10px; transition: background 0.3s ease; }
        .dropdown .button:hover { background: #0a5e60; }
        .dropdown-content { display: none; padding: 15px; margin-top: 10px; background: #f9f9f9; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; color: #333; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        #question-text-container { font-size: 18px; font-weight: bold; color: #2c3e50; line-height: 1.6; margin-bottom: 10px; text-align: center; }
        #example-text-container { font-size: 16px; font-style: italic; color: #555; line-height: 1.4; margin-top: 5px; margin-bottom: 0; text-align: center; }
        .chart-description { font-size: 16px; color: #555; margin-bottom: 20px; line-height: 1.5; text-align: center; }
        .qr-url { font-size: 12px; color: #e0e0e0; margin-top: 10px; word-wrap: break-word; }
        #language-selector-container { padding: 10px; text-align: right; background-color: #f8f9fa; border-bottom: 1px solid #e0e0e0; margin-bottom:15px; }
    </style>
</head>
<body>

<div id="language-selector-container">
    <label for="language-selector" id="language-selector-label" style="margin-right: 5px;">Language:</label>
    <select id="language-selector">
        <option value="en">English</option>
        <option value="es">Español (Test)</option>
        <option value="fr">Français (Test)</option>
        <option value="cs">Čeština (Test)</option>
        <option value="nl">Nederlands (Test)</option>
        <option value="de">Deutsch (Test)</option>
        <option value="hu">Magyar (Test)</option>
        <option value="it">Italiano (Test)</option>
        <option value="lv">Latviešu (Test)</option>
        <option value="lt">Lietuvių (Test)</option>
        <option value="ro">Română (Test)</option>
        <option value="sk">Slovenčina (Test)</option>
        <option value="tr">Türkçe (Test)</option>
        <option value="uk">Українська (Test)</option>
        <option value="zh-hans">中文 (简体) (Test)</option>
        <option value="zh-hant">中文 (繁體) (Test)</option>
        <option value="id">Bahasa Indonesia (Test)</option>
        <option value="th">ไทย (Test)</option>
        <option value="vi">Tiếng Việt (Test)</option>
    </select>
</div>

<div class="container" id="start-screen">
    <h1 id="start-screen-title"></h1>
    <p id="start-screen-p1"></p>
    <p id="start-screen-p2"></p>
    <p id="start-screen-p3"></p>
    <p id="start-screen-p4"></p>
    <div style="text-align: center;">
        <button class="button" id="start-button" type="button"></button>
    </div>
</div>

<div class="container hidden" id="assessment-screen">
    <div class="competency-banner" id="competency-banner"></div>
    <div class="progress-bar-container">
        <div class="progress-bar" id="progress-bar"></div>
        <div class="progress-label" id="progress-label">0%</div>
    </div>
    <div class="question-container">
        <h2 id="question-text-container"></h2>
        <p class="example" id="example-text-container"></p>
    </div>
    <div class="proficiency-buttons"></div>
    <div class="no-selection-warning" id="no-selection-warning"></div>
    <div class="dropdown">
        <button class="button" id="toggle-proficiency-button" onclick="toggleDropdown(event)"></button>
        <div class="dropdown-content" id="proficiency-dropdown-content" style="display: block;">
        </div>
    </div>
</div>

<div class="container hidden" id="end-screen">
    <h2 id="end-screen-title"></h2>
    <div id="advanced-results">
        <div class="summary-header">
            <p style="font-size: 28px; font-weight: bold; color: #4caf50; margin: 10px 0;">
                <span id="total-score-advanced"></span>
            </p>
            <p style="font-size: 14px; color: #555; margin: 5px 0;">
                <span id="current-date-advanced"></span>
            </p>
            <div id="qr-code-container" style="text-align: center; margin-top: 20px;">
                <h3 id="qr-code-title"></h3>
                <canvas id="qr-code"></canvas>
                <p id="qr-code-instruction"></p>
            </div>
        </div>
        <div class="key-characteristics">
            <h3 id="key-char-title"></h3>
            <p id="key-char-intro"></p>
            <ul id="key-characteristics-advanced"></ul>
        </div>
        <div class="personalised-feedback" id="personalised-feedback-advanced"></div>
        <div class="chart-container">
            <h3 id="radar-chart-title"></h3>
            <p class="chart-description" id="radar-chart-desc"></p>
            <canvas id="competencyRadarChart"></canvas>
            <p id="radar-chart-legend"></p>
        </div>
        <div class="strengths">
            <h3 class="section-title" id="strengths-title"></h3>
            <p id="strengths-intro"></p>
            <div id="strengths"></div>
        </div>
        <div class="growth-areas">
            <h3 class="section-title" id="growth-areas-title"></h3>
            <p id="growth-areas-intro"></p>
            <div id="growth-areas"></div>
        </div>
        <div class="smart-objectives">
            <h3 class="section-title" id="smart-objectives-title"></h3>
            <p id="smart-objectives-intro"></p>
            <div id="smart-objectives"></div>
        </div>
        <div class="thank-you">
            <span id="thank-you-message"></span>
            <div id="survey-link" style="text-align: center; margin-top: 20px;">
                <p id="survey-prompt"></p>
                <a href="https://forms.office.com/Pages/ResponsePage.aspx?id=-QiCXGC1CUmQO1pcxbHUWnL9uYyvyttIoQ6Huyhcv7tUOUM4QU05UTUxUUhFS0dIOU5SM0pXUVdaQy4u"
                   target="_blank"
                   id="survey-button"
                   style="color: #ffffff; background-color: #0f777b; padding: 10px 20px; border-radius: 5px; text-decoration: none; font-size: 16px;">
                </a>
            </div>
        </div>
    </div>
    <div style="text-align: center;">
        <button class="button" id="restart-button" type="button"></button>
        <div style="text-align: center; margin-top: 10px;">
            <p id="qr-url" class="qr-url"></p>
        </div>
    </div>
</div>

<script>
    // --- START OF SCRIPT ---

    // --- GLOBAL VARIABLE DECLARATIONS (Must be at the very top) ---
    let i18nData = {};
    let currentLanguage = 'en'; 
    let currentBU = null; 
    let currentVariantIdentifier = 'en'; 

    let questionsData = [];
    let competenciesData = [];
    let overallProficiencyLevelsData = [];
    const answers = { Knowledge: [], Skills: [], Attitudes: [] };
    let currentIndex = 0;
    let radarChart;

    // DOM Element Grabbers (declared here, assigned in assignDOMelements after DOMContentLoaded)
    let startScreen, assessmentScreen, endScreen, progressBar, progressLabel, competencyBanner,
        questionTextContainer, exampleTextContainer, proficiencyButtonsNodeList, noSelectionWarningEl,
        strengthsContainer, growthAreasContainer, smartObjectivesContainer,
        restartButton, startButton, langSelectorElement;

    // --- FUNCTION DEFINITIONS ---

    function assignDOMelements() {
        startScreen = document.getElementById("start-screen");
        assessmentScreen = document.getElementById("assessment-screen");
        endScreen = document.getElementById("end-screen");
        progressBar = document.getElementById("progress-bar");
        progressLabel = document.getElementById("progress-label");
        competencyBanner = document.getElementById("competency-banner");
        questionTextContainer = document.getElementById("question-text-container");
        exampleTextContainer = document.getElementById("example-text-container");
        noSelectionWarningEl = document.getElementById("no-selection-warning");
        strengthsContainer = document.getElementById("strengths");
        growthAreasContainer = document.getElementById("growth-areas");
        smartObjectivesContainer = document.getElementById("smart-objectives");
        restartButton = document.getElementById("restart-button");
        startButton = document.getElementById("start-button");
        langSelectorElement = document.getElementById('language-selector');
        console.log("assignDOMelements FINISHED. Start button:", startButton); 
    }

    function setText(id, text) { 
        const el = document.getElementById(id); 
        if (el) { el.textContent = text; }
    }

    function setHTML(id, html) { 
        const el = document.getElementById(id); 
        if (el) { el.innerHTML = html; }
    }

    function t(key, replacements = {}) { 
        if (typeof i18nData !== 'object' || i18nData === null) return `MISSING_I18NDATA: ${key}`;
        let textValue = i18nData;
        const parts = key.split('.');
        for (let i = 0; i < parts.length; i++) {
            const part = parts[i];
            if (textValue && typeof textValue === 'object' && Object.prototype.hasOwnProperty.call(textValue, part)) {
                textValue = textValue[part];
            } else { return `MISSING_TRANSLATION: ${key}`; }
        }
        if (typeof textValue !== 'string') return `INVALID_TRANSLATION_TYPE: ${key}`;
        let finalText = textValue;
        for (const placeholder in replacements) {
            finalText = finalText.replace(new RegExp(`{${placeholder}}`, 'g'), replacements[placeholder]);
        }
        return finalText;
    }
    
    async function loadVariantFiles(variantId) {
        console.log(`loadVariantFiles CALLED for effective variant: ${variantId}`);
        let textJsonToLoad = `${variantId}.json`;
        let resourcesJsToLoad = `resources-${variantId}.js`;
        let primaryLangForFallback = variantId.split('-')[0]; 
        let successLoadingText = false;
        let successLoadingResources = false;

        try {
            let response = await fetch(`${textJsonToLoad}?v=${new Date().getTime()}`);
            if (!response.ok) {
                if (variantId !== primaryLangForFallback && primaryLangForFallback) {
                    console.warn(`Could not load ${textJsonToLoad}. Attempting primary language fallback: ${primaryLangForFallback}.json`);
                    textJsonToLoad = `${primaryLangForFallback}.json`;
                    response = await fetch(`${textJsonToLoad}?v=${new Date().getTime()}`);
                }
                if (!response.ok) { 
                    console.warn(`Could not load ${textJsonToLoad}. Falling back to en.json for text.`);
                    if (textJsonToLoad.startsWith('en') && variantId !== 'en' && primaryLangForFallback !== 'en') {}
                    else if (textJsonToLoad === 'en.json' || textJsonToLoad === 'en') { throw new Error('CRITICAL: Failed to load en.json for text.'); }
                    
                    textJsonToLoad = 'en.json';
                    response = await fetch(`${textJsonToLoad}?v=${new Date().getTime()}`);
                    if (!response.ok) throw new Error('CRITICAL: Failed to load en.json as ultimate text fallback.');
                }
            }
            i18nData = await response.json();
            currentVariantIdentifier = textJsonToLoad.replace('.json', ''); 
            successLoadingText = true;
            console.log('Successfully loaded Text JSON for:', currentVariantIdentifier); 
        } catch (error) {
            console.error("Fatal error loading text JSON file:", error);
            document.body.innerHTML = `<div style="text-align:center;padding:20px;"><h1>Error</h1><p>Could not load language text resources.</p><p><em>${error.message}</em></p></div>`;
            return; 
        }

        const oldResourcesScript = document.getElementById('dynamic-resources-script');
        if (oldResourcesScript) oldResourcesScript.remove();
        window.customResources = []; 

        const loadScript = (src) => {
            return new Promise((resolve, reject) => {
                const scriptToLoad = document.createElement('script'); 
                scriptToLoad.id = 'dynamic-resources-script'; 
                scriptToLoad.src = `${src}?v=${new Date().getTime()}`;
                scriptToLoad.onload = () => { console.log(`Resources loaded from ${src}`); successLoadingResources = true; resolve(); }; 
                scriptToLoad.onerror = () => { console.warn(`Could not load ${src}`); reject(new Error(`Failed to load ${src}`)); };
                document.head.appendChild(scriptToLoad);
            });
        };

        try {
            await loadScript(resourcesJsToLoad);
        } catch (error) {
            let triedPrimary = false;
            if (variantId !== primaryLangForFallback && primaryLangForFallback) {
                triedPrimary = true;
                try {
                    console.log(`Attempting fallback for resources: resources-${primaryLangForFallback}.js`);
                    await loadScript(`resources-${primaryLangForFallback}.js`);
                } catch (error2) { /* Fall through to English if primary fails */ }
            }
            if (!successLoadingResources && (primaryLangForFallback !== 'en' || !triedPrimary ) && variantId !== 'en' ) {
                 try {
                    console.log(`Attempting fallback for resources: resources-en.js`);
                    await loadScript('resources-en.js');
                 } catch (error3) {
                    console.error("CRITICAL: Failed to load resources-en.js as final fallback for resources.");
                 }
            } else if (!successLoadingResources && (variantId === 'en' || primaryLangForFallback === 'en')) {
                 console.error(`CRITICAL: Failed to load resources-en.js (or primary was en).`);
            }
        }
        if (!successLoadingResources) {
            console.warn(`No resource script loaded successfully for variant '${variantId}'. window.customResources will be empty.`);
            window.customResources = []; 
        }
        
        document.documentElement.lang = i18nData.lang || currentVariantIdentifier.split('-')[0];
        document.title = t('appTitle');
        questionsData = i18nData.questions || [];
        competenciesData = i18nData.competencyList || [];
        overallProficiencyLevelsData = i18nData.overallProficiencyLevels || [];
        
        if (competenciesData && competenciesData.length > 0) {
            const numCompetencies = competenciesData.length;
            answers.Knowledge = Array(numCompetencies).fill(0); 
            answers.Skills = Array(numCompetencies).fill(0);
            answers.Attitudes = Array(numCompetencies).fill(0);
        } else {
            console.error("Competencies data is empty after loading JSON. Cannot initialize answers array properly.");
        }

        applyTranslations();
        updateLanguageSelectorValue(currentLanguage); 
        localStorage.setItem('selectedUserLanguage', currentLanguage); 
        if (currentBU) localStorage.setItem('selectedUserBU', currentBU); else localStorage.removeItem('selectedUserBU');
        console.log(`${currentVariantIdentifier.toUpperCase()} variant files applied successfully.`);
    }
    
    function updateLanguageSelectorValue(langCode) { 
        if (!langSelectorElement) return;
        langSelectorElement.value = langCode; 
        const label = document.getElementById('language-selector-label');
        if (label) {
            const labelText = t('misc.languageLabel');
            label.textContent = labelText.startsWith('MISSING_') ? 'Language:' : labelText;
        }
    }

    function applyTranslations() {
        console.log("applyTranslations CALLED. Attempting to translate Start Screen elements."); 

        const langLabel = document.getElementById('language-selector-label');
        if (langLabel) {
            const labelText = t('misc.languageLabel');
            langLabel.textContent = labelText.startsWith('MISSING_') ? 'Language:' : labelText;
        } else { console.warn("language-selector-label not found in applyTranslations."); }

        const ssTitleEl = document.getElementById('start-screen-title');
        const ssTitleText = t('startScreen.title');
        console.log(` - Start Screen Title: "${ssTitleText}" (Element found: ${!!ssTitleEl})`);
        if (ssTitleEl) setText('start-screen-title', ssTitleText); else console.error("start-screen-title element NOT FOUND in applyTranslations");

        const ssP1El = document.getElementById('start-screen-p1');
        const ssP1Text = t('startScreen.introParagraph1');
        console.log(` - Start Screen P1: (Element found: ${!!ssP1El})`); // Removed text preview for brevity
        if (ssP1El) setHTML('start-screen-p1', ssP1Text); else console.error("start-screen-p1 element NOT FOUND in applyTranslations");
        
        const ssP2El = document.getElementById('start-screen-p2');
        const ssP2Text = t('startScreen.introParagraph2');
        console.log(` - Start Screen P2: (Element found: ${!!ssP2El})`);
        if (ssP2El) setHTML('start-screen-p2', ssP2Text); else console.error("start-screen-p2 element NOT FOUND in applyTranslations");

        const ssP3El = document.getElementById('start-screen-p3');
        const ssP3Text = t('startScreen.introParagraph3');
        console.log(` - Start Screen P3: (Element found: ${!!ssP3El})`);
        if (ssP3El) setHTML('start-screen-p3', ssP3Text); else console.error("start-screen-p3 element NOT FOUND in applyTranslations");

        const ssP4El = document.getElementById('start-screen-p4');
        const ssP4Text = t('startScreen.introParagraph4');
        console.log(` - Start Screen P4: (Element found: ${!!ssP4El})`);
        if (ssP4El) setHTML('start-screen-p4', ssP4Text); else console.error("start-screen-p4 element NOT FOUND in applyTranslations");
        
        if (startButton) { 
            const ssButtonTextVal = t('startScreen.startButtonText');
            console.log(` - Start Screen Button Text: "${ssButtonTextVal}" (startButton global var exists: true)`);
            setText('start-button', ssButtonTextVal);
        } else {
            console.error("startButton global variable is null/undefined in applyTranslations when trying to set text.");
        }
        console.log("applyTranslations: Finished setting start screen elements.");
        
        if (noSelectionWarningEl) setText('no-selection-warning', t('assessmentScreen.noSelectionWarning'));
        const toggleProfButton = document.getElementById('toggle-proficiency-button');
        if (toggleProfButton) { 
            const proficiencyDropdownEl = document.getElementById('proficiency-dropdown-content');
            if (proficiencyDropdownEl && (proficiencyDropdownEl.style.display === "none" || proficiencyDropdownEl.style.display === "")) {
                toggleProfButton.textContent = t('assessmentScreen.showProficiencyLevelsButton');
            } else if (proficiencyDropdownEl) {
                toggleProfButton.textContent = t('assessmentScreen.hideProficiencyLevelsButton');
            }
        }
        const proficiencyDropdown = document.getElementById('proficiency-dropdown-content');
        if (proficiencyDropdown) { 
            proficiencyDropdown.innerHTML = `<p>${t('assessmentScreen.proficiencyLevelsDropdown.beginner')}</p><p>${t('assessmentScreen.proficiencyLevelsDropdown.developing')}</p><p>${t('assessmentScreen.proficiencyLevelsDropdown.competent')}</p><p>${t('assessmentScreen.proficiencyLevelsDropdown.proficient')}</p><p>${t('assessmentScreen.proficiencyLevelsDropdown.expert')}</p>`;
        }
        populateProficiencyButtons();

        if (assessmentScreen && !assessmentScreen.classList.contains('hidden') && questionsData.length > 0 && currentIndex < questionsData.length) {
            renderQuestion(currentIndex); 
        }

        if (endScreen && !endScreen.classList.contains('hidden')) { 
            setText('end-screen-title', t('endScreen.title'));
            setText('qr-code-title', t('endScreen.qrCodeSectionTitle'));
            setText('qr-code-instruction', t('endScreen.qrCodeInstruction'));
            setText('key-char-title', t('endScreen.keyCharacteristicsTitle'));
            setText('key-char-intro', t('endScreen.keyCharacteristicsIntro'));
            setText('radar-chart-title', t('endScreen.radarChartTitle'));
            setText('radar-chart-desc', t('endScreen.radarChartDescription'));
            setHTML('radar-chart-legend', constructRadarLegend());
            setHTML('strengths-title', t('endScreen.strengthsSectionTitle'));
            setText('strengths-intro', t('endScreen.strengthsSectionIntro'));
            setHTML('growth-areas-title', t('endScreen.growthAreasSectionTitle'));
            setText('growth-areas-intro', t('endScreen.growthAreasSectionIntro'));
            setHTML('smart-objectives-title', t('endScreen.smartObjectivesSectionTitle'));
            setText('smart-objectives-intro', t('endScreen.smartObjectivesSectionIntro'));
            setHTML('thank-you-message', t('endScreen.thankYouMessage'));
            setText('survey-prompt', t('endScreen.surveyPrompt'));
            setText('survey-button', t('endScreen.surveyButtonText'));
            if (restartButton) setText('restart-button', t('endScreen.restartButtonText'));
            if (answers.Knowledge.length > 0 || answers.Skills.length > 0 || answers.Attitudes.length > 0) {
                 generateResultsPageContent();
            }
        }
    }

    function constructRadarLegend() { 
        const andConj = t('misc.andConjunction');
        const lowerThanConj = t('misc.areLowerThanConjunction');
        return `${t('endScreen.radarChartLegendIntro')}<span style="color: #ff6384; font-weight: bold;">${t('endScreen.radarChartLegendKnowledge')}</span>, <span style="color: #36a2eb; font-weight: bold;">${t('endScreen.radarChartLegendSkills')}</span>, ${andConj.startsWith('MISSING_') ? 'and' : andConj} <span style="color: #4bc0c0; font-weight: bold;">${t('endScreen.radarChartLegendAttitudes')}</span>${t('endScreen.radarChartLegendExplanation')}<span style="color: #36a2eb; font-weight: bold;">${t('endScreen.radarChartLegendSkillsExample')}</span> ${lowerThanConj.startsWith('MISSING_') ? 'are lower than' : lowerThanConj} <span style="color: #ff6384; font-weight: bold;">${t('endScreen.radarChartLegendKnowledgeExample')}</span>${t('endScreen.radarChartLegendExplanationSuffix')}`;
    }
    function populateProficiencyButtons() { 
        const container = document.querySelector('#assessment-screen .proficiency-buttons');
        if (!container) return;
        container.innerHTML = '';
        for (let i = 1; i <= 5; i++) {
            const button = document.createElement('button');
            button.classList.add('proficiency-button');
            button.setAttribute('data-value', i);
            button.type = 'button';
            button.textContent = t(`proficiencyLabels.${i}`); 
            container.appendChild(button);
        }
        proficiencyButtonsNodeList = document.querySelectorAll("#assessment-screen .proficiency-button"); 
    }
    function getCompetencyNameByKey(key) { 
        if (!competenciesData) return `NO_COMP_DATA_FOR_KEY: ${key}`;
        const competency = competenciesData.find(c => c.key === key);
        return competency ? competency.name : `MISSING_COMP_NAME: ${key}`;
    }
    function renderQuestion(index) { 
        if (!questionsData || questionsData.length === 0 || index >= questionsData.length) {return;}
        const question = questionsData[index];
        const competencyName = getCompetencyNameByKey(question.competencyKey);
        const examplePrefixText = t('misc.examplePrefix');
        if (competencyBanner) competencyBanner.textContent = `${t('assessmentScreen.competencyBannerPrefix')}${competencyName}`;
        if (questionTextContainer) questionTextContainer.textContent = t(`questionTexts.${question.questionKey}`);
        if (exampleTextContainer) exampleTextContainer.textContent = `${examplePrefixText.startsWith("MISSING_") ? "Example: " : examplePrefixText}${t(`questionTexts.${question.exampleKey}`)}`;
        const progressPercentage = Math.round(((index + 1) / questionsData.length) * 100);
        if (progressBar) progressBar.style.width = `${progressPercentage}%`;
        if (progressLabel) progressLabel.textContent = `${progressPercentage}${t('assessmentScreen.progressLabelSuffix')}`;
        proficiencyButtonsNodeList = document.querySelectorAll("#assessment-screen .proficiency-button");
        if (proficiencyButtonsNodeList) proficiencyButtonsNodeList.forEach(button => button.classList.remove("selected"));
        if(noSelectionWarningEl) noSelectionWarningEl.style.display = 'none';
        attachEventListeners();
    }
    function attachEventListeners() { 
        proficiencyButtonsNodeList = document.querySelectorAll("#assessment-screen .proficiency-button"); 
        if (!proficiencyButtonsNodeList) return;
        proficiencyButtonsNodeList.forEach(button => {
            const newButton = button.cloneNode(true); 
            if (button.parentNode) button.parentNode.replaceChild(newButton, button);
        });
        proficiencyButtonsNodeList = document.querySelectorAll("#assessment-screen .proficiency-button"); 
        proficiencyButtonsNodeList.forEach(button => {
            button.onclick = () => {
                if(noSelectionWarningEl) noSelectionWarningEl.style.display = 'none';
                proficiencyButtonsNodeList.forEach(btn => btn.classList.remove("selected"));
                button.classList.add("selected");
                const selectedValue = parseInt(button.getAttribute("data-value"));
                const currentQuestion = questionsData[currentIndex];
                const competencyIndex = competenciesData.findIndex(c => c.key === currentQuestion.competencyKey);
                if (competencyIndex === -1) { console.error("Competency index not found for key:", currentQuestion.competencyKey); return; }
                if (answers[currentQuestion.type] && competencyIndex < answers[currentQuestion.type].length) {
                     answers[currentQuestion.type][competencyIndex] = selectedValue;
                } else { console.error(`Answer type ${currentQuestion.type} or index ${competencyIndex} out of bounds.`); }
                if (currentIndex < questionsData.length - 1) {
                    currentIndex++;
                    renderQuestion(currentIndex);
                } else { showResults(); }
            };
        });
    }
    function showResults() { 
        if(progressBar) progressBar.style.width = "100%";
        if(progressLabel) progressLabel.textContent = `100${t('assessmentScreen.progressLabelSuffix')}`;
        if(assessmentScreen) assessmentScreen.classList.add("hidden");
        if(startScreen) startScreen.classList.add("hidden");
        if(endScreen) endScreen.classList.remove("hidden");
        const today = new Date();
        const formattedCurrentDate = `${String(today.getDate()).padStart(2, '0')}/${String(today.getMonth() + 1).padStart(2, '0')}/${today.getFullYear()}`;
        setText('current-date-advanced', formattedCurrentDate);
        applyTranslations(); 
        generateResultsPageContent(); 
        const totalScore = (answers.Knowledge.reduce((a,b)=>a+b,0)||0) + (answers.Skills.reduce((a,b)=>a+b,0)||0) + (answers.Attitudes.reduce((a,b)=>a+b,0)||0);
        const maxScore = (competenciesData.length || 0) * 3 * 5;
        const percentageScore = maxScore > 0 ? Math.round((totalScore / maxScore) * 100) : 0;
        let userProficiencyLevelText = "", userKeyCharacteristics = [], userFeedback = "";
        for (let level of overallProficiencyLevelsData) {
            if (percentageScore >= level.range[0] && percentageScore <= level.range[1]) {
                const levelName = t(`proficiencyTexts.${level.nameKey}`);
                userProficiencyLevelText = `${levelName} (${level.range[0]}% - ${level.range[1]}%)`;
                userKeyCharacteristics = level.characteristicsKeys.map(key => t(`proficiencyTexts.${key}`));
                userFeedback = t(`proficiencyTexts.${level.feedbackKey}`);
                break;
            }
        }
        setText('total-score-advanced', `${percentageScore}% (${userProficiencyLevelText.split(' ')[0] || 'N/A'})`);
        displayKeyCharacteristics(userKeyCharacteristics);
        setText('personalised-feedback-advanced', userFeedback);
        const encodedData = encodeResponses();
        if (document.getElementById('qr-code')) generateQRCode(encodedData, 'qr-code');
        updateQRCodeURL(encodedData);
        setText('end-screen-title', t('endScreen.title'));
        setText('qr-code-title', t('endScreen.qrCodeSectionTitle'));
        setText('qr-code-instruction', t('endScreen.qrCodeInstruction'));
        setText('key-char-title', t('endScreen.keyCharacteristicsTitle'));
        setText('key-char-intro', t('endScreen.keyCharacteristicsIntro'));
        setText('radar-chart-title', t('endScreen.radarChartTitle'));
        setText('radar-chart-desc', t('endScreen.radarChartDescription'));
        setHTML('radar-chart-legend', constructRadarLegend());
        setHTML('strengths-title', t('endScreen.strengthsSectionTitle'));
        setText('strengths-intro', t('endScreen.strengthsSectionIntro'));
        setHTML('growth-areas-title', t('endScreen.growthAreasSectionTitle'));
        setText('growth-areas-intro', t('endScreen.growthAreasSectionIntro'));
        setHTML('smart-objectives-title', t('endScreen.smartObjectivesSectionTitle'));
        setText('smart-objectives-intro', t('endScreen.smartObjectivesSectionIntro'));
        setHTML('thank-you-message', t('endScreen.thankYouMessage'));
        setText('survey-prompt', t('endScreen.surveyPrompt'));
        setText('survey-button', t('endScreen.surveyButtonText'));
        if (restartButton) setText('restart-button', t('endScreen.restartButtonText'));
    }
    function encodeResponses() { 
        const numCompetencies = competenciesData.length || 0;
        return `${(answers.Knowledge||[]).slice(0,numCompetencies).join('')}-${(answers.Skills||[]).slice(0,numCompetencies).join('')}-${(answers.Attitudes||[]).slice(0,numCompetencies).join('')}`;
    }
    function decodeAndLoadResults() { 
        const data = new URLSearchParams(window.location.search).get('data');
        if (data) {
            const parts = data.split('-');
            if (parts.length === 3 && competenciesData && competenciesData.length > 0) {
                const [knowledgeStr, skillsStr, attitudesStr] = parts;
                const numCompetencies = competenciesData.length;
                answers.Knowledge = knowledgeStr.split('').map(Number).slice(0, numCompetencies);
                answers.Skills = skillsStr.split('').map(Number).slice(0, numCompetencies);
                answers.Attitudes = attitudesStr.split('').map(Number).slice(0, numCompetencies);
                while (answers.Knowledge.length < numCompetencies) answers.Knowledge.push(0);
                while (answers.Skills.length < numCompetencies) answers.Skills.push(0);
                while (answers.Attitudes.length < numCompetencies) answers.Attitudes.push(0);
                showResults();
            } else if (!competenciesData || competenciesData.length === 0) {
                 console.warn("URL Data: competenciesData not ready.");
            } else { console.warn("URL Data: malformed."); }
        }
    }
    function displayKeyCharacteristics(characteristics) { 
        const listEl = document.getElementById('key-characteristics-advanced');
        if(!listEl) return;
        listEl.innerHTML = '';
        characteristics.forEach(characteristic => {
            const li = document.createElement('li');
            li.textContent = characteristic;
            listEl.appendChild(li);
        });
    }
    function generateResultsPageContent() { 
        if (!competenciesData || competenciesData.length === 0) { return; }
        const competencyScores = competenciesData.map((comp, i) => ({
            key: comp.key, name: comp.name, 
            knowledgeScore: answers.Knowledge[i]||0, skillsScore: answers.Skills[i]||0, attitudesScore: answers.Attitudes[i]||0,
            total: (answers.Knowledge[i]||0) + (answers.Skills[i]||0) + (answers.Attitudes[i]||0)
        }));
        const sortedDesc = [...competencyScores].sort((a, b) => b.total - a.total);
        const sortedAsc = [...competencyScores].sort((a, b) => a.total - b.total);
        generateStrengths(sortedDesc.slice(0, 3)); 
        generateGrowthAreas(sortedAsc.slice(0, 3));
        generateRadarChart();
        generateSmartObjectives(sortedAsc.slice(0, 3));
    }
    function getStrongestDimension(comp) { return ["Knowledge","Skills","Attitudes"].sort((a,b)=>(comp[`${b.toLowerCase()}Score`])-(comp[`${a.toLowerCase()}Score`]))[0]; }
    function getWeakestDimension(comp) { return ["Knowledge","Skills","Attitudes"].sort((a,b)=>(comp[`${a.toLowerCase()}Score`])-(comp[`${b.toLowerCase()}Score`]))[0]; }
    function getFeedbackForCompetency(competencyKey, dimension) { return t(`feedbackStrengths.${competencyKey}.${dimension}`); }
    function getGrowthFeedbackForCompetency(competencyKey, dimension) { return t(`feedbackGrowth.${competencyKey}.${dimension}`); }
    function getSmartObjective(competencyKey, dimension) { return t(`smartObjectives.${competencyKey}.${dimension}`); }

    function generateStrengths(topCompetencies) { 
        if (!strengthsContainer) { console.error("strengthsContainer is null"); return; }
        strengthsContainer.innerHTML = '';
        topCompetencies.forEach(comp => {
            const strongestDimension = getStrongestDimension(comp);
            const competencyName = comp.name; 
            const strengthLabel = t('endScreen.strongestDimensionLabel');
            const translatedDimensionName = t(`endScreen.radarChartLegend${strongestDimension}`);
            const feedbackText = getFeedbackForCompetency(comp.key, strongestDimension);
            strengthsContainer.innerHTML += `<div class="strength-item card"><h4>${competencyName}</h4><p><strong>${strengthLabel}</strong> ${translatedDimensionName}</p><p>${feedbackText}</p></div>`;
        });
    }
    function generateGrowthAreas(bottomCompetencies) { 
        if (!growthAreasContainer) { console.error("growthAreasContainer is null"); return; }
        growthAreasContainer.innerHTML = '';
        bottomCompetencies.forEach(comp => {
            const weakestDimension = getWeakestDimension(comp);
            const competencyName = comp.name;
            const growthLabel = t('endScreen.growthAreaLabel');
            const translatedDimensionName = t(`endScreen.radarChartLegend${weakestDimension}`);
            const feedbackText = getGrowthFeedbackForCompetency(comp.key, weakestDimension);
            growthAreasContainer.innerHTML += `<div class="growth-item card"><h4>${competencyName}</h4><p><strong>${growthLabel}</strong> ${translatedDimensionName}</p><p>${feedbackText}</p></div>`;
        });
    }
    function generateSmartObjectives(bottomCompetencies) { 
        if (!smartObjectivesContainer) { console.error("smartObjectivesContainer is null"); return; }
        smartObjectivesContainer.innerHTML = '';
        bottomCompetencies.forEach(comp => {
            const weakestDimension = getWeakestDimension(comp);
            const competencyNameDisplay = comp.name; 
            const competencyForResourceLookup = comp.name; 
            const growthLabel = t('endScreen.growthAreaLabel');
            const smartObjectiveLabel = t('endScreen.smartObjectiveLabel');
            const translatedDimensionNameForSMART = t(`endScreen.radarChartLegend${weakestDimension}`);
            const smartObjectiveText = getSmartObjective(comp.key, weakestDimension);
            const userLevel = comp[`${weakestDimension.toLowerCase()}Score`];
            let levelsToShow = userLevel ? (userLevel === 1 ? [1,2,3] : (userLevel === 5 ? [3,4,5] : [userLevel-1, userLevel, userLevel+1].filter(l=>l>=1 && l<=5))) : [1,2,3];
            
            console.log(`SMART Objectives - Competency: "${competencyForResourceLookup}", Weakest Dim: "${weakestDimension.toLowerCase()}", User Level: ${userLevel}`);
            console.log("SMART Objectives - Window.customResources:", JSON.parse(JSON.stringify(window.customResources || [])));

            const filteredResources = (window.customResources || []).filter(r => {
                console.log(`Filtering resource: (Res Comp: "${r.competency}", Res Lvl: "${r.level}") vs (Lookup Comp: "${competencyForResourceLookup}", Lookup Lvl: "${weakestDimension.toLowerCase()}")`);
                return r.competency === competencyForResourceLookup && r.level === weakestDimension.toLowerCase();
            });
            console.log(`SMART Objectives - Filtered Resources (for ${competencyForResourceLookup} / ${weakestDimension.toLowerCase()}):`, JSON.parse(JSON.stringify(filteredResources)));

            const chosenResources = filteredResources.filter(r => levelsToShow.includes(r.rating)).slice(0, 3);
            console.log(`SMART Objectives - Chosen Resources (after rating filter for levels ${levelsToShow.join(',')} ):`, JSON.parse(JSON.stringify(chosenResources)));
            
            let resourcesHTML = '';
            if (chosenResources.length > 0) {
                resourcesHTML = `<h5>${t('endScreen.recommendedResourcesLabel')}</h5><ul style="list-style:none; padding:0; margin:10px 0;">
                        ${chosenResources.map(r => `<li><a href="${r.URL}" target="_blank" style="text-decoration:none; color:#0f777b;"><strong>${r.title}</strong>: ${r.description}</a></li>`).join('')}</ul>`;
            } else {
                console.log(`No chosen resources to display for ${competencyNameDisplay} - ${weakestDimension}`);
            }
            smartObjectivesContainer.innerHTML += `<div class="smart-item card"><h4>${competencyNameDisplay}</h4><p><strong>${growthLabel}</strong> ${translatedDimensionNameForSMART}</p><p><strong>${smartObjectiveLabel}</strong> ${smartObjectiveText}</p>${resourcesHTML}</div>`;
        });
    }
    function generateRadarChart() { /* ...Full function ... */ 
        if (radarChart) radarChart.destroy();
        if (!competenciesData || competenciesData.length === 0 || !document.getElementById('competencyRadarChart')) return;
        const radarLabels = competenciesData.map(c => c.name); 
        const data = {
            labels: radarLabels,
            datasets: [
                { label: t('endScreen.radarChartLegendKnowledge'), data: answers.Knowledge, fill: true, backgroundColor: 'rgba(255,99,132,0.2)', borderColor: 'rgb(255,99,132)', pointBackgroundColor: 'rgb(255,99,132)', borderWidth: 1 },
                { label: t('endScreen.radarChartLegendSkills'), data: answers.Skills, fill: true, backgroundColor: 'rgba(54,162,235,0.2)', borderColor: 'rgb(54,162,235)', pointBackgroundColor: 'rgb(54,162,235)', borderWidth: 1 },
                { label: t('endScreen.radarChartLegendAttitudes'), data: answers.Attitudes, fill: true, backgroundColor: 'rgba(75,192,192,0.2)', borderColor: 'rgb(75,192,192)', pointBackgroundColor: 'rgb(75,192,192)', borderWidth: 1 }
            ]
        };
        const radarCtx = document.getElementById('competencyRadarChart').getContext('2d');
        radarChart = new Chart(radarCtx, {
            type: 'radar', data: data,
            options: { responsive: true, maintainAspectRatio: true, elements: { line: { tension: 0.1 } }, scales: { r: { angleLines: { display: false }, suggestedMin: 0, suggestedMax: 5, ticks: { stepSize: 1, beginAtZero: true, backdropColor: 'transparent' } } } }
        });
    }
    function updateQRCodeURL(data) { /* ...Full function ... */ 
        const resultsURL = `${window.location.origin}${window.location.pathname}?data=${data}`;
        setText('qr-url', resultsURL);
    }
    function generateQRCode(data, canvasId) { /* ...Full function ... */ 
        const qrCodeCanvas = document.getElementById(canvasId);
        if (!qrCodeCanvas) { console.error(`Canvas ${canvasId} not found.`); return; }
        const resultsURL = `${window.location.origin}${window.location.pathname}?data=${data}`;
        QRCode.toCanvas(qrCodeCanvas, resultsURL, { width: 200, margin: 2 }, err => {
            if (err) console.error(`Error QR code for ${canvasId}:`, err);
        });
    }
    function toggleDropdown(event) { /* ...Full function ... */ 
        const button = event.target;
        const dropdownContent = document.getElementById('proficiency-dropdown-content');
        if (dropdownContent) {
            const isHidden = dropdownContent.style.display === "none" || dropdownContent.style.display === "";
            dropdownContent.style.display = isHidden ? "block" : "none";
            button.textContent = t(isHidden ? 'assessmentScreen.hideProficiencyLevelsButton' : 'assessmentScreen.showProficiencyLevelsButton');
        }
    }
    
    function addEventListenersToDOM() { 
        if (restartButton) {
            restartButton.addEventListener("click", () => {
                currentIndex = 0;
                if (competenciesData && competenciesData.length > 0) {
                    const numCompetencies = competenciesData.length;
                    answers.Knowledge = Array(numCompetencies).fill(0);
                    answers.Skills = Array(numCompetencies).fill(0);
                    answers.Attitudes = Array(numCompetencies).fill(0);
                }
                if(endScreen) endScreen.classList.add("hidden");
                if(assessmentScreen) assessmentScreen.classList.add("hidden");
                if(startScreen) startScreen.classList.remove("hidden");
                if (radarChart) { radarChart.destroy(); radarChart = null; }
                const qrCodeCanvas = document.getElementById('qr-code');
                if (qrCodeCanvas && qrCodeCanvas.getContext) qrCodeCanvas.getContext('2d').clearRect(0, 0, qrCodeCanvas.width, qrCodeCanvas.height);
                setText('qr-url', '');
                if(strengthsContainer) strengthsContainer.innerHTML = '';
                if(growthAreasContainer) growthAreasContainer.innerHTML = '';
                if(smartObjectivesContainer) smartObjectivesContainer.innerHTML = '';
                applyTranslations(); 
            });
        } else { console.error("Restart button not found for listener in addEventListenersToDOM."); }

        if (startButton) {
            startButton.addEventListener("click", () => {
                console.log("Start button CLICKED!"); 
                if(startScreen) startScreen.classList.add("hidden");
                if(assessmentScreen) assessmentScreen.classList.remove("hidden");
                if (competenciesData && competenciesData.length > 0) {
                    const numCompetencies = competenciesData.length;
                    answers.Knowledge = Array(numCompetencies).fill(0);
                    answers.Skills = Array(numCompetencies).fill(0);
                    answers.Attitudes = Array(numCompetencies).fill(0);
                    currentIndex = 0; 
                    renderQuestion(currentIndex);
                } else {
                    console.error("Cannot start assessment, competencies data not loaded.");
                }
            });
        } else { console.error("Start button not found for listener in addEventListenersToDOM."); }

        if (langSelectorElement) {
            langSelectorElement.addEventListener('change', async (event) => {
                const newLang = event.target.value; 
                console.log(`Language dropdown changed to: ${newLang}. Current BU: ${currentBU}`);
                currentLanguage = newLang; 
                
                let variantToLoad = currentLanguage;
                if (currentBU) {
                    variantToLoad = `${currentLanguage}-${currentBU}`;
                }
                await loadVariantFiles(variantToLoad); 

                if (startScreen && !startScreen.classList.contains('hidden') && 
                    assessmentScreen && assessmentScreen.classList.contains('hidden') && 
                    endScreen && endScreen.classList.contains('hidden')) {
                    // On start screen fine
                } else { 
                    if (restartButton) restartButton.click(); 
                }
            });
        }  else { console.warn("Language selector element not found for event listener attachment in addEventListenersToDOM."); }
    }
    
    async function initializeApp() {
        console.log("initializeApp CALLED"); 
        assignDOMelements(); 
        addEventListenersToDOM(); 

        const urlParams = new URLSearchParams(window.location.search);
        currentBU = urlParams.get('bu'); 
        if(currentBU) currentBU = currentBU.toLowerCase();

        let storedLang = localStorage.getItem('selectedUserLanguage');
        let browserLang = navigator.language || navigator.userLanguage || 'en';
        let initialLang = 'en'; 

        if (storedLang) {
            initialLang = storedLang;
        } else if (browserLang) {
            const primaryBrowserLang = browserLang.toLowerCase().split('-')[0];
            let langOptionExists = false;
            if (langSelectorElement && langSelectorElement.options) {
                 langOptionExists = Array.from(langSelectorElement.options).some(opt => opt.value === primaryBrowserLang);
            }
            if (langOptionExists) {
                initialLang = primaryBrowserLang;
            }
            if (browserLang.toLowerCase().startsWith('zh-hans') || browserLang.toLowerCase() === 'zh-cn' || browserLang.toLowerCase() === 'zh-sg') initialLang = 'zh-hans';
            else if (browserLang.toLowerCase().startsWith('zh-hant') || browserLang.toLowerCase() === 'zh-tw' || browserLang.toLowerCase() === 'zh-hk') initialLang = 'zh-hant';
        }
        
        currentLanguage = initialLang; 

        let variantToLoad = currentLanguage;
        if (currentBU) {
            variantToLoad = `${currentLanguage}-${currentBU}`;
        } else {
            // console.log(`No BU parameter. Initial language: '${currentLanguage}' (effective variant: ${variantToLoad})`);
        }
        
        await loadVariantFiles(variantToLoad); 
        
        decodeAndLoadResults(); 
        console.log("initializeApp COMPLETED");
    }

    document.addEventListener('DOMContentLoaded', initializeApp);
    // --- END OF SCRIPT ---
</script>
</body>
</html>
